<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cardano Blueprint</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cardano Blueprint</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cardano-scaling/cardano-blueprint/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the Cardano Blueprint, a project that creates the knowledge foundation about how the Cardano protocol works. Blueprints are implementation independent assets like explanations, diagrams, interface specifications, test data, etc. that will enable a wide developer audience to understand the protocol and build Cardano components.</p>
<h2 id="goal"><a class="header" href="#goal">Goal</a></h2>
<p>Our goal is to make the Cardano protocol documentation and specifications <strong>implementation-independent</strong> and <strong>accessible</strong> to a wider audience of builders in the Cardano community.</p>
<p>Ultimately, <strong>sharing knowledge</strong> will support node diversity and is the only way to maintain security of the Cardano network as its software stack becomes more and more decentralized.</p>
<h2 id="why-its-needed"><a class="header" href="#why-its-needed">Why it’s needed</a></h2>
<p>The <a href="https://github.com/IntersectMBO/cardano-node"><code>cardano-node</code></a> was developed over the last 8+ years at Input Output Group (IO) to become the reference implementation of the Ouroboros network and consensus protocols, the extended UTxO (eUTxO) ledger model and Plutus smart contract language.</p>
<p>Most of these things are rigorously researched, specified and documented, but the documentation is spread across multiple repositories, in different formats, some in very dense formal methods syntax, and some mixed with details of the Haskell implementation.</p>
<p>This project aims to produce a set of blueprints for Cardano in a grassroots initiative to make existing documentation:</p>
<ul>
<li><strong>understandable</strong> by a wide audience</li>
<li><strong>owned</strong> by the Cardano community</li>
<li><strong>useful</strong> to multiple implementations</li>
</ul>
<p>Where the audience includes primarily developers of cardano nodes, current and future implementations, but also builders of applications and integrations, or anyone wanting to understand Cardano at a deeper technical level.</p>
<h2 id="what-is-a-blueprint"><a class="header" href="#what-is-a-blueprint">What is a blueprint</a></h2>
<p>We understand that not one format, style or type of specification will work for everyone. But no matter <em>how exactly</em> an artifact for a given protocol aspect turns out, blueprints should capture the following values:</p>
<ul>
<li><strong>Accessible</strong> - understandable language, human readable formats, maintainable diagrams</li>
<li><strong>Open</strong> - easy to contribute to by people from different backgrounds, common tools</li>
<li><strong>Minimal</strong> - describes required functionality and behaviour, not implementation details</li>
<li><strong>Lightweight</strong> - easy to use, reference, and test against</li>
<li><strong>Evidence-based</strong> - contains test scenarios, test data, simulations, models or similar to rely on</li>
</ul>
<p>Given these values, we believe an explanation of key concepts like network protocols, consensus algorithms, block and transaction formats or how transactions in Cardano are validated using <a href="https://spec.commonmark.org/0.31.2/#what-is-markdown-">Markdown</a>, <a href="https://rust-lang.github.io/mdBook/">rendered into a website</a> which can be searched and linked to, ideally with lots of updatable diagrams, e.g. <a href="https://github.com/mermaid-js/mermaid?tab=readme-ov-file#about">using mermaid</a>, is already a great starting point!</p>
<p>If those documents are then also providing an introduction and home to various test data sets, <a href="https://json-schema.org/">json schemas</a>, <a href="https://www.rfc-editor.org/rfc/rfc8610">cddl definitions</a>, or test suites in the spirit of <a href="https://github.com/ethereum/tests">ethereum/tests</a>, then this will be a great asset to the Cardano community.</p>
<p>Finally, hosting this <a href="https://github.com/cardano-scaling/cardano-blueprint">on Github</a> means that it can become a community effort with familiar processes of contribution to an Open Source software project like pull requests, issues, discussions etc. Note that this would only present a thin layer of our ways of working and should we want to move or work on blueprints differently, for example in a more decentralized <a href="https://radicle.xyz/">radicle</a> way. Even changing the ways of making knowledge available - e.g. producing a book or learn Cardano concepts with an LLM agent - are possible, as long as we <strong>capture the essence of what makes Cardano</strong>.</p>
<h2 id="what-about-cardano-improvement-proposals-cips"><a class="header" href="#what-about-cardano-improvement-proposals-cips">What about Cardano Improvement Proposals (CIPs)?</a></h2>
<p>The <a href="https://cips.cardano.org/">Cardano Improvement Proposal</a> (CIP) process is the standard way that new features are proposed, discussed and ratified for the Cardano network, and it does this job well. In fact, CIPs to capture a lot of our values already and tick many boxes.</p>
<p>We did consider whether these blueprints could be CIPs themselves, but were concerned that the sheer volume of information could overwhelm the technical and personal capacity of the CIP process, particularly in the initial bootstrap phase. Also, the single-layer, procedural nature of the CIP documents could be restrictive for the highly-connected and aggregated form of documentation we envision.</p>
<p>That being said, this project will of course tightly integrate with the CIP process:</p>
<ul>
<li>
<p>CIPs will of course remain the place for new features and discussion</p>
</li>
<li>
<p>The Cardano blueprint itself may be presented and ratified as a CIP, given the Cardano community final say over its status</p>
</li>
<li>
<p>CIPs could include changes to the <code>cardano-blueprint</code> in their “Path to Active”</p>
</li>
</ul>
<pre class="mermaid">graph TB
    COM((Community))
    BP(Blueprints)
    N1[Node Implementation 1]
    N2[Node Implementation 2]
    C[Component 3]

    COM &lt;-..-&gt; BP
    BP --&gt; N1
    BP --&gt; N2
    BP --&gt; C
</pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="network"><a class="header" href="#network">Network</a></h1>
<p>The network layer is responsible of implementing the Node-To-Node interface of a
node, for transmitting data between nodes.</p>
<p>The network protocols consist of a <a href="network/multiplexing.html">multiplexing layer</a> which
carries one or more <a href="network/mini-protocols.html">mini-protocols</a>, according to the type
of connection - for example:</p>
<pre class="mermaid">graph TB
    HS(Handshake)
    CS(ChainSync)
    BF(BlockFetch)
    Mux[Multiplexing]
    Con([Raw Connection])

    HS &lt;--&gt; Mux
    CS &lt;--&gt; Mux
    BF &lt;--&gt; Mux
    Mux &lt;--&gt; Con
</pre>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>Nodes usually have a separate interface to provide information to local
clients. Such interface is up to the node implementation to decide which
protocols to use. It often times is convenient to group this interface under
the networking layer of a node but it is not mandatory. For more information
see <a href="network/../client">Client interfaces</a>.</p>
</div>
<h3 id="node-to-node-mini-protocols"><a class="header" href="#node-to-node-mini-protocols">Node-to-node mini-protocols</a></h3>
<blockquote>
<p>Current node-to-node protocol version: v14</p>
</blockquote>
<p>The set of Node-To-Node mini-protocols needed for participating in the Cardano
network (combined by the multiplexing wrapper) is:</p>
<ul>
<li><a href="network/node-to-node/handshake">Handshake</a> - for connection and version negotiation</li>
<li><a href="network/node-to-node/chainsync">Chain Sync</a> - for synchronization of changes to the
Cardano chain</li>
<li><a href="network/node-to-node/blockfetch">Block Fetch</a> - for transferring blocks between nodes</li>
<li><a href="network/node-to-node/txsubmission2">TxSubmission2</a> - for propagating transactions between nodes</li>
<li><a href="network/node-to-node/keep-alive">Keep Alive</a> - for maintaining and measuring timing of the connection</li>
<li><a href="network/">Peer Sharing</a> - for exchanging peer information to create the peer-to-peer
(P2P) network</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="multiplexing"><a class="header" href="#multiplexing">Multiplexing</a></h1>
<p>The multiplexing layer is a simple binary protocol which runs on top of the
raw connection (TCP or local socket) and provides:</p>
<ul>
<li>Multiplexing of multiple
<a href="network/mini-protocols.html">mini-protocols</a><sup class="footnote-reference" id="fr-agnostic-1"><a href="#footnote-agnostic">1</a></sup> over a single connection</li>
<li>Framing and segmentation of messages within a stream connection</li>
<li>Timing information for latency measurement</li>
</ul>
<p>This shows the arrangement for a typical node-to-node (N2N) connection:</p>
<pre class="mermaid">graph LR
  subgraph n1 [Node 1]
    direction LR
    HS1(Handshake)
    CS1(ChainSync)
    BF1(BlockFetch)
    Mux1[Multiplexer]

    HS1 &lt;--&gt; Mux1
    CS1 &lt;--&gt; Mux1
    BF1 &lt;--&gt; Mux1
  end

  subgraph n2 [Node 2]
    direction LR
    Mux2[Multiplexer]
    HS2(Handshake)
    CS2(ChainSync)
    BF2(BlockFetch)

    Mux2 &lt;--&gt; HS2
    Mux2 &lt;--&gt; CS2
    Mux2 &lt;--&gt; BF2
  end

  Mux1 &lt;==&gt; Mux2

</pre>
<h2 id="packet-format"><a class="header" href="#packet-format">Packet format</a></h2>
<p>A multiplexer packet consists of an 8-byte header followed by up to 65535 bytes
of payload.  Multiple payload segments can be combined to form a full message.</p>
<pre class="mermaid">packet-beta
    0-31: &quot;Transmission time&quot;
    32: &quot;M&quot;
    33-47: &quot;Mini-protocol ID&quot;
    48-63: &quot;Payload length N&quot;
    64-95: &quot;Payload (variable length N)&quot;
</pre>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Field</th><th style="text-align: left">Size</th><th style="text-align: left">Meaning</th></tr></thead><tbody>
<tr><td style="text-align: left">Transmission time</td><td style="text-align: left">32</td><td style="text-align: left">Monotonic time stamp (µsec, lowest 32 bits)</td></tr>
<tr><td style="text-align: left">M</td><td style="text-align: left">1</td><td style="text-align: left">Mode: 0 from initiator, 1 = from responder</td></tr>
<tr><td style="text-align: left">Mini-protocol ID</td><td style="text-align: left">15</td><td style="text-align: left">Mini-protocol ID (see below)</td></tr>
<tr><td style="text-align: left">Payload length</td><td style="text-align: left">16</td><td style="text-align: left">Segment payload length (N) in bytes</td></tr>
<tr><td style="text-align: left">Payload</td><td style="text-align: left">N</td><td style="text-align: left">Raw payload data</td></tr>
</tbody></table>
</div>
<p>All fields are network/big-endian byte order.</p>
<p>The mini-protocol ID is fixed for each one of the NTN protocols. The section that describes each mini-protocol starts specifying the mini-protocol number.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>How are multi-segment messages delimited? - there is no ‘start of message’
flag or ‘N of M’ counter</p>
</div>
<hr>
<ol class="footnote-definition"><li id="footnote-agnostic">
<p>Although the multiplexer is only used with mini-protocols in
Cardano, it’s actually completely agnostic as to data format. <a href="#fr-agnostic-1">↩</a></p>
</li>
</ol><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="mini-protocols"><a class="header" href="#mini-protocols">Mini-protocols</a></h1>
<p>The Cardano mini-protocols are a set of protocols that each provides a
particular aspect of the communication between nodes (node-to-node or NTN).
They run over a <a href="network/multiplexing.html">multiplexer</a> which allows multiple
mini-protocols to share the same underlying TCP or local socket connection.</p>
<p>Each mini-protocol is represented by a state machine and a set of messages
that can be passed between the parties.</p>
<h2 id="state-machines"><a class="header" href="#state-machines">State machines</a></h2>
<p>The progress of the communication is defined by a state machine, which
is replicated at each end.  The transitions of the state machine
are messages being sent/received.  As well as defining which messages
are valid to send and receive in each state, the state machine also
defines which side has <em>agency</em> - that is, should be the one to send
the next message.</p>
<p>The <em>initiator</em> of a connection is the one that requested the
connection be opened - the client in a simple client/server model.</p>
<p>The <em>responder</em> or is the one that responds to the connection request - the
server, in other words.</p>
<p>In every case it is the initiator (client) which has agency first.  In many
cases the initiator and responder take turns to have agency (send messages),
but in some cases where one party must wait for a response, the other will
keep agency and send a follow-up message later.</p>
<p>We can draw this state machine in the standard way using circles and arrows, but
with the addition of an indicator of which side has agency. This one is for the
minimal example mini-protocol, <a href="network/">Ping Pong</a>:</p>
<pre class="mermaid">stateDiagram

    [*] --&gt; StIdle
    StIdle --&gt; StBusy: MsgPing
    StBusy --&gt; StIdle: MsgPong
    StIdle --&gt; [*]: MsgDone

    direction LR

    classDef initiator color:#080
    classDef responder color:#008, text-decoration: underline
    class StIdle initiator
    class StBusy responder
</pre>
<p>It has been the convention to mark states where the initiator has agency
in green and the responder in blue, as here, but we also underline it for
responder agency in case colours aren’t clear.</p>
<p>As a double check, we can show the agency for each state as a table as well:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">State</th><th style="text-align: left">Agency</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StBusy</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
</tbody></table>
</div>
<p>By convention state names have an <code>St</code> prefix, while messages
have <code>Msg</code>, to avoid confusion.</p>
<p>We can also show the transitions of the state machine as a table, and
indicate what data is passed with each message, although Ping Pong
doesn’t carry any:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">From state</th><th style="text-align: left">Message</th><th>Parameters</th><th style="text-align: left">To state</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgPing</td><td>-</td><td style="text-align: left">StBusy</td></tr>
<tr><td style="text-align: left">StBusy</td><td style="text-align: left">MsgPong</td><td>-</td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgDone</td><td>-</td><td style="text-align: left">End</td></tr>
</tbody></table>
</div>
<h2 id="message-formats"><a class="header" href="#message-formats">Message formats</a></h2>
<p>The messages of the mini-protocols are encoded in <a href="https://cbor.io">CBOR</a>, a
compact binary encoding of JSON, while the schema of valid messages is expressed
in CDDL (<a href="https://datatracker.ietf.org/doc/rfc8610/">Concise Data Definition
Language</a>). See <a href="network/../codecs">Codec
basics</a> for more details.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="handshake-mini-protocol"><a class="header" href="#handshake-mini-protocol">Handshake mini-protocol</a></h1>
<p><strong>Mini-protocol number: 0</strong></p>
<p>The Handshake mini-protocol is used to establish a connection and
negotiate protocol versions and parameters between the initiator
(client) and responder (server).  There are two versions, one for
node-to-node (NTN) and one for node-to-client (NTC), which differ only
in their protocol parameters.</p>
<h2 id="state-machine"><a class="header" href="#state-machine">State machine</a></h2>
<pre class="mermaid">stateDiagram

    [*] --&gt; StPropose
    StPropose --&gt; StConfirm: MsgProposeVersions
    StConfirm --&gt; [*]: MsgAcceptVersion
    StConfirm --&gt; [*]: MsgReplyVersion
    StConfirm --&gt; [*]: MsgRefuse

    direction LR

    classDef initiator color:#080
    classDef responder color:#008, text-decoration: underline
    class StPropose initiator
    class StConfirm responder
</pre>
<h3 id="state-agencies"><a class="header" href="#state-agencies">State agencies</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">State</th><th style="text-align: left">Agency</th></tr></thead><tbody>
<tr><td style="text-align: left">StPropose</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StConfirm</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
</tbody></table>
</div>
<h3 id="state-transitions"><a class="header" href="#state-transitions">State transitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">From state</th><th style="text-align: left">Message</th><th>Parameters</th><th style="text-align: left">To state</th></tr></thead><tbody>
<tr><td style="text-align: left">StPropose</td><td style="text-align: left">MsgProposeVersions</td><td><code>versionTable</code></td><td style="text-align: left">StConfirm</td></tr>
<tr><td style="text-align: left">StConfirm</td><td style="text-align: left">MsgReplyVersion</td><td><code>versionTable</code></td><td style="text-align: left">End</td></tr>
<tr><td style="text-align: left">StConfirm</td><td style="text-align: left">MsgAcceptVersion</td><td><code>(versionNumber, versionData)</code></td><td style="text-align: left">End</td></tr>
<tr><td style="text-align: left">StConfirm</td><td style="text-align: left">MsgRefuse</td><td><code>reason</code></td><td style="text-align: left">End</td></tr>
</tbody></table>
</div>
<h2 id="tcp-simultaneous-open"><a class="header" href="#tcp-simultaneous-open">TCP simultaneous open</a></h2>
<p>In the rare case when both sides try to connect to each other at the same time,
it’s possible to get a “TCP simultaneous open” where you end up with a single
socket, not two.  In this case, both sides will think they are the initiator
so will send a <code>MsgProposeVersions</code>, and this protocol handles this by treating
the received one in <code>StConfirm</code> state as a <code>MsgReplyVersion</code>, which has the same
CBOR encoding.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>Why does the message need to change name?  The state machine would be
valid with an <code>StConfirm -- MsgProposeVersions --&gt; End</code> arc.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Also, is the negotiation always deemed successful in this case?  What if
one side can’t accept the other’s version? (there is talk of resetting
the connection)</p>
</div>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p><code>MsgReplyVersion</code> is no longer mentioned in the CDDL - is this therefore
out of date?</p>
</div>
<h2 id="messages"><a class="header" href="#messages">Messages</a></h2>
<p>The <code>MsgProposeVersions</code> message is sent by the initiator to propose a
set of possible versions and protocol parameters.  <code>versionTable</code> is a map
of version numbers to associated parameters - bear in mind that different
versions may have different sets of parameters.  The version number keys
must be unique and in ascending order.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This seems an arbitrary constraint which could easily be avoided by
implementations, although deterministic CBOR encoding would enforce it.</p>
</div>
<p>The <code>MsgAcceptVersion</code> message is returned by the responder to confirm
a mutually acceptable version and set of parameters.</p>
<p>The <code>MsgRefuse</code> message is returned by the responder to indicate there is
no acceptable version match, or another reason.  If it is a version mismatch
it returns a set of version numbers that it could have accepted.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>The content of <code>MsgRefuse</code> is inconsistent between the paper and CDDL -
check the above.</p>
</div>
<h3 id="message-size-limits"><a class="header" href="#message-size-limits">Message size limits</a></h3>
<p>Because the Handshake protocol operates before the multiplexer is fully
set up, the messages must not be split into segments, and this imposes
a size limit of 5760 bytes.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>This seems like a protocol level mix, and since the negotiated parameters
don’t seem to affect the mux config (and could be changed dynamically even
if they did), it’s not clear why this constraint is needed.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Why 5076 when the mux protocol can handle 65535? Implementation detail?</p>
</div>
<h3 id="timeouts"><a class="header" href="#timeouts">Timeouts</a></h3>
<p>The maximum time to wait for a message in <code>StPropose</code> (for the responder)
or <code>StConfirm</code> (for the initiator) is 10 seconds.  After this the connection
should be torn down.</p>
<h2 id="cddl"><a class="header" href="#cddl">CDDL</a></h2>
<p>Here’s the CDDL for the latest node-to-node handshake protocol:</p>
<pre><code class="language-cddl">;; messages.cddl
;
; NodeToNode Handshake (&gt;=v13)
;
handshakeMessage
    = msgProposeVersions
    / msgAcceptVersion
    / msgRefuse
    / msgQueryReply

msgProposeVersions = [0, versionTable]
msgAcceptVersion   = [1, versionNumber, nodeToNodeVersionData]
msgRefuse          = [2, refuseReason]
msgQueryReply      = [3, versionTable]

versionTable = { * versionNumber =&gt; nodeToNodeVersionData }

versionNumber = 13 / 14

nodeToNodeVersionData = [ networkMagic, initiatorOnlyDiffusionMode, peerSharing, query ]

; range between 0 and 0xffffffff
networkMagic = 0..4294967295
initiatorOnlyDiffusionMode = bool
; range between 0 and 1
peerSharing = 0..1
query = bool

refuseReason
    = refuseReasonVersionMismatch
    / refuseReasonHandshakeDecodeError
    / refuseReasonRefused

refuseReasonVersionMismatch      = [0, [ *versionNumber ] ]
refuseReasonHandshakeDecodeError = [1, versionNumber, tstr]
refuseReasonRefused              = [2, versionNumber, tstr]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="chainsync"><a class="header" href="#chainsync">ChainSync</a></h1>
<p><strong>Mini-protocol number: 2</strong></p>
<p><code>ChainSync</code> is the miniprotocol used to transmit chains of headers. It is a
pull-based miniprotocol: data is transmitted only upon explicit request from the
client.</p>
<p>The purpose of <code>ChainSync</code> is to enable the client to acquire and validate the
headers of the server’s selected chain, and if it is better than the client’s
current selection, direct <code>BlockFetch</code> to download the corresponding blocks.</p>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>There usually is one <code>ChainSync</code> client per-peer connected to the node, such
that the <em>chain state</em> of each peer is tracked independently.</p>
</div>
<p>The connection is abruptly terminated if the peer misbehaves. In particular,
actions considered as misbehaviour are (not exclusively):</p>
<ul>
<li>The peer violates the state machine of the protocol,</li>
<li>The server sends an invalid header,</li>
<li>The server announces a fork that is more than <code>k</code> blocks deep from the
client’s current selection.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Make this list exhaustive</p>
</div>
<h2 id="state-machine-1"><a class="header" href="#state-machine-1">State machine</a></h2>
<p>The state machine for ChainSync is as follows:</p>
<pre class="mermaid">stateDiagram
    direction LR
    [*] --&gt; StIdle
    StIdle --&gt; [*]: MsgDone
    StIdle --&gt; StIntersect: MsgFindIntersect
    StIdle --&gt; StCanAwait: MsgRequestNext
    StIntersect --&gt; StIdle: MsgIntersectNotFound
    StIntersect --&gt; StIdle: MsgIntersectFound
    StCanAwait --&gt; StIdle: MsgRollForward
    StCanAwait --&gt; StIdle: MsgRollBackward
    StCanAwait --&gt; StMustReply: MsgAwaitReply
    StMustReply --&gt; StIdle: MsgRollForward
    StMustReply --&gt; StIdle: MsgRollBackward

    classDef initiator color:#080
    classDef responder color:#008, text-decoration: underline
    class StIdle initiator
    class StCanAwait responder
    class StIntersect responder
    class StMustReply responder
</pre>
<h3 id="state-agencies-1"><a class="header" href="#state-agencies-1">State agencies</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">State</th><th style="text-align: left">Agency</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StIntersect</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
<tr><td style="text-align: left">StCanAwait</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
<tr><td style="text-align: left">StMustReply</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
</tbody></table>
</div>
<h3 id="state-transitions-1"><a class="header" href="#state-transitions-1">State transitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">From state</th><th style="text-align: left">Message</th><th>Parameters</th><th style="text-align: left">To state</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgRequestNext</td><td></td><td style="text-align: left">StCanAwait</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgFindIntersect</td><td><code>[point]</code></td><td style="text-align: left">StIntersect</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgDone</td><td></td><td style="text-align: left">End</td></tr>
<tr><td style="text-align: left">StCanAwait</td><td style="text-align: left">MsgAwaitReply</td><td></td><td style="text-align: left">StMustReply</td></tr>
<tr><td style="text-align: left">StCanAwait</td><td style="text-align: left">MsgRollForward</td><td><code>header</code>, <code>tip</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StCanAwait</td><td style="text-align: left">MsgRollBackward</td><td><code>point_old</code>, <code>tip</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StMustReply</td><td style="text-align: left">MsgRollForward</td><td><code>header</code>, <code>tip</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StMustReply</td><td style="text-align: left">MsgRollBackward</td><td><code>point_old</code>, <code>tip</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIntersect</td><td style="text-align: left">MsgIntersectFound</td><td><code>point_intersect</code>, <code>tip</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIntersect</td><td style="text-align: left">MsgIntersectNotFound</td><td><code>tip</code></td><td style="text-align: left">StIdle</td></tr>
</tbody></table>
</div>
<h2 id="chainsync-pipelining-or-pipelined-diffusion"><a class="header" href="#chainsync-pipelining-or-pipelined-diffusion">ChainSync pipelining or pipelined diffusion</a></h2>
<p>Not to be confused with <em>protocol pipelining</em>. The original design of ChainSync
was extended with pipelining capabilities: a server can transmit a <em>tentative</em>
header on top of the selected chain, and the invalidity of such header (or the
associated body) will not cause the connection to terminate. If the client wants
(by considering such header as the best known chain) it can request the body of
the block via <code>BlockFetch</code> as usually done for any block.</p>
<p>This optimization is used to shorten the time it takes to diffuse chains on the
network, as otherwise nodes would only announce blocks <em>after</em> they validated
it, causing each hop through the network to be bottle-necked by validation
times.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: expand pipelining explanation, possibly with diagrams</p>
</div>
<p>There are some important considerations to take into account regarding pipelined
diffusion:</p>
<ul>
<li>Nodes can pipeline only <strong>one</strong> header which must be on top of its current
selection,</li>
<li>If the server then validates the pipelined block and finds out it was invalid,
it is encouraged to announce it promptly to its clients.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Are these hard requirements?</p>
</div>
<p>More information can be found <a href="https://iohk.io/en/blog/posts/2022/02/01/introducing-pipelining-cardanos-consensus-layer-scaling-solution/">here</a>.</p>
<h2 id="access-pattern-of-chainsync"><a class="header" href="#access-pattern-of-chainsync">Access pattern of ChainSync</a></h2>
<p><code>ChainSync</code> involves potentially serving the whole chain, both the immutable
part and the volatile part (the current node’s selection). As the current
selection is bound to be rolled back, the <code>ChainSync</code> protocol has capabilities
for announcing such rollbacks to clients and following rollbacks of servers.</p>
<ul>
<li>For the immutable part of the chain: <code>ChainSync</code> accesses blocks in a
sequential manner, a simple iterator over such chain would suffice.</li>
<li>For the volatile part of the chain: <code>ChainSync</code> accesses the current
selection in a sequential manner but such selection is bound to
change if a new chain is selected. The abstraction used to implement
the access to the selection must be able to follow such rollbacks.</li>
<li>Blocks that become immutable usually are written to the disk as they are not
used for following the current chain once the node is caught up, following the
description in <a href="network/node-to-node/chainsync/../../../consensus/chainsel.html#the-k-security-parameter">the <code>k</code> security parameter</a> section. The
implementation of <code>ChainSync</code> should be able to identify this situation, as
blocks might be gone from the volatile part of the chain as the selection
advances. This does not need to be made explicit for clients but it has to be
taken into account on the implementation of the server.</li>
</ul>
<h2 id="codecs"><a class="header" href="#codecs">Codecs</a></h2>
<p>The messages depicted in the state machine follow this CDDL specification:</p>
<pre><code class="language-cddl">;; messages.cddl
chainSyncMessage
    = msgRequestNext
    / msgAwaitReply
    / msgRollForward
    / msgRollBackward
    / msgFindIntersect
    / msgIntersectFound
    / msgIntersectNotFound
    / chainSyncMsgDone

msgRequestNext         = [0]
msgAwaitReply          = [1]
msgRollForward         = [2, header.header, tip]
msgRollBackward        = [3, point, tip]
msgFindIntersect       = [4, [* point]]
msgIntersectFound      = [5, point, tip]
msgIntersectNotFound   = [6, tip]
chainSyncMsgDone       = [7]

tip = [ point, base.blockNo ]

point = []                         ; the genesis point
      / [ base.slotNo, base.hash ]

;# import base as base
;# import header as header
</code></pre>
<p>The header is a tag-encoded value that contains CBOR-in-CBOR headers
for the particular era:</p>
<pre><code class="language-cddl">;; header.cddl
header
 = base.ns7&lt;byronHeader,
            serialisedShelleyHeader&lt;shelley.header&gt;,
            serialisedShelleyHeader&lt;allegra.header&gt;,
            serialisedShelleyHeader&lt;mary.header&gt;,
            serialisedShelleyHeader&lt;alonzo.header&gt;,
            serialisedShelleyHeader&lt;babbage.header&gt;,
            serialisedShelleyHeader&lt;conway.header&gt;&gt;

byronHeader = [byronRegularIdx, #6.24(bytes .cbor byron.blockhead)]
            / [byronBoundaryIdx, #6.24(bytes .cbor byron.ebbhead)]

byronBoundaryIdx = [0, base.word32]
byronRegularIdx = [1, base.word32]

serialisedShelleyHeader&lt;era&gt; = #6.24(bytes .cbor era)

;# include byron as byron
;# include shelley as shelley
;# include allegra as allegra
;# include mary as mary
;# include alonzo as alonzo
;# include babbage as babbage
;# include conway as conway
;# import base as base
</code></pre>
<!-- iohk.io links return 403 "if you are not a human" -->
<!-- markdown-link-check-disable-next-line -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="blockfetch"><a class="header" href="#blockfetch">BlockFetch</a></h1>
<p><strong>Mini-protocol number: 3</strong></p>
<p><code>BlockFetch</code> is the mini-protocol in charge of diffusing block
bodies. It is a pull-based mini-protocol: data is transmitted only upon
explicit request from the client.</p>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>There is usually one <code>BlockFetch</code> client per peer which is the one
in charge of exchanging the messages, but <code>BlockFetch</code> is
orchestrated by a central decision component in order to minimise
network usage by fetching blocks on-demand from a single peer and
avoid duplicated requests.</p>
</div>
<p>Received blocks are then given to the <a href="network/node-to-node/blockfetch/../../../consensus/chainsel.html">chain
selection</a> logic to determine their
<a href="network/node-to-node/blockfetch/../../../consensus/chainvalid.html">validity</a> and, depending on the chain selection
outcome, may be incorporated into the currently selected chain.</p>
<p>If the peer misbehaves, the connection will be abruptly
terminated. Actions that are considered misbehaving are (not exclusively):</p>
<ul>
<li>The peer violates the state machine of the protocol,</li>
<li>The server provided blocks that the client did not request,</li>
<li>The server sends a block that does not match the header it was supposed to match,</li>
<li>The server sends a block with a valid header but an invalid body.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Make this list exhaustive</p>
</div>
<h2 id="state-machine-2"><a class="header" href="#state-machine-2">State machine</a></h2>
<p>The state machine for BlockFetch is as follows:</p>
<pre class="mermaid">stateDiagram
   direction LR
   [*] --&gt; StIdle
   StIdle --&gt; [*]: MsgClientDone
   StIdle --&gt; StBusy: MsgRequestRange
   StBusy --&gt; StIdle: MsgNoBlocks
   StBusy --&gt; StStreaming: MsgStartBatch
   StStreaming --&gt; StStreaming: MsgBlock
   StStreaming --&gt; StIdle: MsgBatchDone

    classDef initiator color:#080
    classDef responder color:#008, text-decoration: underline
    class StIdle initiator
    class StBusy responder
    class StStreaming responder
</pre>
<h3 id="state-agencies-2"><a class="header" href="#state-agencies-2">State agencies</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">State</th><th style="text-align: left">Agency</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StBusy</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
<tr><td style="text-align: left">StStreaming</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
</tbody></table>
</div>
<h3 id="state-transitions-2"><a class="header" href="#state-transitions-2">State transitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">From state</th><th style="text-align: left">Message</th><th>Parameters</th><th style="text-align: left">To state</th></tr></thead><tbody>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgClientDone</td><td></td><td style="text-align: left">End</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgRequestRange</td><td><code>range</code></td><td style="text-align: left">StBusy</td></tr>
<tr><td style="text-align: left">StBusy</td><td style="text-align: left">MsgNoBlocks</td><td></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StBusy</td><td style="text-align: left">MsgStartBatch</td><td></td><td style="text-align: left">StStreaming</td></tr>
<tr><td style="text-align: left">StStreaming</td><td style="text-align: left">MsgBlock</td><td><code>body</code></td><td style="text-align: left">StStreaming</td></tr>
<tr><td style="text-align: left">StStreaming</td><td style="text-align: left">MsgBatchDone</td><td></td><td style="text-align: left">StIdle</td></tr>
</tbody></table>
</div>
<h2 id="access-pattern-of-blockfetch"><a class="header" href="#access-pattern-of-blockfetch">Access pattern of <code>BlockFetch</code></a></h2>
<p>The requests for blocks involve sequential portions of the chain, whether in the
immutable part or the volatile part of the chain.</p>
<p>The only special case being when a block has become immutable due to the current
chain selection growing in length. In such case the abstraction used to iterate
over the blocks has to be able to find the block which now would live in the
immutable storage.</p>
<h2 id="codecs-1"><a class="header" href="#codecs-1">Codecs</a></h2>
<p>The messages depicted in the state machine follow this CDDL specification:</p>
<pre><code class="language-cddl">;; messages.cddl
blockFetchMessage
     = msgRequestRange
     / msgClientDone
     / msgStartBatch
     / msgNoBlocks
     / msgBlock
     / msgBatchDone

msgRequestRange = [0, point, point]
msgClientDone   = [1]
msgStartBatch   = [2]
msgNoBlocks     = [3]
msgBlock        = [4, block.block]
msgBatchDone    = [5]

point = []                         ; the genesis point
      / [ base.slotNo, base.hash ]

;# import block as block
;# import base as base
</code></pre>
<p>The block is a tag-encoded value that contains CBOR-in-CBOR blocks for
the particular era. Note that byron takes both the <code>0</code> and the <code>1</code>
tags, one for a regular block, one for EBBs:</p>
<pre><code class="language-cddl">;; block.cddl
serialisedCardanoBlock = #6.24(bytes .cbor cardanoBlock)

cardanoBlock = byron.block
             / [2, shelley.block]
             / [3, allegra.block]
             / [4, mary.block]
             / [5, alonzo.block]
             / [6, babbage.block]
             / [7, conway.block]

;# import byron as byron
;# import shelley as shelley
;# import allegra as allegra
;# import mary as mary
;# import alonzo as alonzo
;# import babbage as babbage
;# import conway as conway
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="txsubmission2"><a class="header" href="#txsubmission2">TxSubmission2</a></h1>
<p><strong>Mini-protocol number: 4</strong></p>
<p><code>TxSubmission2</code> is the mini protocol in charge of diffusing pending transactions
through the network. It is a pull-based miniprotocol: data is transmitted only
upon explicit request from the client.</p>
<p>The goal of <code>TxSubmission2</code> is to let other peers know about the transactions
that the local node considers valid (with respects to the chain that the local
node has selected in <a href="network/node-to-node/txsubmission2/../../../consensus/chainsel.html">Chain Selection</a> in the
consensus layer), and transmit such transactions if requested.</p>
<p>An important piece of information is that transactions flow in the
opposite direction than blocks/headers. Blocks flow from
block-producers to their clients reaching the entirety of the network,
while transactions flow from all the network aiming to reach
block-producers. For this reason, in the state machine below it might
seem that agency is flipped but this is intentional. It is the
“client” (or the “initiator”) the one that gives transactions to the
“server” (or “responder).</p>
<p>Honest nodes will try to validate every transaction they come to know about.</p>
<p>There are some situations in which this miniprotocol would terminate abruptly,
closing all the connections to the remote peer. Actions that are considered as
misbehaviour are (not exclusively):</p>
<ul>
<li>Violation of the miniprotocol state machine,</li>
<li>Too many or not enough transactions sent or acknowledged via the client or
server,</li>
<li>Requesting zero transactions,</li>
<li>The client requesting a transaction that was not announced by the server.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Make this list exhaustive</p>
</div>
<h2 id="state-machine-3"><a class="header" href="#state-machine-3">State machine</a></h2>
<p>The state machine for TxSubmission2 is as follows:</p>
<pre class="mermaid">stateDiagram
   direction LR
   [*] --&gt; StInit
   StInit --&gt; StIdle: MsgInit
   StIdle --&gt; StTxs: MsgRequestTxs
   StTxs --&gt; StIdle: MsgReplyTxs
   StIdle --&gt; StTxIdsNonBlocking: MsgRequestTxIdsNonBlocking
   StTxIdsNonBlocking --&gt; StIdle: MsgReplyTxIds
   StIdle --&gt; StTxIdsBlocking: MsgRequestTxIdsBlocking
   StTxIdsBlocking --&gt; StIdle: MsgReplyTxIds
   StTxIdsBlocking --&gt; [*]: MsgDone

    classDef initiator color:#080
    classDef responder color:#008, text-decoration: underline
    class StIdle responder
    class StInit initiator
    class StTxs initiator
    class StTxIdsBlocking initiator
    class StTxIdsNonBlocking initiator
</pre>
<h3 id="state-agencies-3"><a class="header" href="#state-agencies-3">State agencies</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">State</th><th style="text-align: left">Agency</th></tr></thead><tbody>
<tr><td style="text-align: left">StInit</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left"><span style="color:#008;text-decoration:underline">Responder</span></td></tr>
<tr><td style="text-align: left">StTxs</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StTxIdsBlocking</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
<tr><td style="text-align: left">StTxIdsNonBlocking</td><td style="text-align: left"><span style="color:#080">Initiator</span></td></tr>
</tbody></table>
</div>
<h3 id="state-transitions-3"><a class="header" href="#state-transitions-3">State transitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">From state</th><th style="text-align: left">Message</th><th>Parameters</th><th style="text-align: left">To state</th></tr></thead><tbody>
<tr><td style="text-align: left">StInit</td><td style="text-align: left">MsgInit</td><td></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgRequestTxIdsNonBlocking</td><td><code>ack</code>, <code>req</code></td><td style="text-align: left">StTxIdsNonBlocking</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgRequestTxIdsBlocking</td><td><code>ack</code>, <code>req</code></td><td style="text-align: left">StTxIdsBlocking</td></tr>
<tr><td style="text-align: left">StTxIdsNonBlocking</td><td style="text-align: left">MsgReplyTxIds</td><td><code>[(id, size)]</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StTxIdsBlocking</td><td style="text-align: left">MsgReplyTxIds</td><td><code>[(id, size)]</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgRequestTxs</td><td><code>[id]</code></td><td style="text-align: left">StTxs</td></tr>
<tr><td style="text-align: left">StTxs</td><td style="text-align: left">MsgReplyTxs</td><td><code>[tx]</code></td><td style="text-align: left">StIdle</td></tr>
<tr><td style="text-align: left">StIdle</td><td style="text-align: left">MsgDone</td><td></td><td style="text-align: left">End</td></tr>
</tbody></table>
</div>
<h2 id="codecs-2"><a class="header" href="#codecs-2">Codecs</a></h2>
<p>The messages depicted in the state machine follow this CDDL specification:</p>
<pre><code class="language-cddl">;; messages.cddl
txSubmission2Message
    = msgInit
    ; corresponds to either MsgRequestTxIdsBlocking or
    ; MsgRequestTxIdsNonBlocking in the spec
    / msgRequestTxIds
    / msgReplyTxIds
    / msgRequestTxs
    / msgReplyTxs
    / tsMsgDone


msgInit         = [6]
msgRequestTxIds = [0, tsBlocking, txCount, txCount]
msgReplyTxIds   = [1, txIdsAndSizes ]
msgRequestTxs   = [2, txIdList ]
msgReplyTxs     = [3, txList ]
tsMsgDone       = [4]

tsBlocking      = false / true
txCount         = base.word16
; The codec only accepts indefinite-length lists.
txIdList        = [ *txId.txId ]
txList          = [ *tx.tx ]
txIdAndSize     = [base.txId, txSizeInBytes]
; The codec only accepts definite-length lists.
txIdsAndSizes   = [ *txIdAndSize ]
txSizeInBytes   = base.word32

;# import tx as tx
;# import txId as txId
;# import base as base
</code></pre>
<p>A transaction ID is a tag-encoded alternative of the transaction IDs
for each of the eras. Note that in Byron there are 4 alternatives for
a transaction ID:</p>
<pre><code class="language-cddl">;; txid.cddl
txId =
  base.ns7&lt;byronTxId,
           shelley.transaction_id,
           allegra.transaction_id,
           mary.transaction_id,
           alonzo.transaction_id,
           conway.transaction_id,
           babbage.transaction_id&gt;

byronTxId = [0, byron.txid]
          / [1, byron.certificateid]
          / [2, byron.updid]
          / [3, byron.voteid]

;# include byron as byron
;# include shelley as shelley
;# include allegra as allegra
;# include mary as mary
;# include alonzo as alonzo
;# include babbage as babbage
;# include conway as conway
;# import base as base
</code></pre>
<p>A transaction as transmitted in <code>TxSubmission2</code> is a tag-encoded
alternative of the transactions for each of the eras. Note that for
Shelley-onwards, the transaction is serialized in CBOR-in-CBOR:</p>
<pre><code class="language-cddl">;; tx.cddl
tx =
  base.ns7&lt;byron.tx,
           serialisedShelleyTx&lt;shelley.transaction&gt;,
           serialisedShelleyTx&lt;allegra.transaction&gt;,
           serialisedShelleyTx&lt;mary.transaction&gt;,
           serialisedShelleyTx&lt;alonzo.transaction&gt;,
           serialisedShelleyTx&lt;babbage.transaction&gt;,
           serialisedShelleyTx&lt;conway.transaction&gt;&gt;

serialisedShelleyTx&lt;era&gt; = #6.24(bytes .cbor era)

;# include byron as byron
;# include shelley as shelley
;# include allegra as allegra
;# include mary as mary
;# include alonzo as alonzo
;# include babbage as babbage
;# include conway as conway
;# import base as base
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="keepalive"><a class="header" href="#keepalive">KeepAlive</a></h1>
<p>TODO: fill this section</p>
<p>The state machine for the KeepAlive protocol is as follows:</p>
<pre class="mermaid">stateDiagram
  direction LR
  [*] --&gt; StClient
  StClient --&gt; StServer: MsgKeepAlive
  StServer --&gt; StClient: MsgKeepAliveResponse
  StClient --&gt; StDone: MsgDone
</pre>
<p>The CDDL for the messages in <code>KeepAlive</code> is as follows:</p>
<pre><code class="language-cddl">;; messages.cddl
keepAliveMessage = msgKeepAlive
                 / msgKeepAliveResponse
                 / msgDone

msgKeepAlive = [ 0, base.word16 ]
msgKeepAliveResponse = [ 1, base.word16 ]
msgDone = [ 2 ]

;# import base as base
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="the-consensus-layer"><a class="header" href="#the-consensus-layer">The Consensus Layer</a></h1>
<p>This document describes the components of the Consensus layer of a Cardano node,
serving as a reference for Cardano developers who want to implement a node or
interact with the Consensus layer of an existing implementation. We strive to
provide implementation-agnostic requirements and responsibilities for the
Consensus layer.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>This document is a work in progress.</p>
</div>
<p>The Consensus Layer runs the Consensus Protocol and invokes the <a href="consensus/../ledger">Ledger
layer</a> to validate chains produced according to the
protocol. The chain is then persisted in the <a href="consensus/../storage">Storage
layer</a>. Such chains are diffused using the <a href="consensus/../network">Networking
layer</a>. The contents of new blocks are provided by the
<a href="consensus/../mempool">Mempool</a>.</p>
<pre class="mermaid">flowchart TD
    NN1(&quot;Node&quot;) --&gt; NTN1
    NN2(&quot;Node&quot;) --&gt; NTN1
    NN3(&quot;Node&quot;) --&gt; NTN1

    NTN2 --&gt; N6(&quot;Node&quot;)
    NTN2 --&gt; N4(&quot;Node&quot;)
    NTN2 --&gt; N5(&quot;Node&quot;)

    subgraph &quot;Node&quot;;
      subgraph NTN1 [&quot;Network NTN (upstream)&quot;];
          M1(&quot;ChainSync&quot;)
          M2(&quot;BlockFetch&quot;)
          M3(&quot;TxSubmission2&quot;)
      end
      M1 --&gt; |block headers| A(&quot;Consensus&quot;)
      M2 --&gt; |block bodies| A(&quot;Consensus&quot;)
      subgraph NTN2 [&quot;Network NTN (downstream)&quot;];
          N1(&quot;ChainSync&quot;)
          N2(&quot;BlockFetch&quot;)
          N3(&quot;TxSubmission2&quot;)
      end

      M3 --&gt; |transactions| G
      D --&gt; |block headers| N1
      D --&gt; |block bodies| N2
      A(&quot;Consensus&quot;) &lt;--&gt; |blocks| D(&quot;Storage&quot;)
      G &lt;--&gt; |apply transactions| C
      A(&quot;Consensus&quot;) &lt;--&gt; |apply blocks| C(&quot;Ledger&quot;)
      A(&quot;Consensus&quot;) &lt;--&gt;|transactions snapshot| G(&quot;Mempool&quot;)
      G --&gt; |transactions| N3

    end
</pre>
<ul>
<li><a href="consensus/index.html#the-consensus-protocol-in-cardano">The Consensus Protocol in Cardano</a></li>
<li><a href="consensus/index.html#headerbody-split">Header|body split</a></li>
<li><a href="consensus/index.html#mini-protocols">Mini-protocols</a></li>
<li><a href="consensus/index.html#resilience-of-the-consensus-layer">Resilience of the Consensus layer</a></li>
<li><a href="consensus/index.html#requirements-imposed-onto-the-networkingdiffusion-layer">Requirements imposed onto the Networking/Diffusion layer</a></li>
<li><a href="consensus/index.html#requirements-imposed-onto-the-ledger-layer">Requirements imposed onto the Ledger layer</a></li>
</ul>
<h2 id="the-consensus-protocol-in-cardano"><a class="header" href="#the-consensus-protocol-in-cardano">The Consensus Protocol in Cardano</a></h2>
<p>The consensus protocol has three main responsibilities:</p>
<ul>
<li>
<p><a href="consensus/./chainvalid.html">Chain validity check</a>: the validity of a chain of blocks
is defined by the Consensus protocol, whether the values in the block match
are as expected. This involves things like singature checking, checking the
previous hash, ensuring the header is consistent, etc.</p>
</li>
<li>
<p><a href="consensus/./chainsel.html">Chain selection</a>: Competing chains arise when two or more
nodes extend the chain with different blocks. This can happen when nodes are
not aware of each other’s blocks due to temporarily network delays or
partitioning, but depending on the particular choice of consensus algorithm it
can also happen in the normal course of events. When it happens, it is the
responsibility of the consensus protocol to choose between these competing
chains.</p>
</li>
<li>
<p><a href="consensus/./forging.html">Leadership check and block forging</a>: In proof-of-work
blockchains any node can produce a block at any time, provided that they have
sufficient hashing power. By contrast, in proof-of-stake time is divided into
slots, and each slot has a number of designated slot leaders who can produce
blocks in that slot. It is the responsibility of the consensus protocol to
decide on this mapping from slots to slot leaders.</p>
</li>
</ul>
<p>The Ledger layer, upstream from the Consensus layer, has traditionally divided
development in several <em>eras</em>. Eras are names that designate major versions of
the network. Each era uses a different set of rules, mostly extending the rules
from the previous era with new constructs and rules or implementing completely
new features. The general interface of the Ledger layer is common to all eras,
and that is all that Consensus interacts with. See <a href="https://github.com/cardano-foundation/CIPs/blob/master/CIP-0059/feature-table.md">this table</a>
for the list of eras and their specifics.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Era transitions are enacted <em>on-chain</em> through specialized transactions.</p>
</div>
<p>Depending on the Ledger era in effect, the Consensus protocol (which governs
both chain selection and block production) is different:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Era</th><th style="text-align: left">Protocol</th><th style="text-align: left">Link</th></tr></thead><tbody>
<tr><td style="text-align: left">Byron</td><td style="text-align: left">Ouroboros Classic</td><td style="text-align: left"><a href="https://iohk.io/en/research/library/papers/ouroboros-a-provably-secure-proof-of-stake-blockchain-protocol/">Paper</a></td></tr>
<tr><td style="text-align: left">Byron (reimplementation, block forging)</td><td style="text-align: left">Ouroboros BFT</td><td style="text-align: left"><a href="https://iohk.io/en/research/library/papers/ouroboros-bft-a-simple-byzantine-fault-tolerant-consensus-protocol/">Paper</a></td></tr>
<tr><td style="text-align: left">Byron (reimplementation, block processing)</td><td style="text-align: left">Ouroboros Permissive BFT</td><td style="text-align: left">Section 4 of the <a href="https://github.com/intersectmbo/cardano-ledger/releases/latest/download/byron-blockchain.pdf">Byron spec</a></td></tr>
<tr><td style="text-align: left">Shelley</td><td style="text-align: left">Ouroboros Transitional Praos (TPraos)</td><td style="text-align: left">Section 12 of the <a href="https://github.com/intersectmbo/cardano-ledger/releases/latest/download/shelley-ledger.pdf">Shelley spec</a></td></tr>
<tr><td style="text-align: left">Allegra</td><td style="text-align: left">Ouroboros TPraos</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Mary</td><td style="text-align: left">Ouroboros TPraos</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Alonzo</td><td style="text-align: left">Ouroboros TPraos</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Babbage</td><td style="text-align: left">Ouroboros Praos</td><td style="text-align: left"><a href="https://iohk.io/en/research/library/papers/ouroboros-praos-an-adaptively-secure-semi-synchronous-proof-of-stake-protocol/">Paper</a></td></tr>
<tr><td style="text-align: left">Conway</td><td style="text-align: left">Ouroboros Praos</td><td style="text-align: left"></td></tr>
</tbody></table>
</div>
<p>Each of these protocols defines how to fulfill the responsibilities
above. Regarding validity of blocks, the Consensus layer can remain oblivious to
the details on validation and rely on the Ledger layer to make such judgment,
based on the particular era in effect.</p>
<h2 id="headerbody-split"><a class="header" href="#headerbody-split">Header|body split</a></h2>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>It is not mandatory that every implementation follows this split, however the
protocols used in the Network <em>will</em> use this distinction of headers and
bodies, so implementations can as well consider leveraging it.</p>
</div>
<p>An essential and uncontroversial design refinement in any blockchain
implementation is to separate block headers and block bodies:</p>
<ul>
<li>
<p>If blocks can be almost fully validated in constant time based on looking at
only a small fixed size block header, then honest nodes can validate candidate
chains with a small bounded amount of work.</p>
</li>
<li>
<p>It also enables a design where a node can see blocks available from many
immediate peers but can choose to download each block body of interest just once
(from a peer of its choosing from which it is available). This saves network
bandwidth.</p>
</li>
</ul>
<p>In the case of Ouroboros, all the cryptographic consensus evidence is packed
into the block header, leaving the block body containing only the ledger data,
and check that the block has been signed by a node that is the slot leader. If
we validate this in the context of a chain of headers, then we can establish
this is a plausible candidate chain, thus we eliminate several potential
resource draining attacks.</p>
<p>So the design at this stage involves transmitting chains of headers rather than
whole blocks, and using a secondary mechanism to download block bodies of
interest. This gives the reason why
<a href="consensus/../network/node-to-node/chainsync"><code>ChainSync</code></a> and
<a href="consensus/../network/node-to-node/blockfetch"><code>BlockFetch</code></a> are separate protocols.
The Consensus chain selection can look only at chains of block headers, whereas
the validity check of the block body can be performed by the Ledger rules,
effectively separating concerns.</p>
<h2 id="mini-protocols-1"><a class="header" href="#mini-protocols-1">Mini-protocols</a></h2>
<p>The mini-protocols mentioned in the neworking chapter are one of the possible
mechanisms used for data difussion. The <a href="https://ouroboros-network.cardano.intersectmbo.org/pdfs/network-design/network-design.pdf">Networking design
document</a> has many more insights on why these protocols were
implemented, and how they differ from other off-the-shelf mechanisms.</p>
<p>Although it is conceivable having other alternative mechanisms to exchange the
data, these mini-protocols are for now the common language spoken by the nodes
in the Cardano network, and as such it is expected that all node implementations
use them, or at least are <em>capable of using them</em> to communicate with the rest
of the network.</p>
<p>Note that mini-protocols are defined in the Networking layer, but it is the
Consensus layer the one that provides the data for such
protocols. Mini-protocols are therefore the <em>interface</em> between Network and
Consensus.</p>
<h2 id="resilience-of-the-consensus-layer"><a class="header" href="#resilience-of-the-consensus-layer">Resilience of the Consensus layer</a></h2>
<p>Consensus must not expose meaningful advantages for adversaries that could
trigger a worst-case situation in which the amount of computation to be
performed would block the node. This is generally achieved by trying to respect
the following principle:</p>
<blockquote>
<p>The cost of the worst case should be no greater than the cost of the best
case.</p>
</blockquote>
<p>We don’t want to optimize for the best case because it exposes the node to DoS
attacks if the adversary is capable of tricking the node into the worst case.</p>
<h2 id="requirements-imposed-onto-the-networkingdiffusion-layer"><a class="header" href="#requirements-imposed-onto-the-networkingdiffusion-layer">Requirements imposed onto the Networking/Diffusion layer</a></h2>
<p>To maximize the probability of the block being included in the definitive chain,
the Consensus layer has to strive to mint new blocks on top of the best block
that exists in the network. Therefore it necessitates of a fast diffusion layer
for blocks to arrive on time to the next block minters.</p>
<h2 id="requirements-imposed-onto-the-ledger-layer"><a class="header" href="#requirements-imposed-onto-the-ledger-layer">Requirements imposed onto the Ledger layer</a></h2>
<p>The role of the Ledger layer is to define what is stored <em>inside</em> the blocks of
the blockchain. It is involved in mutating the <em>Ledger State</em> which is the
result of applying blocks from the chain and can be used to validate further
blocks or transactions. From the perspective of the consensus layer, the ledger
layer has four primary responsibilities:</p>
<ul>
<li>
<p>Applying blocks: The most obvious and most important responsibility of the
ledger is to define how the ledger state changes in response to new blocks,
validating blocks at it goes and rejecting invalid blocks.</p>
</li>
<li>
<p>Applying transactions: Similar to applying blocks, the ledger layer must also
provide an interface for applying a single transaction to the ledger state. This
is important, because the consensus layer does not just deal with previously
constructed blocks, but also constructs new blocks.</p>
</li>
<li>
<p>Ticking time: Some parts of the ledger state change only due to the passage of
time. For example, blocks might schedule some changes to be applied at a given
slot, without the need for a block to be processed at that slot.</p>
</li>
<li>
<p>Forecasting: Some consensus protocols require limited information from the
ledger. For instance, in Praos, a node’s probability of being elected a slot
leader is proportional to its stake, but the stake distribution is something
that the ledger keeps track of. This information is referred to as <em>ledger
view</em>. We require not just that the ledger can provide a view of the current
ledger state but also that it can predict what view will be for slots in the
near future.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="chain-validity"><a class="header" href="#chain-validity">Chain validity</a></h1>
<p>A chain of blocks has to be valid in order to be considered for adoption. In
particular the mainnet chain <em>is</em> valid.</p>
<p>Validity is defined by induction on the length of the chain as:</p>
<ul>
<li>The first block on the chain fragment is valid,</li>
<li>The tail of the chain fragment is valid.</li>
</ul>
<p>For a block to be considered valid it has to be valid in three directions:</p>
<ul>
<li>The <a href="consensus/chainvalid.html#the-envelope-of-a-header">envelope</a> of the header must be valid,
validity in this dimension is a Consensus responsibility.</li>
<li>The header must be valid, validity in this dimension is defined by the
<a href="consensus/./#the-consensus-protocol-in-cardano">Consensus Protocol</a> in effect.</li>
<li>The body must be valid, validity in this dimension is defined by the <a href="https://github.com/cardano-foundation/CIPs/blob/master/CIP-0059/feature-table.md">Ledger
era</a>
in effect. This check belongs to the Ledger layer so we will omit its details
in the rest of the document.</li>
</ul>
<p>From the description below, we omit the Ouroboros Classic case as such protocol
has been effectively retired once (P)BFT were implemented. On the original
implementation of Ouroboros Classic, the concept of Epoch Boundary Blocks (EBBs)
was introduced, blocks which were made redundant by Ouroboros BFT. Such blocks
had the peculiarity of sharing the slot number with the parent block and the
block number with the subsequent block.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: this whole page could probably benefit of formal specs.</p>
</div>
<ul>
<li><a href="consensus/chainvalid.html#the-envelope-of-a-header">The Envelope of a header</a></li>
<li><a href="consensus/chainvalid.html#ouroboros-bft">Ouroboros BFT</a></li>
<li><a href="consensus/chainvalid.html#ouroboros-pbft">Ouroboros PBFT</a></li>
<li><a href="consensus/chainvalid.html#ouroboros-praos">Ouroboros Praos</a></li>
<li><a href="consensus/chainvalid.html#ouroboros-tpraos">Ouroboros TPraos</a></li>
<li><a href="consensus/chainvalid.html#skipping-the-validation-checks-on-trusted-data">Skipping the validation checks on trusted data</a></li>
</ul>
<h2 id="the-envelope-of-a-header"><a class="header" href="#the-envelope-of-a-header">The Envelope of a header</a></h2>
<p>The Envelope of a header consists of the ledger-independent data of a block,
such as block number, slot, hash, shape of the block, size, … These checks are
independent of the actual Consensus Protocol in effect and are used as a first
sanity check on received blocks.</p>
<p>An envelope is valid if:</p>
<ul>
<li>The block number is greater or equal (if the previous one was an EBB) to the
previous one,</li>
<li>The slot number is greater or equal (if it is an EBB) to the previous one,</li>
<li>The hash of the previous block is the expected one,</li>
<li>If the block is a known checkpoint, check that it matches the information of
such known checkpoint,</li>
<li>The era of the header matches the era of the body,</li>
<li>In Byron, the block is not an EBB when none was expected,</li>
<li>In Shelley:
<ul>
<li>The protocol version in the block is not greater than the maximum version
understood by the node (note that this check depends on each node’s version,
so this check might pass in up-to-date nodes and fail in out-of-date nodes
for the same block).</li>
<li>The header is no larger than the maximum header size allowed by the protocol
parameters,</li>
<li>The body is no larger than the maximum body size allowed by the protocol
parameters.</li>
</ul>
</li>
</ul>
<h2 id="ouroboros-bft"><a class="header" href="#ouroboros-bft">Ouroboros BFT</a></h2>
<p>In Ouroboros BFT, a block is a tuple <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">block</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> where</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> is the hash of the previous block,</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> is a set of transactions,</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> is a (slot) time-stamp,</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a signature of the slot number, and</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">block</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a signature of the entire block.</li>
</ul>
<p>We can reorganize the contents of a block in <em>header</em> and <em>body</em> following the
<a href="consensus/./#headerbody-split">Header|body split</a>. The <em>body</em> would contain
the list of transactions <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>, and the <em>header</em> would contain all the rest of the
data.</p>
<p>A block is said to be <em>valid</em> if:</p>
<ul>
<li>The header is valid:
<ul>
<li>Signatures are correct, both for the slot and for the entire block,
<ul>
<li>The issuer of the block was delegated in the Genesis block,</li>
<li>The issuer has not signed more than the allowed number of blocks recently
(TODO: where does this come from? the signature scheme? It doesn’t seem to
appear in the paper)</li>
</ul>
</li>
<li>The slot of the block is greater than the last signed slot in the chain,</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> is indeed the hash of the previous block,</li>
</ul>
</li>
<li>The body, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>, is a valid sequence of transactions to be applied on top of the
Ledger State resulted from applying all previous blocks since the Genesis
block. Notice the validity of these transactions is defined in the Ledger
layer.</li>
</ul>
<p>See Figure 1 in the <a href="https://iohk.io/en/research/library/papers/ouroboros-bft-a-simple-byzantine-fault-tolerant-consensus-protocol/">paper</a>.</p>
<h2 id="ouroboros-pbft"><a class="header" href="#ouroboros-pbft">Ouroboros PBFT</a></h2>
<p>Ouroboros PBFT has two separate rules for validity of blocks, depending on
whether they are Epoch Boundary Blocks or Regular Blocks:</p>
<ul>
<li>
<p>An Epoch Boundary Block is <em>valid</em> if its header is valid.</p>
</li>
<li>
<p>A Regular Block is <em>valid</em> if it is valid for Ouroboros BFT.</p>
</li>
</ul>
<h2 id="ouroboros-praos"><a class="header" href="#ouroboros-praos">Ouroboros Praos</a></h2>
<p>TODO</p>
<h2 id="ouroboros-tpraos"><a class="header" href="#ouroboros-tpraos">Ouroboros TPraos</a></h2>
<p>TODO</p>
<h2 id="skipping-the-validation-checks-on-trusted-data"><a class="header" href="#skipping-the-validation-checks-on-trusted-data">Skipping the validation checks on trusted data</a></h2>
<p>Blocks can be applied much more quickly if they are known to have been
previously validated, as the outcome will be exact same, since they can only
validly extend a single chain.</p>
<p>This can be leveraged to skip such checks when replaying a chain that has
already been validated, for example when restarting a node and having to replay
the chain from scratch.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="chain-selection"><a class="header" href="#chain-selection">Chain selection</a></h1>
<p><em>Chain selection</em> is the mechanism, specified in the Protocol associated to the
current era in effect in the network, of identifying and and adopting the best
chain in the network. A node might receive distinct chains from its peers. This
situation is expected during normal operation of the Praos protocol and its
derivatives.</p>
<p>It is important to note that <strong>all nodes</strong> participating in the network are in
charge of this responsibility, as opposed to producing blocks, which only some
nodes will be involved in doing (namely those with forging credentials, the
cryptographic keys for signing new blocks on behalf of a stake pool). This
implies that even non-block-forging nodes contribute to the security of the
network as a whole.</p>
<p>Because each node performs chain selection, the Cardano network acts as a
forward-filtering diffusion network.</p>
<p>The block headers come from <a href="consensus/../network/node-to-node/chainsync"><code>ChainSync</code></a> and
the block bodies come from <a href="consensus/../network/node-to-node/blockfetch"><code>BlockFetch</code></a>.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Chain selection is performed based on data from the previous headers, so there
is some state (specific to each protocol) that influences the selection, which
we will call <em>chain state</em>, as opposed to the state of the ledger or
<em>on-chain</em> state, which we will call <em>ledger state</em>.</p>
</div>
<p>It is the decisions from running <em>chain selection</em> the ones that mutate the data
in <a href="consensus/../storage">the Storage layer</a>. Also the newly selected chain will influence
<a href="consensus/../mempool">the Mempool</a> as transactions will be revalidated against this new
chain.</p>
<ul>
<li><a href="consensus/chainsel.html#forecast-range">Forecast range</a></li>
<li><a href="consensus/chainsel.html#the-k-security-parameter">The <code>k</code> security parameter</a></li>
<li><a href="consensus/chainsel.html#the-chain-selection-rule">The Chain Selection Rule</a>
<ul>
<li><a href="consensus/chainsel.html#ouroboros-classic">Ouroboros Classic</a></li>
<li><a href="consensus/chainsel.html#ouroboros-bft-and-pbft">Ouroboros BFT and PBFT</a></li>
<li><a href="consensus/chainsel.html#ouroboros-tpraos-and-praos">Ouroboros TPraos and Praos</a></li>
<li><a href="consensus/chainsel.html#tie-breakers-in-praos-and-older-protocols">Tie breakers in Praos and older protocols</a></li>
<li><a href="consensus/chainsel.html#ouroboros-genesis">Ouroboros Genesis</a></li>
</ul>
</li>
</ul>
<h2 id="forecast-range"><a class="header" href="#forecast-range">Forecast range</a></h2>
<p>TODO: Explain that the ledger can predict the view inside the forecast range.
How long is it? What bounds it?</p>
<p>The validity of the headers of a candidate can be checked using the Chain State
and Ledger State at the intersection point, as long as the distance in slots
between the intersection and the candidate header is no more than the forecast
range. For example, in this chains, the headers of the blocks in the candidate
that are no further than the forecast range in slots from block 1 could be
validated. In Praos, the forecast range is set to <code>3k/f = 129,600</code> slots.</p>
<pre class="mermaid">---
config:
  gitGraph:
    mainBranchName: &quot;selected chain&quot;
---
gitGraph
    commit
    commit
    branch candidate
    checkout candidate
    commit
    commit
    checkout &quot;selected chain&quot;
    commit
    checkout candidate
    commit
    commit
    checkout &quot;selected chain&quot;
    commit
</pre>
<p>This is possible because the parts of the ledger state necessary to validate a
header were completely determined some positive number of slots ago on that
header’s chain.</p>
<h2 id="the-k-security-parameter"><a class="header" href="#the-k-security-parameter">The <code>k</code> security parameter</a></h2>
<p>Both Ouroboros Classic and Ouroboros Praos are based on a chain selection rule
that imposes a maximum rollback condition: alternative chains to a node’s
current chain that fork off more than a certain number of blocks ago are never
considered for adoption. This limit is known as the security parameter, and is
usually denoted by <code>k</code>, which on mainnet is currently set to 2160
blocks. Analysis from research has shown this parameter ensures nodes will not
diverge more than <code>k</code> blocks under honest circumstances with sufficiently high
probability.</p>
<p>Ouroboros BFT does not impose a maximum rollback, but adding such a requirement
does not change the protocol in any fundamental way.</p>
<p>The Consensus layer must evaluate the validity of any candidate chain. To
evaluate the validity of a particular header, a Chain State at the predecessor
header is required. To evaluate the validity of a particular block, a Ledger
State at the predecessor block is required.</p>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>Along the selected chain, the combined Ledger and Chain states should be kept
in memory for all the <code>k</code> volatile blocks (and for the immutable tip, so <code>k+1</code>
states). This way, evaluation of candidates can be performed in a timely
manner.</p>
</div>
<p>Making use of this parameter, the chain can be subdivided into the Immutable and
Volatile parts of the chain:</p>
<pre class="mermaid">flowchart RL
    subgraph &quot;Volatile chain&quot;;
      subgraph &quot;current selection&quot;;
        Tip --&gt;|...| Km1[&quot;(k-1)-th Block&quot;]
        Km1 --&gt; K[&quot;k-th Block&quot;]
      end

      O1[&quot;Block&quot;] --&gt; O2[&quot;Block&quot;]
      O3[&quot;Block&quot;] --&gt; K

      O4[&quot;Block&quot;]
    end

    subgraph &quot;Immutable chain&quot;;
     Kp1[&quot;(k+1)-th Block&quot;] --&gt; Kp2[&quot;(k+2)-th Block&quot;]
     Kp2[&quot;(k+2)-th Block&quot;] --&gt; |...| A[Genesis]
    end
    K --&gt; Kp1
</pre>
<p>The Immutable part can be persisted in the storage as Ouroboros guarantees it
will not change, whereas the selection in the Volatile part might change as new
blocks arrive, creating new candidates.</p>
<h2 id="the-chain-selection-rule"><a class="header" href="#the-chain-selection-rule">The Chain Selection Rule</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: this section could probably benefit of formal specs.</p>
</div>
<p>The specific rule for determining the best chain is dictated by the active era’s
protocol.</p>
<h3 id="ouroboros-classic"><a class="header" href="#ouroboros-classic">Ouroboros Classic</a></h3>
<p>In Ouroboros Classic, the protocol defines the function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathtt">maxvalid</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathcal" style="margin-right:0.05834em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbb">C</span><span class="mclose">)</span></span></span></span> for choosing the best chain considering
the current selected chain <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span></span></span> and the set of valid chains
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span> available in the network. The rule states that the chosen candidate
must be the longest one, breaking ties in favor of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span></span></span>.</p>
<p>See the definition of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord"><span class="mord"><span class="mord mathtt">maxvalid</span></span></span></span></span></span> in section 4.1 in the <a href="https://iohk.io/en/research/library/papers/ouroboros-a-provably-secure-proof-of-stake-blockchain-protocol/">paper</a>.</p>
<h3 id="ouroboros-bft-and-pbft"><a class="header" href="#ouroboros-bft-and-pbft">Ouroboros BFT and PBFT</a></h3>
<p>In Ouroboros BFT, the protocol declares that a node should replace the local
chain <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with a different chain
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9019em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> if <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>, therefore if the candidate is longer
than the current selection.</p>
<p>See Figure 1 in the <a href="https://iohk.io/en/research/library/papers/ouroboros-bft-a-simple-byzantine-fault-tolerant-consensus-protocol/">paper</a>.</p>
<p>Ouroboros PBFT does not change the chain selection rules of BFT, just focuses on
validity of blocks, making parts of the block superfluous. It therefore also
uses length to choose among candidates.</p>
<h3 id="ouroboros-tpraos-and-praos"><a class="header" href="#ouroboros-tpraos-and-praos">Ouroboros TPraos and Praos</a></h3>
<p>Ouroboros Praos circles back to defining the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathtt">maxvalid</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathcal" style="margin-right:0.05834em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbb">C</span><span class="mclose">)</span></span></span></span> function, with identical behaviour to that in Ouroboros
Classic. This means that longer candidates are preferrable to shorter ones, and
that ties are broken in favour of the already selected candidate.</p>
<p>See Figure 4 and the definition of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord"><span class="mord"><span class="mord mathtt">maxvalid</span></span></span></span></span></span> above it in the
<a href="https://iohk.io/en/research/library/papers/ouroboros-praos-an-adaptively-secure-semi-synchronous-proof-of-stake-protocol/">paper</a>.</p>
<p>Ouroboros TPraos refines how blocks are produced, but doesn’t modify the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6111em;"></span><span class="mord"><span class="mord"><span class="mord mathtt">maxvalid</span></span></span></span></span></span> function in any way.</p>
<h3 id="tie-breakers-in-praos-and-older-protocols"><a class="header" href="#tie-breakers-in-praos-and-older-protocols">Tie breakers in Praos and older protocols</a></h3>
<p>The rules above do specify that in case of a tie with the already selected
chain, the node should not alter its selection however this leads to some
detrimental consequences for the network: chain diffusion times influence which
chain is adopted first and therefore would win chain selection against any other
equally long chain.</p>
<p>Some stake pool operators then would have the unfair incentive of gathering in
very close data centers or even in the same one, to make their chains arrive as
fast as possible to other peers that would adopt those chains and then reject
alternative chains.</p>
<p>This is bad for Cardano as a whole as it goes against geographical
decentralization of the network.</p>
<p>To prevent this incentive from disrupting the chain, some tie breaks were put in
place, effectively refining the Praos chain selection rule:</p>
<ul>
<li>Chains are first compared by length, longer chains are preferred.</li>
<li>If the tip of both chains is issued by the same stake pool, the one with the
higher ocert is preferred. Note that for a block to be valid, the ocert can
increase at most by 1.</li>
<li>If the tips are issued by different stake pools, the block with the lower VRF
value is preferred. Up to and including Babbage this comparison was
unconditional, but starting on Conway this comparison is only performed if
blocks do not differ in more than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> slots. This ensures that blocks forged
much later cannot win against already selected chains, as that would
incentivize stake pools to ignore blocks from other pools if theirs can win a
VRF comparison.</li>
</ul>
<h3 id="ouroboros-genesis"><a class="header" href="#ouroboros-genesis">Ouroboros Genesis</a></h3>
<p>When a node is syncing with the network, there is little benefit in having it
participate in producing blocks or validating transactions as it doesn’t have a
ledger state close enough to the tip of the chain. This in particularly means
that all the responsibilities of a node are discharged from such syncing node
except the duty to select the best chain it can.</p>
<p>On BFT/Classic, as only seven authorized Core nodes were able to make new
blocks, there can be no mistake on the chosen chain (assuming Core nodes keys
aren’t compromised and used to create an old adversarial chain in the Byron
era).</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: double-check ^</p>
</div>
<p>However, in Praos, the rule for selecting the best chain between two competing
chains is fundamentally based on chain length. The protocol assumes
instantaneous transmission of entire chains, meaning that the perceived length
of a candidate would be its actual length.  Due to fundamental real-world
limitations, sending such a large amount of data instantaneously is impossible;
instead, data is streamed to the syncing node. Consequently, nodes only know the
length of the received prefix of the candidate chain. This creates the risk of
adversaries tricking nodes into committing to an adversarial chain during
synchronization.</p>
<p><a href="https://iohk.io/en/research/library/papers/ouroboros-genesis-composable-proof-of-stake-blockchains-with-dynamic-availability/">Ouroboros Genesis</a> is a refinement of Praos used by nodes only during
network synchronization. The key point of Genesis is precisely a refinement of
the Praos chain selection rule: instead of choosing based (primarily) on length
of the candidate chains, it chooses based on the density of blocks at the
intersection of the candidates, leveraging the property of Ouroboros that the
honest chain will have more blocks than any other adversarial chain within a
specific window of slots from the intersection point. More information can be
found <a href="https://iohk.io/en/blog/posts/2024/05/08/ouroboros-genesis-design-update/">here</a>.</p>
<p>This means that in order to make an correct decision about the density of
candidate chains, the node must know all the blocks (or lack thereof) within a
genesis window from the intersection point of the candidates. The genesis window
is defined as <code>3k/f</code> slots.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO ^ is that correct?</p>
</div>
<p>Chain selection is stalled while the necessary information is gathered. To
prevent servers from indefinitely blocking clients, two practical refinements
were implemented on top of the Genesis specification:</p>
<ul>
<li>Limit on Eagerness: TODO</li>
<li>Limit on Patience: TODO</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: do we want to specify the genesis state machine? the dynamo and all that?</p>
</div>
<p>Once the node finishes syncing with the network, this rule gracefully converges
into the usual length-based comparison used in Praos, so the node can safely
switch to running only Ouroboros Praos.</p>
<!-- iohk.io links return 403 "if you are not a human" -->
<!-- markdown-link-check-disable -->
<!-- markdown-link-check-enable -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="forging-new-blocks"><a class="header" href="#forging-new-blocks">Forging new blocks</a></h1>
<p>Forging new blocks is the process of packing data that has not yet been included
in the blockchain (pending transactions) into a fresh block. Blocks are signed
by stake pool credentials, so only the nodes which are configured with such
credentials would be able to forge blocks and therefore only those nodes are
strictly need to implement the forging mechanism.</p>
<h2 id="forging"><a class="header" href="#forging">Forging</a></h2>
<p>Every slot, the stake pool (whose keys the node was configured with) might be
entitled to produce a block, depending on the rules of the particular Protocol
that is running at the tip of the current chain. For Praos on the current chain
on mainnet, slots have a duration of one second. The probability of a node being
elected in a slot is controlled via the <em>active slot coefficient</em> parameter
(commonly referred to as <code>f</code>) which on mainnet is <code>0.05</code>. This means that a
block is expected once every 20 slots on average.</p>
<p>Forging a block would look something similar to the following sequence of
actions:</p>
<ol>
<li>Determine whether my stake pool is entitled to create a block on
this slot. Below we describe what this means in Ouroboros Praos. We
omit the details for other protocols as they do not produce blocks
anymore on Cardano mainnet.</li>
<li>Acquire a data to constitute the body of a block. Consensus is theoretically
unaware of what data makes up the block body, and it will be the
<a href="consensus/../mempool">Mempool</a> the one that specifies which data is valid and provides
such data.</li>
<li>Pack the data into a block body, produce a block header and emit a signature.</li>
</ol>
<p>Note that it is in the interest of the stake pool (so that its block is included
in the chain) and of the network as a whole (so that the chain grows) that the
process of creating a block is as fast as possible while still producing a fully
valid block.</p>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>To ensure the new block is actually valid, it could be fed into the <a href="consensus/./chainsel.html">Chain
Selection</a> logic, which is expected to select it and then
<a href="consensus/../storage/#chain-diffusion">diffuse</a> it via the usual mechanisms. This sanity
check is not a hard requirement but it is advised to be implemented. If not
even the node that created the block can adopt it, sending such block to the
network would be useless.</p>
</div>
<h2 id="multi-leader-slots"><a class="header" href="#multi-leader-slots">Multi-leader slots</a></h2>
<p>There exists the possibility of multiple stake pools being elected in the same
slot. If the nodes of both pools produce blocks, a momentary fork will exist in
the chain, which we call a <em>slot battle</em>. Ouroboros Praos guarantees that only
one of those blocks will end up in the honest chain, and that such a fork will
not survive more than the time it will take for either of the candidates to grow
to <code>k</code> blocks.</p>
<p>Two stake pools might be elected in very close slots, which implies that if the
block of the first stake pool doesn’t arrive at the node of the second stake
pool on time, it will not be considered when the second node forges its block,
creating another short-lived fork. This situation is called a <em>height
battle</em>. To avoid this situation, it is of utmost importance that the forging of
a block and its diffusion through the network (first its header via ChainSync,
then its body via BlockFetch) is as fast as possible.</p>
<h2 id="leadership-check-in-ouroboros-praos"><a class="header" href="#leadership-check-in-ouroboros-praos">Leadership check in Ouroboros Praos</a></h2>
<p>In Ouroboros Praos, the stake distribution is what dictates the elegibility of
an stake pool for being elected. The probability of a stake pool <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with
relative stake <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> being elected as slot leader comes from this formula:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">ϕ</span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>Some important properties are ensured by Praos:</p>
<ul>
<li>There can be multiple slot leaders as the events “<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a leader for slot
<code>sl</code>” are independant,</li>
<li>There can be slots with no leader,</li>
<li>Only a slot leader is aware that it is indeed a leader for a given slot,</li>
<li>The probability of being a slot leader is independent of whether the stake
pool acts as a single party or splits it stake among several “virtual”
parties.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO should probably discuss the leadership schedule, how can one know it in
advance, the stability periods, the parts of the epoch, which distribution is
used (2 epochs ago?)</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="multi-era-considerations"><a class="header" href="#multi-era-considerations">Multi-era considerations</a></h1>
<p>With the blockchain network evolving, the block format and ledger
rules are bound to change. In Cardano, every significant change starts
a new “era”. There are several ways to deal with multiple eras in the
node software, associated here with some of <a href="https://en.wikipedia.org/wiki/Alignment_(role-playing_games)#Dungeons_&amp;_Dragons">the DnD
alignments</a>:</p>
<ul>
<li>
<p>Chaotic Evil: the node software only ever implements one era. When
the protocol needs to be updated, all participants must update the
software or risk being ejected from the network. Most importantly, the
decision to transition to the new era needs to happen off-chain.</p>
<ul>
<li>
<p>Pros:</p>
<ul>
<li>the simplest possible node software.</li>
</ul>
</li>
<li>
<p>Cons:</p>
<ul>
<li>on-chain governance of the hard-fork is impossible, as the
software has no way of knowing where the era boundary is and
does not even have such a concept.</li>
<li>Additionally, special care is needed to process history blocks:
chain replay is likely to be handled by special code, separate
from the active era’s logic.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Chaotic Good: the node software supports the current era and the
next era. Once the next era is adopted, a grace period is allowed
for the participants to upgrade. The decision to upgrade may happen
on chain.</p>
<ul>
<li>Pros:
<ul>
<li>allows for on-chain governance of the hard fork.</li>
</ul>
</li>
<li>Cons:
<ul>
<li>supporting two eras is more difficult than one: higher chances
of bugs that will cause the network to fork in an unintended
way.</li>
<li>Like in the previous case, special care is needed to process
historic blocks.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>True Neutral: software is structured in such a way that is supports
all eras.</p>
<ul>
<li>Pros:
<ul>
<li>enables massive code reuse and forces the code to be structured
in the way that allows for abstract manipulation of blocks of
different eras.</li>
<li>The on-chain governance of hard-forks is reflected in the code,
and ideally in the types as well, making it more likely that
unintended scenarios are either impossible or easily discover
able through type checking and testing.</li>
</ul>
</li>
<li>Cons:
<ul>
<li>abstraction is a double-edged sword and may be difficult to
encode in some programming languages.</li>
<li>Engineers require extended onboarding to be productive.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>We argue that Cardano has been the True Neutral so far, which allowed
to maintain the stability of the network while allowing it to change
and evolve.</p>
<p>Having multiple eras comes with some subtleties on era boundaries that
implementors need to take into account:</p>
<h2 id="time"><a class="header" href="#time">Time</a></h2>
<h2 id="forecast-range-1"><a class="header" href="#forecast-range-1">Forecast range</a></h2>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="the-storage-layer"><a class="header" href="#the-storage-layer">The Storage Layer</a></h1>
<p>The Storage layer is responsible of storing the blocks on behalf of the
Consensus layer. It is also involved in serving the data for <a href="storage/index.html#chain-diffusion">Chain
diffusion</a>.</p>
<p>Some of this data is volatile and relates to the candidate chains and other data
is immutable and relates to the historical chain, following the principle
described in <a href="storage/../consensus/chainsel.html#the-k-security-parameter">the <code>k</code> security parameter
section</a>.</p>
<pre class="mermaid">flowchart TD
    A(&quot;Storage&quot;) -- Sequential Access --&gt; B(&quot;Immutable Chain&quot;)
    A(&quot;Storage&quot;) -- Random Access --&gt; C(&quot;Volatile Chain&quot;)
    A(&quot;Storage&quot;) -- Random Access --&gt; D(&quot;Recent Leder States&quot;)

    subgraph noteA [&quot;Hot - Efficient Rollback&quot;]
        C
        D
    end
    subgraph noteB [&quot;Cold - Efficient Storage&quot;]
        B
    end
</pre>
<p>Any storage system designed for Cardano must meet certain requirements for the
miniprotocols and the Consensus layer to function properly:</p>
<ul>
<li>Fast sequential access to immutable blocks: syncing peers request historical
chain blocks sequentially,</li>
<li>Fast sequential access to current chain-selection blocks in the volatile part
of the chain: peers request this information during syncing and when
caught-up,</li>
<li>Fast switch to an alternative chain in the volatile part of the chain,</li>
<li>Fast identification of chains of blocks in the volatile part of the chain:
even if blocks arrive in arbitrary order, the Consensus <a href="storage/../consensus/chainsel.html">Chain
Selection</a> should be invoked to select a better
candidate chain once assembled in the volatile part of the chain,</li>
<li>Fast node restart after shutdown without full chain replay, while supporting
<code>k</code>-deep forks.</li>
</ul>
<p>It is interesting to note that the storage layer does not need to provide the
Durability in the ACID acronym: upstream peers will always be available to
replace any blocks a node loses.</p>
<h2 id="chain-diffusion"><a class="header" href="#chain-diffusion">Chain diffusion</a></h2>
<p>The mathematical model of the Ouroboros Consensus Protocols assumes
instantaneous transmission (and validation) of chains, becoming instantly
available even for newly joined peers. This is, even if just because of physical
real-world limitations, infeasible in practice. For this reason, transmission of
chains is done in a block-by-block basis instead. This allows chains to be
incrementally sent to peers but comes with its own risks for newly joined peers
(see <a href="storage/../consensus/chainsel.html#ouroboros-genesis">Ouroboros Genesis</a>).</p>
<p>Furthermore, blocks (which in the end is the data transmitted over the network)
are subdivided in block headers and block bodies, as described in the
<a href="storage/../consensus/#headerbody-split">Header|body split</a> section.</p>
<p>The diffusion of data in the Cardano network is in fact a responsibility of the
<a href="storage/../network/">Networking layer</a>. The diffusion of chains involves accessing the
Storage layer and serving its contents to peers, however it is ultimately the
<a href="storage/../consensus/">Consensus layer</a> the one that decides how the data in the
Storage layer is mutated, as an outcome of <a href="storage/../consensus/chainsel.html">Chain
Selection</a>.</p>
<blockquote>
<p>Chain diffusion is a joint effort of the Consensus, Network and Storage
layers.</p>
</blockquote>
<p>Diffusion of chains is achieved by means of
<a href="storage/../network/node-to-node/chainsync"><code>ChainSync</code></a> and
<a href="storage/../network/node-to-node/blockfetch"><code>BlockFetch</code></a> mini-protocols.</p>
<p>In a sense, the Storage layer has the data to provide the meaning of the
messages in the mini-protocol whereas the networking layer describes the kinds
of messages a protocol is composed by. It is possible to run an interaction of
the protocol exchanging data that does not follow the intended semantics (for
example an evil node sending all the chains it knows about instead of only the
best selection).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="cardano-nodes-chaindb"><a class="header" href="#cardano-nodes-chaindb"><code>cardano-node</code>’s ChainDB</a></h1>
<p>In the Haskell reference implementation, the Storage layer manages a <code>ChainDB</code>,
whose storage components are the Immutable Database, Volatile Database and
Ledger State snapshots:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Component</th><th style="text-align: left">Responsibility</th></tr></thead><tbody>
<tr><td style="text-align: left">Immutable Database</td><td style="text-align: left">Store definitive blocks and headers sequentially</td></tr>
<tr><td style="text-align: left">Volatile Database</td><td style="text-align: left">Store a bag of non-definitive blocks and headers. In particular it contains the blocks which, when linked sequentially, form the current selected chain</td></tr>
<tr><td style="text-align: left">Ledger State snapshots</td><td style="text-align: left">Periodically store the ledger state at the tip of the ImmutableDB</td></tr>
</tbody></table>
</div>
<p>Although this implementation represents just one of many possible data storage
solutions, it is the one used by the reference <code>cardano-node</code> implementation and
has become the de-facto standard for distributing the Cardano chain when the
node is not involved. Consequently, services like Mithril sign this directory
structure and its format.</p>
<p>It consists of 3 separate directories in which different data is stored:</p>
<pre><code>db
├── immutable
│   ├── 00000.chunk
│   ├── 00000.primary
│   ├── 00000.secondary
│   └── ...
├── ledger
│   └── 164021355
└── volatile
    ├── blocks-0.dat
    └── ...
</code></pre>
<p>This diagram depicts where the blocks are distributed in such directories:</p>
<pre class="mermaid">flowchart RL
    subgraph volatile;
      subgraph &quot;current selection&quot;;
        Tip --&gt;|...| Km1[&quot;(k-1)-th Block&quot;]
        Km1 --&gt; K[&quot;k-th Block&quot;]
      end

      O1[&quot;Block&quot;] --&gt; O2[&quot;Block&quot;]
      O3[&quot;Block&quot;] --&gt; K

      O4[&quot;Block&quot;]
    end

    subgraph immutable;
     subgraph &quot;Chunk 0&quot;;
        C0[&quot; &quot;]
        C1[&quot; &quot;] --&gt; C0
        C2[&quot; &quot;] --&gt;|...| C1
     end
     subgraph &quot;Chunk 1&quot;;
        D0[&quot; &quot;]
        D1[&quot; &quot;] --&gt; D0
        D2[&quot; &quot;] --&gt;|...| D1
     end

     D0 --&gt; C2
     subgraph &quot;Chunk n&quot;;
     Kp1[&quot;(k+1)-th Block&quot;] --&gt; Kp2[&quot;(k+2)-th Block&quot;]
     Kp2[&quot;(k+2)-th Block&quot;] --&gt; |...| E0[&quot; &quot;]
     end

     E0 --&gt;|...| D2
    end
    K --&gt; Kp1
    C0 --&gt; Genesis
    subgraph ledger;
     S[&quot;Persisted snapshot&quot;] --&gt; Kp1
    end
</pre>
<h2 id="immutable"><a class="header" href="#immutable"><code>immutable</code></a></h2>
<p>Contains the historical chain of blocks.</p>
<p>TODO explain NestedCtxt, Header, Block, the Hard Fork Block, chunks, primary and secondary indices.</p>
<h2 id="volatile"><a class="header" href="#volatile"><code>volatile</code></a></h2>
<p>Contains blocks that form the current selection of the node (i.e. the
best chain it knows about) and other blocks (both connected or
disconnected from the selected chain) but whose slot number is greater
than the <code>k</code>-th block in the current selection (so they only can
belong to the selection or a fork less than <code>k</code> blocks deep).</p>
<p>TODO describe the format in which the blocks are stored</p>
<h2 id="ledger"><a class="header" href="#ledger"><code>ledger</code></a></h2>
<p>Contains ledger state snapshots at immutable blocks. Ideally, this is the most
recent immutable block, but since snapshots are taken periodically (due to their
cost), it may be an older block. Snapshots are named after the slot number of
the block when they were taken.</p>
<p>The ledger state snapshots are composed of two parts: the UTxO set and
the rest of the LedgerState. The latter is stored as a CBOR-encoded
blob in the file <code>&lt;slotno&gt;/state</code>. The former however, depends on
which backend was being used by the node taking the snapshot:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Backend</th><th><slotno>/tables</th></tr></thead><tbody>
<tr><td style="text-align: left">V2InMemory</td><td>a file <code>tvar</code> containing the CBOR-encoded UTxO set</td></tr>
<tr><td style="text-align: left">V1LMDB</td><td>a file <code>data.mdb</code> of an LMDB database contianing the UTxO set</td></tr>
</tbody></table>
</div>
<p>There is also a file <code>&lt;slotno&gt;/meta</code> that contains a string
identifying the backend used, and a checksum of the stored files for
checking consistency and detect hardware corruptions.</p>
<p>Conversion among backends is also provided by <a href="https://github.com/IntersectMBO/ouroboros-consensus/tree/main/ouroboros-consensus-cardano/app/snapshot-converter.hs">the
<code>snapshot-converter</code>
tool</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="mempool"><a class="header" href="#mempool">Mempool</a></h1>
<p>In Cardano, for blocks to have useful data, they have to contain transactions,
which are codifications of operations on the Ledger state that only some
authorized actors can enact. Notice that such transactions are what makes up the
contents of the block. In one way, one could see the ledger as being able to
validate transactions, and by implication full blocks as those are mainly
collections of transactions.</p>
<p>The Mempool is the abstract component of the node that stores transactions which
are valid on top of the latest known Ledger State (the one at the tip of the
chain selected by <a href="mempool/../consensus/chainsel.html">Chain Selection</a> in the Consensus
layer). The validity of transactions is defined by the Ledger layer. Notice a
change in the selected chain should trigger a prompt revalidation of the pending
transactions to discard those that became invalid on the new selection.  Such
collection of valid transactions will be requested by the Consensus layer to
<a href="mempool/../consensus/forging.html">forge new blocks</a>.</p>
<p>Once a transaction has been included in some block, it cannot be a <em>pending
transaction</em> anymore, in fact from that point onwards it will be an <em>invalid
transaction</em>, as in Cardano every transaction consumes at least one UTxO, in
this case consumed by the instance of the transaction that was included in a
block.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Notice that a transaction might be considered valid in one peer, but invalid
in another peer which has selected a different chain. Even in the case both
peers have the same selection, the existence in the mempool (or lack thereof)
of some other specific transaction that creates (or consumes) the inputs for
this one could lead to different verdicts on each peer.</p>
</div>
<p>While only nodes that forge new blocks will use these transactions to create
blocks, non-block-producing nodes are still expected to diffuse transactions to
their peers. <strong>All participating nodes</strong> must be able to receive, validate, and
distribute transactions.</p>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>When a node is shut down, the implementation can choose what to do with the
pending transactions. The reference Haskell implementation discards them.
However, it is conceivable for a node to store on disk the pending
transactions from its mempool.</p>
</div>
<p>The <a href="mempool/../network/node-to-node/txsubmission2"><code>TxSubmission2</code></a> miniprotocol is the
one used to diffuse the pending transactions through the network.</p>
<p>To be able to diffuse transactions through <code>TxSubmission2</code> and to fulfill the
requirements of the Consensus layer, any mempool implementation has the
following requirements:</p>
<ul>
<li>Acquiring a snapshot of valid transactions for a newly forged block should be
as fast as possible, as it will delay all other steps in the diffusion of such
a block. This is required by the Consensus layer for <a href="mempool/../consensus/forging.html">forging
blocks</a>.</li>
<li>Cursor-like access to pending transactions. This is required by the
<code>TxSubmission2</code> protocol.</li>
<li>Re-validation on a new selected chain: it is useless to keep transactions that
are no longer valid in the mempool. This is an inherent requirement of the
mempool itself.</li>
</ul>
<p>Notice that <em>what</em> a transaction actually is defined by the Ledger layer and it
depends on the current era at the tip of the chain. The Ledger layer provides
mechanisms to translate transactions from older eras to more recent ones. The
original transaction is the one that will be forwarded to other peers, i.e. the
“translated” version of the transaction <em>is not sent</em> over the network.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>In order to prevent overusing resources, the Ledger places a limit on the
number of pending transactions it accepts on a single block, which should be
enforced by the mempool. Once this limit is reached, requests to add new
transactions will be rejected. This <em>back-pressure</em> mechanism is critically
important in periods of intense traffic to preserve the overall throughput of
the network.</p>
<p>This limit is not defined as a raw number of transactions but as a cap on
various metrics, currently transaction size in bytes, execution units in CPU
and Memory units.</p>
</div>
<h2 id="fairness"><a class="header" href="#fairness">Fairness</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: describe fairness and what should mempools do in this regard.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ledger-1"><a class="header" href="#ledger-1">Ledger</a></h1>
<p>Cardano uses the Extended Unspent Transaction Output (EUTxO) ledger model…</p>
<pre><code class="language-agda">data S
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ledger-rules"><a class="header" href="#ledger-rules">Ledger Rules</a></h1>
<p>This section details the ledger rules used in Cardano and, especially, some of the potential “foot guns” one could run into when implementing these rules. Those “foot guns” could be discrepencies between the specification and the ledger, some undefined behavior, or a bug that was fixed at some point, but is still relevant for syncing historical data.</p>
<p>It is an ongoing work in progress, being updated periodically in paralel with the work happening to build Amaru.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="witness-validation"><a class="header" href="#witness-validation">Witness Validation</a></h1>
<p>TODO: provide a description of the ledger rules relevant to this domain specific concept.</p>
<h2 id="footgun-1-bootstrap-witnesses"><a class="header" href="#footgun-1-bootstrap-witnesses">Footgun #1: Bootstrap Witnesses</a></h2>
<p>Alonzo introduced a <a href="https://github.com/IntersectMBO/cardano-ledger/blob/d71d7923a79cfcde8cac0b5db399a5427524d06a/eras/allegra/impl/cddl-files/allegra.cddl#L314-L319"><code>bootstrap_witness</code></a>, which is a different structure for witnesses from a bootstrap address. One would, perhaps reasonably, assume that all witnesses from bootstrap addresses would be provided in this list. However, that is not an assumption that can be made.</p>
<h3 id="example-0c22edee0ffd7c8f32d2fe4da1f144e9ef78dfb51e1678d5198493a83d6cf8ec"><a class="header" href="#example-0c22edee0ffd7c8f32d2fe4da1f144e9ef78dfb51e1678d5198493a83d6cf8ec">Example: <code>0c22edee0ffd7c8f32d2fe4da1f144e9ef78dfb51e1678d5198493a83d6cf8ec</code></a></h3>
<p>Consider the following <a href="https://preprod.cexplorer.io/tx/0c22edee0ffd7c8f32d2fe4da1f144e9ef78dfb51e1678d5198493a83d6cf8ec">transaction</a> on Preprod. In JSON, it looks like this:</p>
<pre><code class="language-json">{
  "id": "0c22edee0ffd7c8f32d2fe4da1f144e9ef78dfb51e1678d5198493a83d6cf8ec",
  "spends": "inputs",
  "inputs": [
    {
      "transaction": {
        "id": "4a0f0fd2ea2e91b34065e3085448b211afdcf72f9db0b2d74d1f99246e16c860"
      },
      "index": 1
    },
    {
      "transaction": {
        "id": "9157ee358b91c319a2e9dd087fe612d1c3d72d34fa4104bec13c8d37fd40b854"
      },
      "index": 1
    }
  ],
  "outputs": [
    {
      "address": "FHnt4NL7yPXtiYgxWx33wH6JXA9cYxzGAgVG1iMmaX9muBogARkHTRkUox4g4aR",
      "value": {
        "ada": {
          "lovelace": 4832251
        }
      }
    },
    {
      "address": "addr_test1vpfnhjud440uspylt4pewj7uy8tr0adh84sjqgmnq09xssca7lf4g",
      "value": {
        "ada": {
          "lovelace": 5000000
        }
      }
    }
  ],
  "fee": {
    "ada": {
      "lovelace": 167749
    }
  },
  "validityInterval": {},
  "treasury": {},
  "signatories": [
    {
      "key": "b1ef2a278ebe7cfd563c30f1bb642fb6b5616e040792527e6cd58f119895d657",
      "signature": "4110259fb4433f462512d6fa69958070f9e365831962744e7e2e7a2f6a721a707ec4f213ff736fcc195490254dc9d22e0fe0552ae1781b965fc4d05bd5ebb304"
    }
  ],
  "cbor": "84a300828258204a0f0fd2ea2e91b34065e3085448b211afdcf72f9db0b2d74d1f99246e16c860018258209157ee358b91c319a2e9dd087fe612d1c3d72d34fa4104bec13c8d37fd40b85401018282582e82d818582483581c533bcb8dad5fc8049f5d43974bdc21d637f5b73d6120237303ca6843a1024101001a63bbc5a61a0049bbfb82581d60533bcb8dad5fc8049f5d43974bdc21d637f5b73d6120237303ca68431a004c4b40021a00028f45a10081825820b1ef2a278ebe7cfd563c30f1bb642fb6b5616e040792527e6cd58f119895d65758404110259fb4433f462512d6fa69958070f9e365831962744e7e2e7a2f6a721a707ec4f213ff736fcc195490254dc9d22e0fe0552ae1781b965fc4d05bd5ebb304f5f6"
}
</code></pre>
<p>Notably, there is only one signature, and it is not in the form of a bootstrap witness. If we look at the logic that collects vkey hashes that must be present in the witness set (<a href="https://github.com/IntersectMBO/cardano-ledger/blob/d71d7923a79cfcde8cac0b5db399a5427524d06a/eras/shelley/impl/src/Cardano/Ledger/Shelley/UTxO.hs#L226-L249"><code>getShelleyWitsVkeyNeededNoGov</code></a>), we can understand why.</p>
<pre><code class="language-hs">inputAuthors :: Set (KeyHash 'Witness)
inputAuthors = foldr' accum Set.empty (txBody ^. spendableInputsTxBodyF)
  where
    accum txin !ans =
      case txinLookup txin utxo' of
        Just txOut -&gt;
          case txOut ^. addrTxOutL of
            Addr _ (KeyHashObj pay) _ -&gt; Set.insert (asWitness pay) ans
            AddrBootstrap bootAddr -&gt;
              Set.insert (asWitness (bootstrapKeyHash bootAddr)) ans
            _ -&gt; ans
        Nothing -&gt; ans
</code></pre>
<p>Bootstrap witnesses and vkey witnesses are combined in the same set, since they are both just hash digests of the same size. That means, if one were to construct a bootstrap address with a payload containing only the keyhash, the validation would pass with a regular vkey witness, instead of a bootstrap witness.</p>
<p>The witnesses themselves are valdiated in isolation–just that they are valid signatures on the required data–so the presence of a boostrap address does not necessarily require the presence of a bootstrap witness.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="transaction-fee"><a class="header" href="#transaction-fee">Transaction fee</a></h1>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>Ideally this would not exist in a vacuum and instead benefit from a general explanation on Cardano transactions.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This file is hand-written and currently not checked for correctness. The domain is very small and hence this would make for a great testing ground for techniques to ensure consistent, but also approachable documentation.</p>
</div>
<p>This is a write-up of how transaction fees are calculated. In fact, the minimum transaction fee for transaction to be deemed valid by the Cardano ledger.</p>
<p>This document describes the situation as of</p>
<ul>
<li>Protocol version: <code>10</code></li>
<li>Era: <code>Conway</code></li>
</ul>
<p>See also:</p>
<ul>
<li>Formal ledger specification: <a href="https://github.com/intersectmbo/cardano-ledger/releases/latest/download/alonzo-ledger.pdf">Alonzo, Figure 4, minfee</a> and <a href="https://intersectmbo.github.io/formal-ledger-specifications/conway-ledger.pdf#section.4">Conway, chapter 4</a></li>
<li>Haskell implementation: <a href="https://github.com/input-output-hk/cardano-ledger/blob/f0a0864eab00cd269befcdcd1931250dbb329f80/eras/conway/impl/src/Cardano/Ledger/Conway/UTxO.hs#L138">getConwayMinFeeTxUtxo</a> and releated functions</li>
</ul>
<h2 id="inputs"><a class="header" href="#inputs">Inputs</a></h2>
<ul>
<li>Transaction bytes, CBOR-encoded</li>
<li>Resolved inputs (= unspent outputs), CBOR-encoded</li>
<li>Protocol Parameters
<ul>
<li><code>minFeeConstant</code></li>
<li><code>minFeeCoefficient</code></li>
<li><code>minFeeReferenceScripts</code></li>
<li><code>prices.memory</code></li>
<li><code>prices.steps</code></li>
</ul>
</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Include transaction CDDL to reference individual parts (e.g. transaction_output)
TODO: Explain protocol parameters somewhere</p>
</div>
<h2 id="algorithm"><a class="header" href="#algorithm">Algorithm</a></h2>
<p>At a high level, the fee is composed of</p>
<ul>
<li>a minimum constant,</li>
<li>plus a cost per transaction byte,</li>
<li>plus a cost per reference script byte,</li>
<li>plus an execution cost per budgeted script redeemer.</li>
</ul>
<p>Calculate the base fee by adding the <code>minFeeConstant</code> to (<code>minFeeCoefficient</code> * serialized transaction length in bytes). These numbers are all integers, so you shouldn’t end up with a fractional amount of lovelace.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Explain resolving input and reference inputs</p>
</div>
<p>Next, calculate the untagged size of each <code>scriptRef</code> on each of the transaction inputs and reference inputs. Specifically, each <code>scriptRef</code> field is serialized as a cbor tag, an integer plutus version, and then the raw script bytes. We’re interested in the size of the raw script bytes only.</p>
<p>Next, calculate the reference script fee. First, sum up the length in bytes of each of script reference into <code>scriptRefLengths</code>. The <code>minFeeReferenceScripts</code> parameter consists of a <code>base</code>, a <code>multiplier</code>, and a <code>range</code>. (Note that in conway, the multiplier and the range are hard coded, rather than protocol parameters, but the intention is to change this at the next hardfork.)</p>
<p>To calculate the fee, starting from a <code>baseFee</code> of <code>minFeeReferenceScripts.base</code> and remaining bytes of <code>sum(scriptRefLengths)</code>, until remaining bytes is zero, add <code>baseFee * min(remainingBytes, minFeeReferenceScripts.range)</code>, scale <code>baseFee</code> by <code>minFeeReferenceScripts.multiplier</code>, and decrease <code>remainingBytes</code> by <code>min(remainingBytes, minFeeReferenceScripts.range)</code>. This calculation can result in rational values (as the multiplier can be rational), and so you should take the ceiling as a <em>last step</em>.</p>
<p>Finally, to calculate the evaluation fee, for each redeemer, multiply the redeemer execution units budget (memory and steps) by the corresponding protocol paramters (<code>prices.memory</code> and <code>prices.steps</code>), and add them up. These are fractional parameters, so you may end with a fractional amount of lovelace, and you should take the ceiling.</p>
<p>The final minimum fee is the base fee, plus the reference script fee, plus the evaluation fee.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>Lets do a decently complex worked example, from mainnet transaction with id (body hash)</p>
<p><code>f06e17af7b0085b44bcc13f76008202c69865795841c692875810bc92948d609</code></p>
<p>The transaction bytes are:</p>
<pre><code class="language-hex">84ac00838258209ea0d817dc67ce8046f6c2abc27267905c74374530c4684bb3c252ed6b97cc8702825820e3195e7888a83f3d1ef218e50675bfa10d9817a4a756b8ba26305f604c0f96e500825820285c77a9e62c0f87fedfcc91a630251ce2b7fcb9dd8d2fd8591c0d0aba46d4bc000183a300583911e0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312bbc10fe312acd69e2e12cbc2cca05aa0e432e3dee65d5a9498344e4aa01821b00000082deef6e00a2581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d114a1434941471b0000016f8a787b24581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312ba15820000de1406f79e3e55eef82b9d03cf62cc3d4a6d0d03b00bf7b1b43330f82977901028201d8185862d8799f581c6f79e3e55eef82b9d03cf62cc3d4a6d0d03b00bf7b1b43330f8297799f9f4040ff9f581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d11443494147ffff1b000000c823a3f15c18641864d87a80001a73c3be00ff8258390123a9f67af7e7e6d1aa0b495f68787649bb6f097d6648c2fa59c185e400168e1b0b38fe76f31427ee638adba1b7ad61ab8274ff4ecaa4109e821a001e8480a1581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d114a1434941471afad8cc9182581d618ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1a6079b955021a00092e4d031a08e498d705a1581df199e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe6100081a08e491070b5820b159feadc14235013a7ac8e993b410e5cdbd69c5829cd06b463603f15a39e6660d818258209ea0d817dc67ce8046f6c2abc27267905c74374530c4684bb3c252ed6b97cc87020e81581c8ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1082581d618ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1a60369c62111a004c4b401283825820fa46a1d162c59cece3308c5a9d4db9ff2ea17f9c0146ff821c9b445588b017c900825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2008258200258ec397cbd4a86951126bd2c423d62f71ec844430964cd0e14df2f951906a400a3008182582043be65bfb94286317d1274ff4c1d4890ddc524d04d1182c4c714e97e1985954858401a5d1672aed8d170f343c2d517d8475f3569df6e1db0741091a2fcc3aae92a520b9496e91a005544b8d1ae938525666ba732f8a88945fb8ba859f91b2636ee0706815901455901420100003323232323232322322253330053253330063370e900218039baa300130083754004264a66600e66e1d2000300837540022646600200264a66601266e1d2002300a3754002297adef6c6013756601c60166ea8004c8cc004004dd5980218059baa300e300b375400644a66601a0022980103d87a80001323232533300d3371e0166eb8c03800c4cdd2a4000660226e980052f5c026600a00a0046eacc038008c044008c03c004894ccc030004528099299980519b873371c6eb8c02cc03c00920024806852889980180180098078008b1929998050008a6103d87a800013374a9000198059806000a5eb80dd618059806180618041baa300b3008375400429408c02cc03000452613656375c002ae6955ceaab9e5573eae815d0aba24c011e581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312b00010583840000d87a9fd8799f000d9f9f02d87a8000ffffffff821a001024a21a13fcfa0f840002d8798082196ec71a007e3127840300d8798082199f5f1a00bc09d0f5f6
</code></pre>
<p>This is <code>1358</code> bytes and you can inspect it using <a href="https://cbor.nemo157.com/#type=hex&value=84ac00838258209ea0d817dc67ce8046f6c2abc27267905c74374530c4684bb3c252ed6b97cc8702825820e3195e7888a83f3d1ef218e50675bfa10d9817a4a756b8ba26305f604c0f96e500825820285c77a9e62c0f87fedfcc91a630251ce2b7fcb9dd8d2fd8591c0d0aba46d4bc000183a300583911e0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312bbc10fe312acd69e2e12cbc2cca05aa0e432e3dee65d5a9498344e4aa01821b00000082deef6e00a2581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d114a1434941471b0000016f8a787b24581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312ba15820000de1406f79e3e55eef82b9d03cf62cc3d4a6d0d03b00bf7b1b43330f82977901028201d8185862d8799f581c6f79e3e55eef82b9d03cf62cc3d4a6d0d03b00bf7b1b43330f8297799f9f4040ff9f581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d11443494147ffff1b000000c823a3f15c18641864d87a80001a73c3be00ff8258390123a9f67af7e7e6d1aa0b495f68787649bb6f097d6648c2fa59c185e400168e1b0b38fe76f31427ee638adba1b7ad61ab8274ff4ecaa4109e821a001e8480a1581c5d16cc1a177b5d9ba9cfa9793b07e60f1fb70fea1f8aef064415d114a1434941471afad8cc9182581d618ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1a6079b955021a00092e4d031a08e498d705a1581df199e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe6100081a08e491070b5820b159feadc14235013a7ac8e993b410e5cdbd69c5829cd06b463603f15a39e6660d818258209ea0d817dc67ce8046f6c2abc27267905c74374530c4684bb3c252ed6b97cc87020e81581c8ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1082581d618ca0e08cdbc30fa0dd21833d7370d666493ecc28b136df179f97fb5d1a60369c62111a004c4b401283825820fa46a1d162c59cece3308c5a9d4db9ff2ea17f9c0146ff821c9b445588b017c900825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2008258200258ec397cbd4a86951126bd2c423d62f71ec844430964cd0e14df2f951906a400a3008182582043be65bfb94286317d1274ff4c1d4890ddc524d04d1182c4c714e97e1985954858401a5d1672aed8d170f343c2d517d8475f3569df6e1db0741091a2fcc3aae92a520b9496e91a005544b8d1ae938525666ba732f8a88945fb8ba859f91b2636ee0706815901455901420100003323232323232322322253330053253330063370e900218039baa300130083754004264a66600e66e1d2000300837540022646600200264a66601266e1d2002300a3754002297adef6c6013756601c60166ea8004c8cc004004dd5980218059baa300e300b375400644a66601a0022980103d87a80001323232533300d3371e0166eb8c03800c4cdd2a4000660226e980052f5c026600a00a0046eacc038008c044008c03c004894ccc030004528099299980519b873371c6eb8c02cc03c00920024806852889980180180098078008b1929998050008a6103d87a800013374a9000198059806000a5eb80dd618059806180618041baa300b3008375400429408c02cc03000452613656375c002ae6955ceaab9e5573eae815d0aba24c011e581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312b00010583840000d87a9fd8799f000d9f9f02d87a8000ffffffff821a001024a21a13fcfa0f840002d8798082196ec71a007e3127840300d8798082199f5f1a00bc09d0f5f6%0A">https://cbor.nemo157.com/</a></p>
<p>Among the inputs and reference inputs, there are 2 inputs which, when resolved, contain reference scripts:</p>
<ul>
<li>reference input <code>f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2#0</code> with <code>2469</code> bytes</li>
<li>reference input <code>fa46a1d162c59cece3308c5a9d4db9ff2ea17f9c0146ff821c9b445588b017c9#0</code> with <code>15728</code> bytes</li>
</ul>
<p>And there are three redeemers:</p>
<ul>
<li>Spend#0 with a budget of <code>1057954</code> memory units, and <code>335346191</code> steps</li>
<li>Spend#2 with a budget of <code>28359</code> memory units, and <code>8270119</code> steps</li>
<li>Withdraw#0 with a budget of <code>40799</code> memory units, and <code>12323280</code> steps</li>
</ul>
<p>The protocol parameters at the time were:</p>
<ul>
<li><code>minFeeConstant</code>: <code>155381</code> lovelace</li>
<li><code>minFeeCoefficient</code>: <code>44</code> lovelace per byte</li>
<li><code>minFeeReferenceScripts</code>:
<ul>
<li><code>base</code>: <code>15</code> lovelace</li>
<li><code>multiplier</code>: <code>1.2</code></li>
<li><code>size increment</code>: <code>25600</code> bytes</li>
</ul>
</li>
<li><code>prices.memory</code>: <code>0.0577</code> lovelace per memory unit</li>
<li><code>prices.steps</code>: <code>0.0000721</code> lovelace per step</li>
</ul>
<p>Thus:</p>
<ul>
<li>The base fee is <code>155381 + 44 * 1358 = 215133</code> lovelace.</li>
<li>The total reference scripts length is <code>2469 + 15728 = 18197</code> and fall under the 25,600 byte increment, so it costs <code>15</code> lovelace per byte: <code>15 * min(18197, 25600) = 15 * 18197 = 272955</code> lovelace</li>
<li>And the execution costs are <code>ceil(1057954 * 0.0577 + 335346191 * 0.0000721 + 28359 * 0.0577 + 8270119 * 0.0000721 + 40799 * 0.0577 + 12323280 * 0.0000721) = ceil(90697.606839) = 90698</code> lovelace.</li>
</ul>
<p>Thus, the total minimum fee is <code>578786</code> lovelace.</p>
<p>Note that historically calculating this has been pretty opaque, and so many people have resorted to slightly padding the minimum fee, and I believe this is why the on-chain minimum fee (which is declared in the transaction body) is <code>601677</code> lovelace.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ledger-block-validation"><a class="header" href="#ledger-block-validation">Ledger: Block Validation</a></h1>
<p>Block validation is the process of applying a set of ledger rules to a candidate block before adding it to the blockchain and updating the state of the ledger.
Each <a href="ledger/../consensus/README.html#multi-era-considerations">era</a> has it’s own set of rules for block validation.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>TODO: Write a full introduction here with relevant terminology and concepts defined.</p>
</div>
<p>While different node implementations may implement these rules in different ways, it’s vital that they all agree on the outcome of the validation process to prevent forks in the blockchain.</p>
<h2 id="conway-block-validation"><a class="header" href="#conway-block-validation">Conway Block Validation</a></h2>
<p>In this section, we will walk through the <a href="https://github.com/IntersectMBO/cardano-ledger">cardano-ledger</a> implementation of Conway era block validation.
We will break up the validation process into smaller sections to make it easier to visualize and understand. All diagrams should be read from left to right and top to bottom in terms of order of execution.</p>
<p>The <a href="https://github.com/IntersectMBO/cardano-ledger">cardano-ledger</a> has the concept of an <em>EraRule</em>, which is a set of validations that are applied to a block in a specific era. Often, a newer era may call a previous era’s EraRule instead of reimplementing the same logic.</p>
<h3 id="erarule-bbody"><a class="header" href="#erarule-bbody">EraRule BBODY</a></h3>
<p>This is the “entrypoint” for block validation, responsible for validating the body of a block.</p>
<pre class="mermaid">flowchart LR
    EBBC[EraRule BBODY Conway]
        EBBC --&gt; CBBT[conwayBbodyTransition]
            CBBT --&gt; totalScriptRefSize(totalScriptRefSize &lt;= maxRefScriptSizePerBlock)
            CBBT --&gt; S[(state)]

        EBBC --&gt; ABBT[alonzoBbodyTransition]
            ABBT --&gt; ELC[EraRule LEDGERS Conway]
            ABBT --&gt; txTotalExUnits(txTotal &lt;= ppMax ExUnits)
            ABBT --&gt; BBodyState[(BbodyState @era ls')]
</pre>
<h3 id="erarule-ledgers"><a class="header" href="#erarule-ledgers">EraRule LEDGERS</a></h3>
<p>This EraRule is responsible for validating and updating the ledger state, namely UTxO state, governance state, and certificate state.</p>
<pre class="mermaid">flowchart LR
    ELC[EraRule LEDGERS Conway]
                    ELC --&gt; ELS[EraRule LEDGERS Shelley]
                    ELS --&gt; ledgersTransition
                        ledgersTransition --&gt; |repeat| ledgerTransition
                            ledgerTransition --&gt; |when mempool| EMC[EraRule Mempool Conway]
                                EMC --&gt; mempoolTransition
                                    mempoolTransition --&gt; unelectedCommitteeMembers(failOnNonEmpty unelectedCommitteeMembers)
                            ledgerTransition --&gt; isValid{isValid}
                                isValid --&gt; |True| ltDoBlock[do]
                                    ltDoBlock --&gt; |currentTreasuryValueTxBodyL| submittedTreasuryValue(submittedTreasuryValue == actualTreasuryValue)
                                    ltDoBlock --&gt; totalRefScriptSize(totalRefScriptSize &lt;= maxRefScriptSizePerTx)
                                    ltDoBlock  --&gt; nonExistentDelegations(failOnNonEmpty nonExistentDelegations)

                                    ltDoBlock --&gt; ECSC[EraRule CERTS Conway]
                                    ltDoBlock --&gt; EGC[EraRule GOV Conway]
                                    ltDoBlock --&gt; utxoState[(utxoState', certStateAfterCerts)]
                                isValid --&gt; |False| utxoStateCertState[(utxoState, certState)]
                            ledgerTransition --&gt; EUC[EraRule UTXOW Conway]
</pre>
<h3 id="erarule-certs"><a class="header" href="#erarule-certs">EraRule CERTS</a></h3>
<p>This EraRule is responsible for validating and updating the certificate state.</p>
<pre class="mermaid">flowchart LR
    ECSC --&gt; conwayCertsTransition
        conwayCertsTransition --&gt; certificates{isEmpty certificates}
        certificates --&gt; |True| cctDoBlock[do]
            cctDoBlock --&gt; validateZeroRewards(validateZeroRewards)
            cctDoBlock --&gt; certStateWithDrepExiryUpdated[(certStateWithDrepExiryUpdated)]

        certificates --&gt; |False| sizeCheck{size &gt; 1}
            sizeCheck --&gt; |True| conwayCertsTransition
            sizeCheck --&gt; |False| ECC[EraRule CERT Conway]
                ECC --&gt; certTransition
                certTransition --&gt; |ConwayTxCertDeleg| EDC[EraRule DELEG Conway]
                    EDC --&gt; conwayDelegTransition
                        conwayDelegTransition --&gt; |ConwayRegCert| crcDoBlock[do]
                            crcDoBlock --&gt; crcCheckDepositAgaintPParams(checkDespoitAgainstPParams)
                            crcDoBlock --&gt; crcCheckStakeKeyNotRegistered(checkStakeKeyNotRegistered)
                        conwayDelegTransition --&gt; |ConwayUnregCert| cucDoBlock[do]
                            cucDoBlock --&gt; checkInvalidRefund(checkInvalidRefund)
                            cucDoBlock --&gt; mUMElem(isJust mUMElem)
                            cucDoBlock --&gt; cucCheckStakeKeyHasZeroRewardBalance(checkStakeKeyHasZeroRewardBalance)
                        conwayDelegTransition --&gt; |ConwayDelegCert| cdcDoBlock[do]
                            cdcDoBlock --&gt; checkStakeKeyIsRegistered(checkStakeKeyIsRegistered)
                            cdcDoBlock --&gt; checkStakeDelegateeRegistered(checkStakeDelegateeRegistered)
                        conwayDelegTransition --&gt; |ConwayRegDelegCert| crdcDoBlock[do]
                            crdcDoBlock --&gt; checkDepositAgainstPParams(checkDepositAgainstPParams)
                            crdcDoBlock --&gt; checkStakeKeyNotRegistered(checkStakeKeyNotRegistered)
                            crdcDoBlock --&gt; checkStakeKeyZeroRewardBalance(checkStakeKeyHasZeroRewardBalance)
                certTransition --&gt; EPC[EraRule POOL Conway]
                    EPC --&gt; EPS[EraRule POOL Shelley]
                    EPS --&gt; poolDelegationTransition
                        poolDelegationTransition --&gt; |regPool| rpDoBlock[do]
                            rpDoBlock --&gt; actualNetId(actualNetId == suppliedNetId)
                            rpDoBlock --&gt; pmHash(length pmHash &lt;= sizeHash)
                            rpDoBlock --&gt; ppCost(ppCost &gt;= minPoolCost)
                            rpDoBlock --&gt; ppId{ppId ∉ dom psStakePoolParams}
                                ppId --&gt; |True| payPoolDeposit --&gt; psDeposits[(psDeposits)]
                                ppId --&gt; |False| psFutureStakePoolParams[(psFutureStakePoolParams, psRetiring)]
                        poolDelegationTransition --&gt; |RetirePool| retirePoolDoBlock[do]
                            retirePoolDoBlock --&gt; hk(hk ∈ dom psStakePoolParams)
                            retirePoolDoBlock --&gt; cEpoch(cEpoch &lt; e &amp;&amp; e &lt;= limitEpoch)
                            retirePoolDoBlock --&gt; psRetiring[(psRetiring)]
                certTransition --&gt; EGOVERTC[EraRule GOVERT Conway]
                    EGOVERTC --&gt; conwayGovCertTransition
                    conwayGovCertTransition --&gt; |ConwayRegDRep| crdrDoBlock[do]
                        crdrDoBlock --&gt; notMemberCredVsDReps(Map.notMember cred vsDReps)
                        crdrDoBlock --&gt; deposit(deposit == ppDRepDeposit)
                        crdrDoBlock --&gt; crdrDRepState[(dRepState)]
                    conwayGovCertTransition --&gt; |ConwayUnregDRep| curdrDoBlock[do]
                        curdrDoBlock --&gt; mDRepState(isJust mDRepState)
                        curdrDoBlock --&gt; drepRefundMismatch(failOnJust drepRefundMismatch)
                        curdrDoBlock --&gt; curdrDRepState[(dRepState)]
                    conwayGovCertTransition --&gt;|ConwayUpdateDRep| cudrDoBlock[do]
                        cudrDoBlock --&gt; memberCredVsDreps(Map.member cred vsDReps)
                        cudrDoBlock --&gt; cudrDRepState[(vsDReps)]
                    conwayGovCertTransition --&gt; |ConwayResignCommitteeColdKey| crcckDoBlock[do]
                    conwayGovCertTransition --&gt; |ConwayAuthCommitteeHotKey| cachkDoBlock[do]
                        crcckDoBlock --&gt; checkAndOverwriteCommitteMemberState
                        cachkDoBlock --&gt; checkAndOverwriteCommitteMemberState
                            checkAndOverwriteCommitteMemberState --&gt; coldCredResigned(failOnJust coldCredResigned)
                            checkAndOverwriteCommitteMemberState --&gt; isCurrentMember(isCurrentMember OR isPotentialFutureMember)
                            checkAndOverwriteCommitteMemberState --&gt; vsCommitteeState[(vsCommitteeState)]
</pre>
<h3 id="erarule-gov"><a class="header" href="#erarule-gov">EraRule GOV</a></h3>
<p>This EraRule is responsible for validating and updating the governance state.</p>
<pre class="mermaid">flowchart LR
    EGC[EraRule GOV Conway]
    EGC --&gt; govTransition
        govTransition --&gt; badHardFork(failOnJust badHardFork)
        govTransition --&gt; actionWellFormed(actionWellFormed)
        govTransition --&gt; refundAddress(refundAddress)
        govTransition --&gt; nonRegisteredAccounts(nonRegisteredAccounts)
        govTransition --&gt; pProcDepost(pProcDeposit == expectedDeposit)
        govTransition --&gt; pProcReturnAddr(pProcReturnAddr == expectedNetworkId)
        govTransition --&gt; govAction{case pProcGovAction}
            govAction --&gt; |TreasuryWithdrawals| twDoBlock[do]
                twDoBlock --&gt; mismatchedAccounts(mismatchedAccounts)
                twDoBlock --&gt; twCheckPolicy(checkPolicy)
            govAction --&gt; |UpdateCommittee| ucDoBlock[do]
                ucDoBlock --&gt; setNull(Set.null conflicting)
                ucDoBlock --&gt; mapNull(Map.null invalidMembers)
            govAction --&gt; |ParameterChange| pcDoBlock[do]
                pcDoBlock --&gt; checkPolicy(checkPolicy)
        govTransition --&gt; ancestryCheck(ancestryCheck)
        govTransition --&gt; unknownVoters(failOnNonEmpty unknownVoters)
        govTransition --&gt; unknwonGovActionIds(failOnNonEmpty unknownGovActionIds)
        govTransition --&gt; checkBootstrapVotes(checkBootstrapVotes)
        govTransition --&gt; checkVotesAreNotForExpiredActions(checkVotesAreNotForExpiredActions)
        govTransition --&gt; checkVotersAreValid(checkVotersAreValid)
        govTransition --&gt; updatedProposalStates[(updatedProposalStates)]
</pre>
<h3 id="erarule-utxow"><a class="header" href="#erarule-utxow">EraRule UTXOW</a></h3>
<p>This EraRule is responsible for validating and updating the UTxO state.</p>
<pre class="mermaid">flowchart LR
EUC[EraRule UTXOW Conway]
    EUC --&gt; babbageUtxowTransition
        babbageUtxowTransition --&gt; validateFailedBabbageScripts(validateFailedBabbageScripts)
        babbageUtxowTransition --&gt; babbageMissingScripts(babbageMissingScripts)
        babbageUtxowTransition --&gt; missingRequiredDatums(missingRequiredDatums)
        babbageUtxowTransition --&gt; hasExactSetOfRedeemers(hasExactSetOfRedeemers)
        babbageUtxowTransition --&gt; validateVerifiedWits(Shelley.validateVerifiedWits)
        babbageUtxowTransition --&gt; validateNeededWitnesses(validateNeededWitnesses)
        babbageUtxowTransition --&gt; validateMetdata(Shelley.validateMetadata)
        babbageUtxowTransition --&gt; validateScriptsWellFormed(validateScriptsWellFormed)
        babbageUtxowTransition --&gt; ppViewHashesMatch(ppViewHashesMatch)
        babbageUtxowTransition --&gt; EUTXOC[EraRule UTXO Conway]
            EUTXOC --&gt; utxoTransition
                utxoTransition --&gt; disjointRefInputs(disjointRefInputs)
                utxoTransition --&gt; validateOutsideValidityIntervalUtxo(Allegra.validateOutsideValidityIntervalUtxo)
                utxoTransition --&gt; validateOutsideForecast(Alonzo.validateOutsideForecast)
                utxoTransition --&gt; validateInputSetEmptyUTxO(Shelley.validateInputSetEmptyUTxO)
                utxoTransition --&gt; feesOk(feesOk)
                utxoTransition --&gt; validateBadInputsUTxO(Shelley.validateBadInputsUTxO)
                utxoTransition --&gt; validateValueNotConservedUTxO(Shelley.validateValueNotConservedUTxO)
                utxoTransition --&gt; validateOutputTooSmallUTxO(validateOutputTooSmallUTxO)
                utxoTransition --&gt; validateOutputTooBigUTxO(Alonzo.validateOutputTooBigUTxO)
                utxoTransition --&gt; validateOutputBootAddrAttrsTooBig(Shelley.validateOuputBootAddrAttrsTooBig)
                utxoTransition --&gt; validateWrongNetwork(Shelley.validateWrongNetwork)
                utxoTransition --&gt; validateWrongNetworkWithdrawal(Shelley.validateWrongNetworkWithdrawal)
                utxoTransition --&gt; validateWrongNetworkInTxBody(Alonzo.validateWrongNetworkInTxBody)
                utxoTransition --&gt; validateMaxTxSizeUTxO(Shelley.vallidateMaxTxSizeUTxO)
                utxoTransition --&gt; validateExUnitsTooBigUTxO(Alonzo.validateExUnitsTooBigUTxO)
                utxoTransition --&gt; validateTooManyCollateralInputs(Alonzo.validateTooManyCollateralInputs)
                utxoTransition --&gt; EUTXOSC[EraRule UTXOS Conway]
                    EUTXOSC --&gt; utxosTransition
                utxosTransition --&gt; isValidTxL{isValidTxL}
                    isValidTxL --&gt; |True| conwayEvalScriptsTxValid
                        conwayEvalScriptsTxValid --&gt; expectScriptsToPass(expactScriptsToPass)
                        conwayEvalScriptsTxValid --&gt; conwayEvalScriptsTxValidUtxosPrime[(utxos')]
                    isValidTxL --&gt; |False| babbageEvalScriptsTxInvalid
                        babbageEvalScriptsTxInvalid --&gt; evalPlutusScripts(evalPlutusScripts FAIL)
                        babbageEvalScriptsTxInvalid --&gt; babbageEvalScriptsTxInvalidUtxosPrime([utxos'])
    EUC --&gt; LedgerState[(LedgerState utxoState'' certStateAfterCERTS)]
</pre>
<h3 id="full-diagram"><a class="header" href="#full-diagram">Full Diagram</a></h3>
<p>Here is the full diagram, with all EraRules combined.</p>
<pre class="mermaid">flowchart LR
    EBBC[EraRule BBODY Conway]
        EBBC --&gt; CBBT[conwayBbodyTransition]
            CBBT --&gt; totalScriptRefSize(totalScriptRefSize &lt;= maxRefScriptSizePerBlock)
            CBBT --&gt; S[(state)]

        EBBC --&gt; ABBT[alonzoBbodyTransition]
            ABBT --&gt; ELC[EraRule LEDGERS Conway]
                ELC --&gt; ELS[EraRule LEDGERS Shelley]
                ELS --&gt; ledgersTransition
                    ledgersTransition --&gt; |repeat| ledgerTransition
                        ledgerTransition --&gt; |when mempool| EMC[EraRule Mempool Conway]
                            EMC --&gt; mempoolTransition
                                mempoolTransition --&gt; unelectedCommitteeMembers(failOnNonEmpty unelectedCommitteeMembers)
                        ledgerTransition --&gt; isValid{isValid}
                            isValid --&gt; |True| ltDoBlock[do]
                                ltDoBlock --&gt; |currentTreasuryValueTxBodyL| submittedTreasuryValue(submittedTreasuryValue == actualTreasuryValue)
                                ltDoBlock --&gt; totalRefScriptSize(totalRefScriptSize &lt;= maxRefScriptSizePerTx)
                                ltDoBlock  --&gt; nonExistentDelegations(failOnNonEmpty nonExistentDelegations)

                                ltDoBlock --&gt; ECSC[EraRule CERTS Conway]
                                ECSC --&gt; conwayCertsTransition
                                    conwayCertsTransition --&gt; certificates{isEmpty certificates}

                                    certificates --&gt; |True| cctDoBlock[do]
                                        cctDoBlock --&gt; validateZeroRewards(validateZeroRewards)
                                        cctDoBlock --&gt; certStateWithDrepExiryUpdated[(certStateWithDrepExiryUpdated)]

                                    certificates --&gt; |False| sizeCheck{size &gt; 1}
                                        sizeCheck --&gt; |True| conwayCertsTransition
                                        sizeCheck --&gt; |False| ECC[EraRule CERT Conway]
                                            ECC --&gt; certTransition
                                            certTransition --&gt; |ConwayTxCertDeleg| EDC[EraRule DELEG Conway]
                                                EDC --&gt; conwayDelegTransition
                                                    conwayDelegTransition --&gt; |ConwayRegCert| crcDoBlock[do]
                                                        crcDoBlock --&gt; crcCheckDepositAgaintPParams(checkDespoitAgainstPParams)
                                                        crcDoBlock --&gt; crcCheckStakeKeyNotRegistered(checkStakeKeyNotRegistered)
                                                    conwayDelegTransition --&gt; |ConwayUnregCert| cucDoBlock[do]
                                                        cucDoBlock --&gt; checkInvalidRefund(checkInvalidRefund)
                                                        cucDoBlock --&gt; mUMElem(isJust mUMElem)
                                                        cucDoBlock --&gt; cucCheckStakeKeyHasZeroRewardBalance(checkStakeKeyHasZeroRewardBalance)
                                                    conwayDelegTransition --&gt; |ConwayDelegCert| cdcDoBlock[do]
                                                        cdcDoBlock --&gt; checkStakeKeyIsRegistered(checkStakeKeyIsRegistered)
                                                        cdcDoBlock --&gt; checkStakeDelegateeRegistered(checkStakeDelegateeRegistered)
                                                    conwayDelegTransition --&gt; |ConwayRegDelegCert| crdcDoBlock[do]
                                                        crdcDoBlock --&gt; checkDepositAgainstPParams(checkDepositAgainstPParams)
                                                        crdcDoBlock --&gt; checkStakeKeyNotRegistered(checkStakeKeyNotRegistered)
                                                        crdcDoBlock --&gt; checkStakeKeyZeroRewardBalance(checkStakeKeyHasZeroRewardBalance)
                                            certTransition --&gt; EPC[EraRule POOL Conway]
                                                EPC --&gt; EPS[EraRule POOL Shelley]
                                                EPS --&gt; poolDelegationTransition
                                                    poolDelegationTransition --&gt; |regPool| rpDoBlock[do]
                                                        rpDoBlock --&gt; actualNetId(actualNetId == suppliedNetId)
                                                        rpDoBlock --&gt; pmHash(length pmHash &lt;= sizeHash)
                                                        rpDoBlock --&gt; ppCost(ppCost &gt;= minPoolCost)
                                                        rpDoBlock --&gt; ppId{ppId ∉ dom psStakePoolParams}

                                                        ppId --&gt; |True| payPoolDeposit --&gt; psDeposits[(psDeposits)]
                                                        ppId --&gt; |False| psFutureStakePoolParams[(psFutureStakePoolParams, psRetiring)]

                                                    poolDelegationTransition --&gt; |RetirePool| retirePoolDoBlock[do]
                                                        retirePoolDoBlock --&gt; hk(hk ∈ dom psStakePoolParams)
                                                        retirePoolDoBlock --&gt; cEpoch(cEpoch &lt; e &amp;&amp; e &lt;= limitEpoch)
                                                        retirePoolDoBlock --&gt; psRetiring[(psRetiring)]

                                            certTransition --&gt; EGOVERTC[EraRule GOVERT Conway]
                                                EGOVERTC --&gt; conwayGovCertTransition
                                                conwayGovCertTransition --&gt; |ConwayRegDRep| crdrDoBlock[do]
                                                    crdrDoBlock --&gt; notMemberCredVsDReps(Map.notMember cred vsDReps)
                                                    crdrDoBlock --&gt; deposit(deposit == ppDRepDeposit)
                                                    crdrDoBlock --&gt; crdrDRepState[(dRepState)]
                                                conwayGovCertTransition --&gt; |ConwayUnregDRep| curdrDoBlock[do]
                                                    curdrDoBlock --&gt; mDRepState(isJust mDRepState)
                                                    curdrDoBlock --&gt; drepRefundMismatch(failOnJust drepRefundMismatch)
                                                    curdrDoBlock --&gt; curdrDRepState[(dRepState)]
                                                conwayGovCertTransition --&gt;|ConwayUpdateDRep| cudrDoBlock[do]
                                                    cudrDoBlock --&gt; memberCredVsDreps(Map.member cred vsDReps)
                                                    cudrDoBlock --&gt; cudrDRepState[(vsDReps)]
                                                conwayGovCertTransition --&gt; |ConwayResignCommitteeColdKey| crcckDoBlock[do]
                                                conwayGovCertTransition --&gt; |ConwayAuthCommitteeHotKey| cachkDoBlock[do]
                                                    crcckDoBlock --&gt; checkAndOverwriteCommitteMemberState
                                                    cachkDoBlock --&gt; checkAndOverwriteCommitteMemberState
                                                        checkAndOverwriteCommitteMemberState --&gt; coldCredResigned(failOnJust coldCredResigned)
                                                        checkAndOverwriteCommitteMemberState --&gt; isCurrentMember(isCurrentMember OR isPotentialFutureMember)
                                                        checkAndOverwriteCommitteMemberState --&gt; vsCommitteeState[(vsCommitteeState)]
                                ltDoBlock --&gt; EGC[EraRule GOV Conway]
                                    EGC --&gt; govTransition
                                        govTransition --&gt; badHardFork(failOnJust badHardFork)
                                        govTransition --&gt; actionWellFormed(actionWellFormed)
                                        govTransition --&gt; refundAddress(refundAddress)
                                        govTransition --&gt; nonRegisteredAccounts(nonRegisteredAccounts)
                                        govTransition --&gt; pProcDepost(pProcDeposit == expectedDeposit)
                                        govTransition --&gt; pProcReturnAddr(pProcReturnAddr == expectedNetworkId)
                                        govTransition --&gt; govAction{case pProcGovAction}
                                            govAction --&gt; |TreasuryWithdrawals| twDoBlock[do]
                                                twDoBlock --&gt; mismatchedAccounts(mismatchedAccounts)
                                                twDoBlock --&gt; twCheckPolicy(checkPolicy)
                                            govAction --&gt; |UpdateCommittee| ucDoBlock[do]
                                                ucDoBlock --&gt; setNull(Set.null conflicting)
                                                ucDoBlock --&gt; mapNull(Map.null invalidMembers)
                                            govAction --&gt; |ParameterChange| pcDoBlock[do]
                                                pcDoBlock --&gt; checkPolicy(checkPolicy)
                                        govTransition --&gt; ancestryCheck(ancestryCheck)
                                        govTransition --&gt; unknownVoters(failOnNonEmpty unknownVoters)
                                        govTransition --&gt; unknwonGovActionIds(failOnNonEmpty unknownGovActionIds)
                                        govTransition --&gt; checkBootstrapVotes(checkBootstrapVotes)
                                        govTransition --&gt; checkVotesAreNotForExpiredActions(checkVotesAreNotForExpiredActions)
                                        govTransition --&gt; checkVotersAreValid(checkVotersAreValid)
                                        govTransition --&gt; updatedProposalStates[(updatedProposalStates)]
                                ltDoBlock --&gt; utxoState[(utxoState', certStateAfterCerts)]
                            isValid --&gt; |False| utxoStateCertState[(utxoState, certState)]
                        ledgerTransition --&gt; EUC[EraRule UTXOW Conway]
                            EUC --&gt; babbageUtxowTransition
                                babbageUtxowTransition --&gt; validateFailedBabbageScripts(validateFailedBabbageScripts)
                                babbageUtxowTransition --&gt; babbageMissingScripts(babbageMissingScripts)
                                babbageUtxowTransition --&gt; missingRequiredDatums(missingRequiredDatums)
                                babbageUtxowTransition --&gt; hasExactSetOfRedeemers(hasExactSetOfRedeemers)
                                babbageUtxowTransition --&gt; validateVerifiedWits(Shelley.validateVerifiedWits)
                                babbageUtxowTransition --&gt; validateNeededWitnesses(validateNeededWitnesses)
                                babbageUtxowTransition --&gt; validateMetdata(Shelley.validateMetadata)
                                babbageUtxowTransition --&gt; validateScriptsWellFormed(validateScriptsWellFormed)
                                babbageUtxowTransition --&gt; ppViewHashesMatch(ppViewHashesMatch)
                                babbageUtxowTransition --&gt; EUTXOC[EraRule UTXO Conway]
                                    EUTXOC --&gt; utxoTransition
                                        utxoTransition --&gt; disjointRefInputs(disjointRefInputs)
                                        utxoTransition --&gt; validateOutsideValidityIntervalUtxo(Allegra.validateOutsideValidityIntervalUtxo)
                                        utxoTransition --&gt; validateOutsideForecast(Alonzo.validateOutsideForecast)
                                        utxoTransition --&gt; validateInputSetEmptyUTxO(Shelley.validateInputSetEmptyUTxO)
                                        utxoTransition --&gt; feesOk(feesOk)
                                        utxoTransition --&gt; validateBadInputsUTxO(Shelley.validateBadInputsUTxO)
                                        utxoTransition --&gt; validateValueNotConservedUTxO(Shelley.validateValueNotConservedUTxO)
                                        utxoTransition --&gt; validateOutputTooSmallUTxO(validateOutputTooSmallUTxO)
                                        utxoTransition --&gt; validateOutputTooBigUTxO(Alonzo.validateOutputTooBigUTxO)
                                        utxoTransition --&gt; validateOutputBootAddrAttrsTooBig(Shelley.validateOuputBootAddrAttrsTooBig)
                                        utxoTransition --&gt; validateWrongNetwork(Shelley.validateWrongNetwork)
                                        utxoTransition --&gt; validateWrongNetworkWithdrawal(Shelley.validateWrongNetworkWithdrawal)
                                        utxoTransition --&gt; validateWrongNetworkInTxBody(Alonzo.validateWrongNetworkInTxBody)
                                        utxoTransition --&gt; validateMaxTxSizeUTxO(Shelley.vallidateMaxTxSizeUTxO)
                                        utxoTransition --&gt; validateExUnitsTooBigUTxO(Alonzo.validateExUnitsTooBigUTxO)
                                        utxoTransition --&gt; validateTooManyCollateralInputs(Alonzo.validateTooManyCollateralInputs)
                                        utxoTransition --&gt; EUTXOSC[EraRule UTXOS Conway]
                                            EUTXOSC --&gt; utxosTransition
                                                utxosTransition --&gt; isValidTxL{isValidTxL}
                                                    isValidTxL --&gt; |True| conwayEvalScriptsTxValid
                                                        conwayEvalScriptsTxValid --&gt; expectScriptsToPass(expactScriptsToPass)
                                                        conwayEvalScriptsTxValid --&gt; conwayEvalScriptsTxValidUtxosPrime[(utxos')]
                                                    isValidTxL --&gt; |False| babbageEvalScriptsTxInvalid
                                                        babbageEvalScriptsTxInvalid --&gt; evalPlutusScripts(evalPlutusScripts FAIL)
                                                        babbageEvalScriptsTxInvalid --&gt; babbageEvalScriptsTxInvalidUtxosPrime([utxos'])
                            EUC --&gt; LedgerState[(LedgerState utxoState'' certStateAfterCERTS)]
            ABBT --&gt; txTotalExUnits(txTotal &lt;= ppMax ExUnits)
            ABBT --&gt; BBodyState[(BbodyState @era ls')]
</pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ledger-cddl-specs"><a class="header" href="#ledger-cddl-specs">Ledger CDDL specs</a></h1>
<p><code>cardano-ledger</code> provides CDDLs in their haskell packages, in the
<code>eras/&lt;era&gt;/impl/cddl-files/&lt;era&gt;.cddl</code>. These are self-contained for each
era. In our CDDL specs in the blueprint we will import them qualified via <code>cddlc</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="plutus"><a class="header" href="#plutus">Plutus</a></h1>
<p>Plutus is Cardano’s on-chain smart contract platform.
Smart contracts can be written in a variety of languages, and compiled down to Untyped Plutus Core (UPLC), which is executed by validating nodes.
UPLC is a small functional language based on untyped lambda calculus.</p>
<p>Untyped lambda calculus is Turing-complete, and hence is in theory capable of performing any computation; however for efficiency reasons, UPLC includes an extensible collection of built-in types and functions.
UPLC is executed by a CEK machine.
A production implementation should be carefully engineered to maximize performance and support accurate tracking of execution costs.</p>
<p>The CEK machine tracks CPU and memory usage via a cost model.
There are two kinds of cost: each step the CEK machine takes (e.g., looking up a variable or processing a lambda abstraction) incurs a fixed charge; each call to a built- in function incurs a cost calculated by a costing function - a Haskell function that estimates resource usage based on the sizes of the arguments.
These are derived empirically by benchmarking the implementation with representative inputs, then using the R statistical system to fit models (e.g., 𝛼 + 𝛽𝑥𝑦 for integer multiplication, where 𝑥 and 𝑦 are the numbers of machine words required to store the arguments).
These functions are used for deterministic and efficient costing for script execution.</p>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li>
<p><a href="https://plutus.cardano.intersectmbo.org/docs/">Plinth User Guide</a>: This up-to-date guide not only covers Plinth (a Haskell-based surface language) and its compilation to UPLC, but also explains many core concepts.
If you are relatively new to this space, start with this guide, and follow the “Essential concepts” and “Glossary” sections.</p>
</li>
<li>
<p><a href="https://plutus.cardano.intersectmbo.org/resources/plutus-core-spec.pdf">Plutus Core Specification</a>: Studying the spec ensures your own implementation adheres to the exact language rules.
The specification is periodically updated as new primitives and features are added to the language.
This blueprint covers the portion of the specification relevant to CEK machine implementation, presented in a more approachable and readable format.</p>
</li>
<li>
<p>Haskell implementation: The plutus repository contains a highly optimized Haskell implementation of the CEK machine, used in the Haskell node.
You can find the Haddock <a href="https://plutus.cardano.intersectmbo.org/haddock/latest/plutus-core/UntypedPlutusCore-Evaluation-Machine-Cek.html">here</a>.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/CEK_Machine">CEK machine Wikipedia page</a>.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="syntax"><a class="header" href="#syntax">Syntax</a></h1>
<p>The following listing shows the concrete syntax of Plutus.
The corresponding Haskell definition can be found in <a href="https://plutus.cardano.intersectmbo.org/haddock/latest/plutus-core/UntypedPlutusCore-Core-Type.html#t:Term">UntypedPlutusCore.Core.Type</a>.</p>
<pre><code class="language-text">𝐿, 𝑀, 𝑁 ∈ Term ::= 𝑥              variable
                  | (con T 𝑐)      constant 𝑐 with type T
                  | (builtin 𝑏)    built-in
                  | (lam 𝑥 𝑀)     lambda abstraction
                  | [𝑀 𝑁]         application
                  | (delay 𝑀)     delayed execution of a term
                  | (force 𝑀)     force execution of a term
                  | (constr 𝑘 𝑀₁ … 𝑀ₘ)  constructor with tag 𝑘 and 𝑚 arguments (𝑚 ≥ 0).
                                           Available since 1.1.0
                  | (case 𝑀 𝑁₁ … 𝑁ₘ)    case analysis with 𝑚 alternatives (𝑚 ≥ 0).
                                           Available since 1.1.0
                  | (error)        error

𝑃 ∈ Program ::= (program 𝑣 𝑀)  versioned program
</code></pre>
<p>Plutus (Untyped Plutus Core) is untyped in the sense that variables don’t have type tags.
Constants, however, do carry type tags.
A constant must be of a built-in type.
Built-in types and functions are listed in <a href="plutus/./builtin.html">Built-in Types and Functions</a>.</p>
<h2 id="version-numbers"><a class="header" href="#version-numbers">Version Numbers</a></h2>
<p>The 𝑣 in a program is the <em>Plutus Core language version</em>, in the form of <code>x.y.z</code>.
This is distinct from the Plutus ledger language version.
For a detailed explanation, see <a href="https://plutus.cardano.intersectmbo.org/docs/essential-concepts/versions">Different Notions of Version</a>.</p>
<h2 id="iterated-applications"><a class="header" href="#iterated-applications">Iterated Applications</a></h2>
<p>An application of a term 𝑀 to a term 𝑁 is represented by <code>[𝑀 𝑁]</code>.
We may occasionally write <code>[𝑀 𝑁₁ … 𝑁ₖ]</code> or <code>[𝑀 𝑁]</code> as an abbreviation for an iterated application <code>[ … [[𝑀 𝑁₁] 𝑁₂] … 𝑁ₖ]</code>.</p>
<h2 id="constructor-tags"><a class="header" href="#constructor-tags">Constructor Tags</a></h2>
<p>Constructor tags can in principle be any natural number.
In practice, since they cannot be dynamically constructed, we can limit them to a fixed size without having to worry about overflow.
So we limit them to 64 bits, although this is currently only enforced in the binary format.
The Haskell definition uses <code>Word64</code> for the tag.</p>
<h2 id="de-bruijn-indices"><a class="header" href="#de-bruijn-indices">de Bruijn Indices</a></h2>
<p>Variable <code>𝑥</code> in the above listing can be either textual strings or de Bruijn indices.
De Bruijn indices are used in serialized scripts.
It therefore makes the most sense for a CEK machine implementation to use de Bruijn indices.</p>
<p>When using de Bruijn indices, the binder <code>𝑥</code> in <code>(lam 𝑥 𝑀)</code> is irrelevant, and any number can be used.
0 is a good choice since it is not a valid de Bruijn index.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="built-in-types-and-functions"><a class="header" href="#built-in-types-and-functions">Built-in Types and Functions</a></h1>
<h2 id="built-in-types"><a class="header" href="#built-in-types">Built-in Types</a></h2>
<p>The listing below defines the built-in types in UPLC.</p>
<pre><code class="language-text">a ∈ Atomic type ::= integer
                  | bytestring
                  | string
                  | bool
                  | unit
                  | data
                  | 𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟷_𝚎𝚕𝚎𝚖𝚎𝚗𝚝
                  | 𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟸_𝚎𝚕𝚎𝚖𝚎𝚗𝚝
                  | 𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝚖𝚕𝚛𝚎𝚜𝚞𝚕𝚝

T ∈ Built-in type ::= a
                    | list(T)
                    | pair(T, T)
</code></pre>
<p>The following table shows the values and concrete syntaxes of the types and type operators:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Type 𝑇</th><th style="text-align: left">Value</th><th style="text-align: left">Concrete Syntax 𝐂(𝑇)</th></tr></thead><tbody>
<tr><td style="text-align: left">integer</td><td style="text-align: left"><code>ℤ</code></td><td style="text-align: left"><code>-?[0-9]+</code></td></tr>
<tr><td style="text-align: left">bytestring</td><td style="text-align: left">the set of sequences of bytes or 8-bit characters</td><td style="text-align: left"><code>#([0-9A-Fa-f][0-9A-Fa-f])*</code></td></tr>
<tr><td style="text-align: left">string</td><td style="text-align: left">the set of sequences of Unicode characters</td><td style="text-align: left">see below</td></tr>
<tr><td style="text-align: left">bool</td><td style="text-align: left"><code>{true, false}</code></td><td style="text-align: left"><code>True | False</code></td></tr>
<tr><td style="text-align: left">unit</td><td style="text-align: left"><code>{()}</code></td><td style="text-align: left"><code>()</code></td></tr>
<tr><td style="text-align: left">data</td><td style="text-align: left">see below</td><td style="text-align: left">see below</td></tr>
<tr><td style="text-align: left">𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟷_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</td><td style="text-align: left"><code>𝐺₁</code></td><td style="text-align: left"><code>0x[0-9A-Fa-f]{96}</code> (see below)</td></tr>
<tr><td style="text-align: left">𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟸_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</td><td style="text-align: left"><code>𝐺₂</code></td><td style="text-align: left"><code>0x[0-9A-Fa-f]{192}</code> (see below)</td></tr>
<tr><td style="text-align: left">𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝚖𝚕𝚛𝚎𝚜𝚞𝚕𝚝</td><td style="text-align: left"><code>𝐻</code></td><td style="text-align: left">see below</td></tr>
</tbody></table>
</div>
<p>For the definitions of <code>𝐺₁</code>, <code>𝐺₂</code> and <code>𝐻</code>, refer to the <a href="https://plutus.cardano.intersectmbo.org/resources/plutus-core-spec.pdf">Plutus Core Spec</a>.</p>
<p>In the following, we use <code>𝑐(𝑇) ∈ 𝐂(𝑇)</code> to denote a valid representation of a constant of type 𝑇.</p>
<h3 id="concrete-syntax-for-strings"><a class="header" href="#concrete-syntax-for-strings">Concrete Syntax for Strings</a></h3>
<p>Strings are represented as sequences of Unicode characters enclosed in
double quotes, and may include standard escape sequences.
Surrogate characters in the range <code>U+D800</code> - <code>U+DFFF</code> are replaced with the Unicode replacement character <code>U+FFFD</code>.</p>
<h3 id="concrete-syntax-for-lists-and-pairs"><a class="header" href="#concrete-syntax-for-lists-and-pairs">Concrete Syntax for Lists and Pairs</a></h3>
<p>A list of type <code>list(𝑡)</code> is written as a syntactic list <code>[𝑐₁, … ,𝑐ₙ]</code>, where each <code>𝑐ᵢ ∈ 𝐂(𝑡)</code>.</p>
<p>A pair of type <code>pair(𝑡₁, 𝑡₂)</code> is written as a syntactic pair <code>(𝑐₁, 𝑐₂)</code> where <code>𝑐₁ ∈ 𝐂(𝑡₁)</code> and <code>𝑐₂ ∈ 𝐂(𝑡₂)</code>.</p>
<p>Some valid constant expressions are:</p>
<ul>
<li><code>(con (list integer) [11, 22, 33])</code></li>
<li><code>(con (pair bool string) (True, "Plutus"))</code></li>
<li><code>(con (list (pair bool (list bytestring))) [(True, []), (False, [#,#1F]), (True, [#123456, #AB, #ef2804])])</code></li>
</ul>
<h3 id="the-data-type"><a class="header" href="#the-data-type">The <code>data</code> Type</a></h3>
<p>We provide a built-in type, <code>data</code>, which permits the encoding of simple data structures
for use as arguments to Plutus Core scripts.
The Haskell definition of <code>data</code> can be found in <a href="https://plutus.cardano.intersectmbo.org/haddock/latest/plutus-core/PlutusCore-Data.html#t:Data">PlutusCore.Data</a>.</p>
<h3 id="concrete-syntax-for-data"><a class="header" href="#concrete-syntax-for-data">Concrete Syntax for <code>data</code></a></h3>
<p>The concrete syntax for 𝚍𝚊𝚝𝚊 is given by</p>
<pre><code class="language-text">𝑐(𝚍𝚊𝚝𝚊) ∶∶= (Constr 𝑐(𝚒𝚗𝚝𝚎𝚐𝚎𝚛) 𝑐(𝚕𝚒𝚜𝚝(𝚍𝚊𝚝𝚊)))
          | (Map 𝑐(𝚕𝚒𝚜𝚝(𝚙𝚊𝚒𝚛(𝚍𝚊𝚝𝚊,𝚍𝚊𝚝𝚊))))
          | (List 𝑐(𝚕𝚒𝚜𝚝(𝚍𝚊𝚝𝚊)))
          | (I 𝑐(𝚒𝚗𝚝𝚎𝚐𝚎𝚛))
          | (B 𝑐(𝚋𝚢𝚝𝚎𝚜𝚝𝚛𝚒𝚗𝚐)).
</code></pre>
<p>Some valid data constants are:</p>
<ul>
<li><code>(con data (Constr 1 [(I 2), (B #), (Map [])]))</code></li>
<li><code>(con data (Map [((I 0), (B #00)), ((I 1), (B #0F))]))</code></li>
<li><code>(con data (List [(I 0), (I 1), (B #7FFF), (List []])))</code></li>
<li><code>(con data (I -22))</code></li>
<li><code>(con data (B #001A))</code></li>
</ul>
<h3 id="concrete-syntax-for-bls12-381-types"><a class="header" href="#concrete-syntax-for-bls12-381-types">Concrete syntax for BLS12-381 Types</a></h3>
<p>The concrete syntaxes for <code>𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟷_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</code> and <code>𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟸_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</code> are provided only for use in textual Plutus Core programs, for example for experimentation and testing.
We do not support constants of any of the BLS12-381 types in serialised programs.</p>
<p>If you need to put <code>𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟷_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</code> and <code>𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝙶𝟸_𝚎𝚕𝚎𝚖𝚎𝚗𝚝</code> in your script, you can instead use the appropriate uncompression function on a bytestring constant.</p>
<p>No concrete syntax is provided for values of type <code>𝚋𝚕𝚜𝟷𝟸_𝟹𝟾𝟷_𝚖𝚕𝚛𝚎𝚜𝚞𝚕𝚝</code>.
It is not possible to parse such values, and they will appear as <code>(con bls12_381_mlresult &lt;opaque&gt;)</code> if output by a program.</p>
<h2 id="built-in-functions"><a class="header" href="#built-in-functions">Built-in Functions</a></h2>
<p>Plutus includes a set of built-in functions.
Like in Haskell, these can be polymorphic, accepting both type and term arguments.
However, Plutus distinguishes between two kinds of type arguments:</p>
<ul>
<li>A built-in-polymorphic type argument (denoted as <code>𝑎#</code>, <code>𝑏#</code> etc. in the spec) is limited to built-in types.</li>
<li>A fully-polymorphic type argument (denoted as <code>∗</code> in the spec) represents arbitrary terms.</li>
</ul>
<p><code>∗</code> can not be used as an argument to a type operator.
For instance, <code>list(∗)</code> is not allowed, whereas <code>list(𝑎#)</code> and <code>pair(𝑎#, integer)</code> are valid.</p>
<p>A term argument of type <code>∗</code> can be any UPLC term.
Multiple arguments of type <code>∗</code> are independent and need not be related.
All other term arguments must be UPLC constants of the appropriate types.
For example, an argument of type <code>pair(𝑎#, 𝑎#)</code> must be a pair constant, where both components are constants of the same built-in type.</p>
<p>A built-in function returns an application consisting of a head and zero or more arguments.
Most built-in functions returns a single value, which corresponds to an application with zero argument.
Each of the head and the arguments may be either a UPLC constant, or of type <code>∗</code>.
If it is of type <code>∗</code>, it must be one of the arguments passed to the built-in function, unmodified.</p>
<p>Take built-in function <code>ifThenElse</code> as an example.
It has signature <code>[∀∗, 𝚋𝚘𝚘𝚕, ∗, ∗] → ∗</code>.
Thus it takes three term arguments: a <code>bool</code> constant, followed by two arbitrary terms.
Since its return type is <code>∗</code>, the result must be either the second argument or the third argument.</p>
<p>As another example, built-in function <code>mkCons</code> has signature <code>[∀𝑎#, 𝑎#, 𝚕𝚒𝚜𝚝(𝑎#)] → 𝚕𝚒𝚜𝚝(𝑎#)</code>, indicating that it takes a constant of some type, and a list constant whose elements are of the same type.
The result is a list constant of the same element type.</p>
<p>Type arguments are not passed explicitly when calling a built-in function.
In UPLC, type instantiation is achieved via the <code>force</code> construct.</p>
<p>Because introducing built-in functions requires a hard fork, each built-in function is introduced in a specific major protocol version.
For example, <code>integerToByteString</code> was introduced in major protocol version 9 (following the Chang hard fork).
Moreover, not all built-in functions are available in every Plutus ledger language version (Plutus V1, V2, V3).
Scripts using an unavailable built-in function will be rejected by the Cardano node.
More details will be provided in Script Deserialization and Execution.</p>
<p>For the full list of UPLC built-in functions, their signatures, semantics, and supported Plutus ledger language versions and protocol versions, refer to the <a href="https://plutus.cardano.intersectmbo.org/resources/plutus-core-spec.pdf">Plutus Core Spec</a>, Section 4.3 (Built-in types and functions).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="the-cek-machine"><a class="header" href="#the-cek-machine">The CEK Machine</a></h1>
<p>This page presents the operational semantics of the Plutus language using an abstract machine - a <a href="https://en.wikipedia.org/wiki/CEK_Machine">CEK machine</a>.
Although more complex than traditional reduction semantics, the CEK machine offers an efficient evaluation strategy that enables precise modeling of resource usage and cost.
The production Haskell evaluator is based on the CEK machine, and it also provides a practical foundation for alternative implementations.</p>
<p>The following listing defines some key concepts of the CEK machine.</p>
<pre><code class="language-text">Σ ∈ State ::= 𝑠; 𝜌 ⊳ 𝑀   Computing M under environment 𝜌 with stack 𝑠
            | 𝑠 ⊲ 𝑉       Returning a value 𝑉 to stack 𝑠
            | ⬥          Throwing an error
            | ◻𝑉        Final state with result 𝑉

𝑠 ∈ Stack ::= 𝑓*  // A stack has zero or more stack frames

𝑉 ∈ CEK value ::= 〈con T 𝑐〉         A constant 𝑐 with type T
                | 〈delay 𝑀 𝜌〉       A delayed computation, with an
                                    associated environment
                | 〈lam 𝑥 𝑀 𝜌〉       A lambda abstraction, with an
                                    associated environment
                | 〈constr 𝑖 𝑉*〉      A constructor application, where
                                    all arguments are values
                | 〈builtin 𝑏 𝑉* 𝜂〉  A builtin application with all supplied
                                    arguments as values, and expecting
                                    at least one more argument

𝜌 ∈ Environment ::= []        An empty environment
                  | 𝜌[𝑥 ↦ 𝑉]  Associate 𝑥 with 𝑉 in the environment

𝜂 ∈ Expected builtin arguments ::= [𝜄]  // One argument
                                 | 𝜄⋅𝜂  // Two or more arguments

𝑓 ∈ Frame ::= (force _)    Awaiting a delayed computation to be forced
            | [_ (𝑀, 𝜌)]  An application awaiting the function, where the
                           argument is a term associated with an environment
            | [_ 𝑉]        An application awaiting the function, where the
                           argument is a value
            | [𝑉 _]        An application awaiting the argument, where the
                           function is a value
            | (constr 𝑖 𝑉* _ (𝑀*, 𝜌))  A constructor application awaiting
                                       an argument. The arguments before the hole
                                       are values, and the arguments after
                                       are terms to be evaluated.
            | (case _ (𝑀*, 𝜌))         A case expression awaiting the scrutinee
</code></pre>
<p>The CEK machine has two main kinds of states:</p>
<ul>
<li><code>𝑠; 𝜌 ⊳ 𝑀</code> denotes evaluating term <code>𝑀</code> with environment <code>𝜌</code> and stack <code>𝑠</code>.</li>
<li><code>𝑠 ⊲ 𝑉</code> denotes returning a value <code>𝑉</code> to stack <code>𝑠</code>.</li>
</ul>
<p>A value is a fully evaluated term, plus environments necessary for further computation.
An environment is a map binding variables to values.
A stack frame contains a hole to represent a pending value, and the context needed to continue evaluation once the value is received.
A builtin argument <code>𝜄</code> is either a term or a type argument.</p>
<p>To evaluate a Plutus program containing a term <code>𝑀</code>, the machine starts from state <code>[]; [] ⊳ 𝑀</code>, and based on the following transition table, proceeds as follows:</p>
<ul>
<li>If the current CEK machine state matches the From State, and the associated condition (if exists) is met, then the CEK machine transitions into the To State.</li>
<li>If the machine arrives at state <code>◻𝑉</code>, the machine terminates with success, yielding the Plutus term corresponding to <code>𝑉</code> (which is essentially <code>𝑉</code> but with the environments removed) as final result.</li>
<li>If the machine gets stuck (i.e., no rule applies) or arrives at state <code>⬥</code>, the evaluation terminates with a failure.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Rule</th><th style="text-align: left">From State</th><th style="text-align: left">To State</th><th style="text-align: left">Condition</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ 𝑥</code></td><td style="text-align: left"><code>𝑠 ⊲ 𝜌[𝑥]</code></td><td style="text-align: left">𝑥 is bound in 𝜌</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (con T 𝑐)</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈con T 𝑐〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (lam 𝑥 𝑀)</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈lam 𝑥 𝑀 𝜌〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (delay 𝑀)</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈delay 𝑀 𝜌〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (force 𝑀)</code></td><td style="text-align: left"><code>(force _)⋅𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ [𝑀 𝑁]</code></td><td style="text-align: left"><code>[_ (𝑁, 𝜌)]⋅𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (constr 𝑖 𝑀⋅𝑀*)</code></td><td style="text-align: left"><code>(constr 𝑖 _ (𝑀*, 𝜌))⋅𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (constr 𝑖 [])</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈constr 𝑖 []〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">9</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (case 𝑁 𝑀*)</code></td><td style="text-align: left"><code>(case _ (𝑀*, 𝜌))⋅𝑠; 𝜌 ⊳ 𝑁</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">10</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (builtin 𝑏)</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈builtin 𝑏 [] 𝛼(𝑏)〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">11</td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ (error)</code></td><td style="text-align: left"><code>⬥</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">12</td><td style="text-align: left"><code>[] ⊲ 𝑉</code></td><td style="text-align: left"><code>◻𝑉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">13</td><td style="text-align: left"><code>[_ (𝑀, 𝜌)]⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>[𝑉 _]⋅𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">14</td><td style="text-align: left"><code>[〈lam 𝑥 𝑀 𝜌〉 _]⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>𝑠; 𝜌[𝑥 ↦ 𝑉] ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">15</td><td style="text-align: left"><code>[_ 𝑉]⋅𝑠 ⊲ 〈lam 𝑥 𝑀 𝜌〉</code></td><td style="text-align: left"><code>𝑠; 𝜌[𝑥 ↦ 𝑉] ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">16</td><td style="text-align: left"><code>[〈builtin 𝑏 𝑉* (𝜄⋅𝜂)〉 _]⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈builtin 𝑏 (𝑉⋅𝑉*) 𝜂〉</code></td><td style="text-align: left"><code>𝜄</code> is a term argument</td></tr>
<tr><td style="text-align: center">17</td><td style="text-align: left"><code>[_ 𝑉]⋅𝑠 ⊲ 〈builtin 𝑏 𝑉* (𝜄⋅𝜂)〉</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈builtin 𝑏 (𝑉⋅𝑉*) 𝜂〉</code></td><td style="text-align: left"><code>𝜄</code> is a term argument</td></tr>
<tr><td style="text-align: center">18</td><td style="text-align: left"><code>[〈builtin 𝑏 𝑉* [𝜄]〉 _]⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪 (𝑠, 𝑏, 𝑉*⋅𝑉)</code></td><td style="text-align: left"><code>𝜄</code> is a term argument</td></tr>
<tr><td style="text-align: center">19</td><td style="text-align: left"><code>[_ 𝑉]⋅𝑠 ⊲ 〈builtin 𝑏 𝑉* [𝜄]〉</code></td><td style="text-align: left"><code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪 (𝑠, 𝑏, 𝑉*⋅𝑉)</code></td><td style="text-align: left"><code>𝜄</code> is a term argument</td></tr>
<tr><td style="text-align: center">20</td><td style="text-align: left"><code>(force _)⋅𝑠 ⊲ 〈delay 𝑀 𝜌〉</code></td><td style="text-align: left"><code>𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">21</td><td style="text-align: left"><code>(force _)⋅𝑠 ⊲ 〈builtin 𝑏 𝑉* (𝜄⋅𝜂)〉</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈builtin 𝑏 𝑉* 𝜂〉</code></td><td style="text-align: left"><code>𝜄</code> is a type argument</td></tr>
<tr><td style="text-align: center">22</td><td style="text-align: left"><code>(force _)⋅𝑠 ⊲ 〈builtin 𝑏 𝑉* [𝜄]〉</code></td><td style="text-align: left"><code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪 (𝑠, 𝑏, 𝑉*)</code></td><td style="text-align: left"><code>𝜄</code> is a type argument</td></tr>
<tr><td style="text-align: center">23</td><td style="text-align: left"><code>(constr 𝑖 𝑉* _ (𝑀⋅𝑀*, 𝜌))⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>(constr 𝑖 𝑉*⋅𝑉 _ (𝑀*, 𝜌))⋅𝑠; 𝜌 ⊳ 𝑀</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">24</td><td style="text-align: left"><code>(constr 𝑖 𝑉 _ ([], 𝜌))⋅𝑠 ⊲ 𝑉</code></td><td style="text-align: left"><code>𝑠 ⊲ 〈constr 𝑖 𝑉*⋅𝑉 〉</code></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center">25</td><td style="text-align: left"><code>(case _ (𝑀₀ … 𝑀ₙ , 𝜌))⋅𝑠 ⊲ 〈constr 𝑖 𝑉₁ … 𝑉ₘ〉</code></td><td style="text-align: left"><code>[_ 𝑉ₘ]⋅⋯⋅[_ 𝑉₁]⋅𝑠; 𝜌 ⊳ 𝑀𝑖</code></td><td style="text-align: left"><code>0 ≤ 𝑖 ≤ 𝑛</code></td></tr>
</tbody></table>
</div>
<p>In this table, <code>X*</code> denotes a list of <code>X</code>s.
The symbol <code>⋅</code> denotes either the cons or snoc operator on lists.</p>
<p>Explanation of the transition rules:</p>
<ol>
<li>To evaluate a single variable <code>𝑥</code>, it looks up its value in the environment <code>𝜌</code>, and returns the value if exists.</li>
<li>A constant evaluates to itself, as it is already a value.</li>
<li>A lambda abstraction evaluates to itself, as it is already a value.
The environment is captured in the returned value, for later use in computing <code>𝑀</code>.</li>
<li>A delayed computation evaluates to itself, as it is already a value.
The environment is captured in the returned value, for later use in computing <code>𝑀</code>.</li>
<li>To evaluate <code>(force 𝑀)</code>, it pushes a frame <code>(force _)</code> onto the stack, and evaluates <code>𝑀</code>.
After <code>𝑀</code> is evaluated to a value, the forcing will continue (rules 20, 21 and 22) depending on what the value is.</li>
<li>To evaluate an application <code>[𝑀 𝑁]</code>, the machine first evaluates the function <code>𝑀</code>, after pushing frame <code>[_ (𝑁, 𝜌)]</code> onto the stack.
This ensures that once <code>𝑀</code> is evaluated, it will proceed to evaluate the argument <code>𝑁</code> using the same environment.</li>
<li>To evaluate a constructor application, the machine pushes a frame onto the stack with a hole in place of the first argument.
The frame also stores the remaining arguments along with the current environment.
It then proceeds to evaluate the first argument <code>𝑀</code>.</li>
<li>A nullary constructor evaluates to itself, as it is already a value.</li>
<li>To evaluate a <code>case</code> expression, the machine pushes a frame onto the stack with a hole in place of the scrutinee.
The frame also stores the branches, <code>𝑀*</code>, along with the current environment.
It then proceeds to evaluate the scrutinee <code>𝑁</code>.</li>
<li>A builtin function evaluates to itself as it is already a value.</li>
<li>Evaluating <code>(error)</code> results in the machine terminating with a failure.</li>
<li>When a value <code>𝑉</code> is returned to an empty stack, the machine terminates with success, yielding <code>𝑉</code> as final result.</li>
<li>When a value <code>𝑉</code> is returned to a stack whose top frame represents an application with the hole in the function position, the frame is replaced with one where the function is <code>𝑉</code> and the hole is in the argument position.
The machine then continues by evaluating the argument <code>𝑀</code> in the captured environment.</li>
<li>When a value <code>𝑉</code> is returned to a stack whose top frame represents an application, where the hole is in the argument position and the function is a lambda abstraction, the machine pops the frame, extends the environment to bind <code>𝑥</code> to <code>𝑉</code>, and continues by evaluating <code>𝑀</code>.
This corresponds to beta reduction.</li>
<li>If the returned value is a lambda abstraction, and the top stack frame represents an application, where the hole is in the function position and the argument is a value, the machine proceeds in the same way as the previous rule.</li>
<li>When a value <code>𝑉</code> is returned to a stack whose top frame represents an application where the hole is in the argument position, and the function is a builtin expecting at least two more arguments (since <code>𝜂</code> is a non-empty list, <code>𝜄⋅𝜂</code> contains at least two elements) and the first is a term argument, the machine pops the frame, and returns an updated <code>builtin</code> value.
Because the builtin still requires at least one more argument, the builtin application cannot yet be evaluated and is therefore considered a value.</li>
<li>If the returned value is a builtin application expecting at least two arguments, where the first is a term argument, and the top stack frame represents an application, where the hole is in the function position and the argument is a value, the machine proceeds in the same way as the previous rule.</li>
<li>Like Rule 16, except that the builtin expects exactly one more argument, and it is term argument.
In this case the builtin application is now saturated, so it is evaluated via <code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪</code>.
The mechanism of <code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪</code> is described later.</li>
<li>Like Rule 17, except that the builtin expects exactly one more argument, and it is term argument.
The machine proceeds in the same way as the previous rule.</li>
<li>If the returned value is a delayed computation, and the top stack frame is a <code>force</code> frame, then the <code>force</code> and <code>delay</code> cancel each other, and the machine continues by evaluating the <code>𝑀</code> in the captured environment.</li>
<li>If the returned value is a builtin application expecting at least two arguments, where the first is a type argument, and the top stack frame is a <code>force</code> frame, the machine pops the frame, and returns an updated builtin application value, with the first argument removed.
In Plutus, forcing corresponds to applying a type argument.
A builtin application expecting a type argument must be forced before evaluation can continue.</li>
<li>Like Rule 21, except that the builtin excepts exactly one more argument, and it is type argument.
In this case the <code>force</code> makes the builtin application saturated, so it is evaluated via <code>𝖤𝗏𝖺𝗅𝖢𝖤𝖪</code>.</li>
<li>When a value <code>𝑉</code> is returned to a stack whose top frame is a constructor application, with the hole in any argument position except the last (in other words, there is at least one more argument to be evaluated), the machine replaces the frame with one where the hole is moved to the next argument, and proceeds to evaluate the next argument <code>𝑀</code> in the captured environment.</li>
<li>Like Rule 23, except that the hole is in the position of the last argument.
In this case, all arguments have been evaluated, so the machine pops the frame and returns a <code>constr</code> value.</li>
<li>If the returned value is a constructor application with index <code>𝑖</code>, and the top stack frame is a <code>case</code> frame, the machine will evaluate the <code>𝑖</code>th branch - <code>𝑀𝑖</code> - applied to arguments <code>𝑉ₘ … 𝑉₁</code> (it is important to note that arguments under <code>constr</code> are reversed when passing to a <code>case</code> branch - this is done for performance reasons).
To do so, it pops the frame, and pushes <code>m</code> frames, each representing an application, with the top frame corresponding to <code>𝑉ₘ</code> (the first argument).</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="serialization"><a class="header" href="#serialization">Serialization</a></h1>
<h2 id="serializing-data-objects-using-the-cbor-format"><a class="header" href="#serializing-data-objects-using-the-cbor-format">Serializing Data Objects Using the CBOR Format</a></h2>
<p><code>Data</code> is a Plutus Core built-in type.
It is used for on-chain data interchange, such as arguments to Plutus validators.
The following is the Haskell definition of <code>Data</code>:</p>
<pre><code class="language-haskell">data Data =
  Constr Integer [Data]
  | Map [(Data, Data)]
  | List [Data]
  | I Integer
  | B ByteString
</code></pre>
<p>Because blockchains store and transmit data in binary format, a <code>Data</code> object must be serialized into bytes whenever it is included in a transaction, or stored in a UTxO.
The serialization method must be deterministic, compact and stable.</p>
<p>Cardano uses CBOR extensively as a serialization format, so CBOR is also used for <code>Data</code> objects.
All Cardano node implementations must agree on how <code>Data</code> objects are serialized.
The serialization method used by the Haskell node is described in the Plutus Core spec, Appendix B.</p>
<h2 id="serializing-plutus-scripts-using-the-flat-format"><a class="header" href="#serializing-plutus-scripts-using-the-flat-format">Serializing Plutus Scripts Using the Flat Format</a></h2>
<p>Plutus scripts must also be serialized into a binary format so that they can be stored, transmitted and hashed.</p>
<p>Plutus scripts are serialized using the <code>flat</code> format.
<code>flat</code> is much more compact and faster than CBOR for serializing programs due to avoiding unnecessary metadata, resulting in a smaller script size and faster serialization - important for on-chain storage and transaction fees.</p>
<p>The <code>flat</code>-serialized script is then serialized into CBOR, based on which script hashes are calculated.</p>
<p>All Cardano node implementations must agree on how Plutus scripts are serialized.
The serialization method used by the Haskell node is described in the Plutus Core script, Appendix C.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="client-interfaces"><a class="header" href="#client-interfaces">Client interfaces</a></h1>
<p>Node implementations may offer interfaces to clients for submitting new data to
the network (transactions) as well as query data from the node. The spectrum of
protocols that could serve this purpose is open and the choice is free for each
implementation. Here we aggregate some interfaces that have been implemented for
enabling this interaction:</p>
<ul>
<li>the <a href="client/./node-to-client/">Node-To-Client (NTC)</a> interface as introduced by <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a>, which is very similar to the Node-To-Node (NTN) <a href="client/../network">network</a> protocols,</li>
<li>the <a href="client/utxo-rpc/README.html">UTxO RPC</a> interface as a standard interface shared
with other UTxO-based blockchains.</li>
</ul>
<p>Below we present a table with clients and servers that implement each protocol:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Server</th><th>NTC</th><th>UTxO RPC</th></tr></thead><tbody>
<tr><td style="text-align: left"><a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a></td><td>✅</td><td>❔</td></tr>
<tr><td style="text-align: left"><a href="https://github.com/blinklabs-io/dingo">dingo</a></td><td>✅</td><td>✅</td></tr>
<tr><td style="text-align: left"><a href="https://github.com/pragma-org/amaru/">amaru</a></td><td>❔</td><td>❔</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Client</th><th>NTC</th><th>UTxO RPC</th></tr></thead><tbody>
<tr><td style="text-align: left"><a href="https://github.com/IntersectMBO/cardano-cli">cardano-cli</a></td><td>✅</td><td>⬜</td></tr>
<tr><td style="text-align: left"><a href="https://github.com/txpipe/pallas">pallas</a></td><td>✅</td><td>❔</td></tr>
<tr><td style="text-align: left"><a href="https://github.com/blinklabs-io/gouroboros">gouroboros</a></td><td>✅</td><td>❔</td></tr>
</tbody></table>
</div><div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Please help us keep this list up-to-date by <a href="https://github.com/cardano-scaling/cardano-blueprint/edit/main/src/client/README.md">suggesting an edit</a>.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="node-to-client-ntc"><a class="header" href="#node-to-client-ntc">Node-To-Client (NTC)</a></h1>
<p><code>cardano-node</code> implements a set of mini-protocols that follow rules very similar
to those in the Node-To-Node interface, except that they communicate through a
named pipe. As these protocols establish connections to local clients there is
trust between peers and consequently they behave more like traditional
client/server APIs.</p>
<p>In particular, these mini-protocols will also be wrapped by a
<a href="client/node-to-client/../../network/multiplexing.html">multiplexer</a>.</p>
<p>These mini-protocols are:</p>
<ul>
<li><a href="client/node-to-client/">Handshake</a>: to negotiate the versions used in the connection,</li>
<li><a href="client/node-to-client/">LocalTxSubmission</a>: to submit transactions to the network,</li>
<li><a href="client/node-to-client/state-query">LocalStateQuery</a>: to query for information about the ledger state,</li>
<li><a href="client/node-to-client/">TxMonitor</a>: to monitor the status of transactions,</li>
<li><a href="client/node-to-client/">LocalChainSync</a>: to retrieve chains of blocks from the node.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="localstatequery"><a class="header" href="#localstatequery">LocalStateQuery</a></h1>
<blockquote>
<p>Protocol version: V19</p>
</blockquote>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Explain how to use and relate state diagram to full protocol in <a href="client/node-to-client/state-query/../../../network">network</a> chapter?</p>
</div>
<details>
  <summary> Full mini-protocol state diagram</summary>
<pre class="mermaid">stateDiagram
    direction LR
    [*] --&gt; StIdle
    StIdle --&gt; [*]: MsgDone
    StIdle --&gt; Acquiring: MsgAcquire
    Acquiring --&gt; Acquired: MsgAcquired
    Acquired --&gt; Querying: MsgQuery
    Querying --&gt; Acquired: MsgResult
    Acquired --&gt; Acquiring: MsgReAcquire
    Acquiring --&gt; StIdle: MsgFailure
    Acquired --&gt; StIdle: MsgRelease
</pre>
<p>See also definition in <a href="https://ouroboros-network.cardano.intersectmbo.org/pdfs/network-spec/network-spec.pdf#section.3.13">network spec</a>.</p>
</details>
<p>Client-side view on the protocol<sup class="footnote-reference" id="fr-1-1"><a href="#footnote-1">1</a></sup>:</p>
<pre><code>                      ●
                      │
                      ▼
              ┌───────────────┐ MsgDone
       ╭─────▶│     Idle      ├────────▶ ○
       │      └───────┬───────┘
       │   MsgAcquire │
       │              ▼  ╭────────╮
       │      ┌──────────┴────┐   │ MsgReAcquire
       ╰──────┤   Acquired    │◀──╯
  MsgRelease  └───┬───────────┘
                  │       ▲
                  ╰───────╯
                   MsgQuery
</code></pre>
<details>
  <summary>Broken mermaid rendering</summary>
<pre class="mermaid">stateDiagram
    direction LR
    [*] --&gt; StIdle
    StIdle --&gt; Acquired: MsgAcquire
    Acquired --&gt; Acquired: MsgQuery, MsgReAcquire, MsgFailure
    StIdle --&gt; StIdle: MsgFailure
    Acquired --&gt; StIdle: MsgRelease
    StIdle --&gt; [*]: MsgDone
</pre>
</details>
<h2 id="acquire-a-state"><a class="header" href="#acquire-a-state">Acquire a state</a></h2>
<p>To use the ledger state query API, a client needs to first specify at which point on the chain the query should be executed. Depending on the server implementation, this point may only be within the “volatile” recent part of the chain. A typical practice is to acquire the tip of the chain, perform one or more queries and close the connection again.</p>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: show how to acquire a point with an example CBOR message</p>
</div>
<h2 id="queries"><a class="header" href="#queries">Queries</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Explain distinction between consensus and block queries here</p>
</div>
<h3 id="getsystemstart"><a class="header" href="#getsystemstart">getSystemStart</a></h3>
<p><em>Since: v9</em></p>
<p>Query the chain’s start time as a <code>UTCTime</code>.</p>
<pre><code class="language-cddl">msgQuery     = [3, query]
msgResult    = [4, result]
</code></pre>
<pre><code class="language-cddl">query = 1
result = [year, dayOfYear, timeOfDayPico]
year = bigint
dayOfYear = int
timeOfDayPico = bigint
</code></pre>
<p>Example query:</p>
<pre><code class="language-cbor">82038101
</code></pre>
<p>Example response:</p>
<pre><code class="language-cbor">820483c2581e65fea62360470c59141d0ba6cc897f99e050184606937264a1f8c5026abc3b3a5d754770442481c3581e50670ee65e805e3cc5aadf6619e791db8b1c2237dd918ba3b6818e7c258a
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>FIXME: While I experimented in using the network / consensus cddl parts above, <code>time</code> would be defined in the CDDL prelude (a number, assuming seconds since epoch), but is actually incorrect and the result is serialized using <code>ToCBOR UTCTime</code> following this cddl:</p>
<pre><code class="language-cddl">time = [year, dayOfYear, timeOfDayPico]
year = bigint
dayOfYear = int
timeOfDayPico = bigint
</code></pre>
</div>
<h3 id="getcurrentpparams"><a class="header" href="#getcurrentpparams">getCurrentPParams</a></h3>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>TODO: Era-specific query with an involved answer</p>
</div>
<hr>
<ol class="footnote-definition"><li id="footnote-1">
<p>Derived from <a href="https://ogmios.dev/mini-protocols/local-state-query/">ogmios</a>’ great ascii art description. <a href="#fr-1-1">↩</a></p>
</li>
</ol><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="utxo-rpc"><a class="header" href="#utxo-rpc">UTxO-RPC</a></h1>
<p>A gRPC interface for UTxO Blockchains that is implemented by a few Cardano components.</p>
<p>See the official website <a href="https://utxorpc.org/">utxorpc.org</a> for a full introduction and documentation.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="codec-basics"><a class="header" href="#codec-basics">Codec basics</a></h1>
<p>Common encoding format and binary interface description used across blueprints.</p>
<h2 id="cbor"><a class="header" href="#cbor">CBOR</a></h2>
<p>TODO: justify the use of CBOR and briefly describe it. Mention <code>cbor2diag.rb</code>
and related tools. (I believe it is the <code>cbor-tools</code> Ruby gem).</p>
<h2 id="cddl-1"><a class="header" href="#cddl-1">CDDL</a></h2>
<p>CDDLs are often times the combination of partial CDDLs definitions
from Network, Consensus and Ledger layers. To combine all these, we
will make use of the <code>cddlc</code> tool specified in <a href="https://datatracker.ietf.org/doc/draft-ietf-cbor-cddl-modules/">this
RFC</a>. This
tool provide meaning to the <code>;# import</code> and <code>;# include</code> directives to
have a modular system over CDDL definitions.</p>
<p>The CDDL specs presented in this section will make use of the
following base definitions that we will consider defined globally:</p>
<pre><code class="language-cddl">blockNo = word64
epochNo = word64
slotNo = word64

coin = word64

rational = [int, int]

keyhash = bstr .size 28
hash = bstr .size 32

relativeTime = int

; Words
word8  = uint .size 1; 1 byte
word16 = uint .size 2; 2 bytes
word32 = uint .size 4; 4 bytes
word64 = uint .size 8; 8 bytes
</code></pre>
<p>In addition, we add the following types to represent tag-encoded
alternatives, commonly used at the consensus level to encode a
different tag for each one of the eras in the Cardano blockchain:</p>
<pre><code class="language-cddl">telescope7&lt;byron, shelley, allegra, mary, alonzo, babbage, conway&gt;
  = [pastEra, pastEra, pastEra, pastEra, pastEra, pastEra, currentEra&lt;conway&gt;] /
    [pastEra, pastEra, pastEra, pastEra, pastEra, currentEra&lt;babbage&gt;] /
    [pastEra, pastEra, pastEra, pastEra, currentEra&lt;alonzo&gt;] /
    [pastEra, pastEra, pastEra, currentEra&lt;mary&gt;] /
    [pastEra, pastEra, currentEra&lt;allegra&gt;] /
    [pastEra, currentEra&lt;shelley&gt;] /
    [currentEra&lt;byron&gt;]

ns7&lt;byron, shelley, allegra, mary, alonzo, babbage, conway&gt;
  = [6, conway] /
    [5, babbage] /
    [4, alonzo] /
    [3, mary] /
    [2, allegra] /
    [1, shelley] /
    [0, byron]
</code></pre>
<p>These definitions are made available in the
<a href="codecs/base.cddl"><code>base.cddl</code></a>
file which we will import qualified with <code>;# import base as base</code>.</p>
<p>On the other side, Ledger CDDL specs are fully self-contained for each
era, hence there are repetitions of basic types, which we will bring
in qualified by the era name. We will usually import the Ledger CDDLs as:</p>
<pre><code class="language-cddl">;# include byron as byron
;# include shelley as shelley
;# include allegra as allegra
;# include mary as mary
;# include alonzo as alonzo
;# include babbage as babbage
;# include conway as conway
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="styleguide"><a class="header" href="#styleguide">Styleguide</a></h1>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Expand this as needed with examples, tips, glossary and general language used. Try not to replicate upstream docs, e.g. for mermaid or math markup.</p>
</div>
<h2 id="overall-style"><a class="header" href="#overall-style">Overall style</a></h2>
<p><strong>The blueprints should be well written.</strong>
It might seem this should go without saying, but it’s put here to
emphasise its importance.
Poorly written documentation can confuse readers rather than clarify, and the more of it exists, the more damage it can cause.</p>
<p>Recognize that our goal is to make Cardano the most well-documented blockchain, rather than the most heavily-documented blockchain.</p>
<p>When writing you should always be keeping
the reader in mind, thinking what is the best way to pass on the
knowledge you have given the current state of knowledge they have.
This is a hard thing to do, but it is worth aiming for!</p>
<p>People take in information in different ways.  Some like literate
prose, many like visual diagrams and pseudo-code, and a few like
mathematical formulae.  If you can do all of these, so much the
better, but good diagrams are often the place to start.</p>
<p>As a general rule, approach it with the same level of care and thoughtfulness as you would when writing a peer-reviewed paper for a top-tier conference or journal that you are eager to publish.
More specifically, here are a few general tips.</p>
<h3 id="do-not-reference-a-non-obvious-term-without-defining-it"><a class="header" href="#do-not-reference-a-non-obvious-term-without-defining-it">Do not reference a non-obvious term without defining it</a></h3>
<p>Avoid explaining what X is by saying “X allows us to do Y” without defining Y.
This only adds to the confusion: not only will the reader not understand X, but now Y as well.
Also avoid circular definitions.</p>
<p>Instead of scattering definitions throughout the documentation, consider keeping them in one place by creating a glossary page.</p>
<h3 id="use-consistent-terminology"><a class="header" href="#use-consistent-terminology">Use consistent terminology</a></h3>
<p>Sometimes people use different names for the same thing.
Examples include “constitution script” vs. “guardrail script”, “Plutus version” vs. “Plutus ledger language”, “minting script” vs. “minting policy”.</p>
<p>Using consistent terminology is important for clarity. In some cases, using multiple terms interchangeably can be beneficial, but this should be clearly stated, such as in the glossary page. To further enhance consistency, consider creating a single, unified glossary page for the entire Cardano blueprint.</p>
<h3 id="discuss-related-work-and-alternative-approaches"><a class="header" href="#discuss-related-work-and-alternative-approaches">Discuss related work and alternative approaches</a></h3>
<p>Many documents focus on describing how things are done in a particular system, but they often leave the readers wondering why certain design decisions were made over other design choices.</p>
<p>Just like a research paper, related work and alternative approaches should be discussed, especially in the following cases:</p>
<ul>
<li>there is a comparable system that does things differently</li>
<li>a reasonable alternative approach exists, but it wasn’t chosen due to certain disadvantages</li>
<li>we previously adopted an alternative approach but later switched to the current one for specific reasons</li>
</ul>
<p>In the last case, it is also important to document the time and/or the package version that switched to the new approach.</p>
<h3 id="machine-checking-for-code-snippets-is-strongly-recommended"><a class="header" href="#machine-checking-for-code-snippets-is-strongly-recommended">Machine checking for code snippets is strongly recommended</a></h3>
<p>The benefits of doing so are obvious.
It helps ensure the code is up to date, and allows users to access the full working code if they want to explore further.</p>
<h3 id="make-individual-documents-self-contained-and-avoid-excessive-linking"><a class="header" href="#make-individual-documents-self-contained-and-avoid-excessive-linking">Make individual documents self-contained, and avoid excessive linking</a></h3>
<p>Excessive links in documentation can be irritating and distracting.
Before linking to another page, consider whether the concept can be briefly explained in one or two sentences, so that the reader does not need to go to and read that page.</p>
<p>Ideally, a reader should be able to go through a page of documentation from beginning to end without interruptions.
While links can sometimes be beneficial or even necessary, they can be placed in a “further reading” section at the end, rather than scattered throughout the text.</p>
<h3 id="back-up-your-claims"><a class="header" href="#back-up-your-claims">Back up your claims</a></h3>
<p>When saying “this function boosts performance significantly”, you should generally provide some data to back it up.
Again, treat it like a peer-reviewed paper - you know what would happen if you make such claims without evidence!</p>
<h3 id="use-plenty-of-examples-but-avoid-trivial-toy-examples-and-avoid-many-different-examples"><a class="header" href="#use-plenty-of-examples-but-avoid-trivial-toy-examples-and-avoid-many-different-examples">Use plenty of examples, but avoid trivial toy examples, and avoid many different examples</a></h3>
<p>Examples are very important, and more is almost always better than fewer.</p>
<p>However, avoid trivial toy examples in general, as they are often not effective in explaining core concepts.
Instead, use simple yet realistic examples.
For instance, when introducing smart contracts, an auction example is far more illustrative than a trivial “hello world” example.</p>
<p>Whenever possible, use running examples (that is, examples that are used in many places, if not throughout the entire document).
They are more illustrative and less distracting compared to introducing a new example in each instance.
For example, using an auction example to explain on-chain code, a vesting example to explain off-chain code, and an escrow example to explain transaction balancing is less effective than using any of these examples consistently.</p>
<p>It can be challenging to think of good running examples, but it’s worth it.
This is something you’d do if you are writing a peer reviewed paper you really want to publish, and you should strive to achieve the same standard.
It is worth coordinating on examples across teams, and strive for consistent examples in documentation written by different teams.</p>
<h3 id="maintain-changelog-and-versioning"><a class="header" href="#maintain-changelog-and-versioning">Maintain changelog and versioning</a></h3>
<p>It is sometimes useful to see how certain things were done in the past, and how they have evolved over time.
Thus documentation should be versioned and released like software packages, with old versions accessible and changelogs available.</p>
<h3 id="avoid-multiple-sources-of-truth"><a class="header" href="#avoid-multiple-sources-of-truth">Avoid multiple sources of truth</a></h3>
<p>Having multiple sources of truth makes documentation difficult to maintain. To mitigate this, generate documentation from the source of truth whenever possible - for example, deriving compiler flag documentation from code instead of writing it manually.</p>
<h3 id="add-a-summary-or-tldr-for-long-pages"><a class="header" href="#add-a-summary-or-tldr-for-long-pages">Add a summary or TLDR for long pages</a></h3>
<p>This can save readers time and lets them decide whether to dive into the details, or if the summary/TLDR is sufficient.</p>
<h3 id="other-tips"><a class="header" href="#other-tips">Other tips</a></h3>
<ul>
<li>Create one file per major topic</li>
<li>Divide text up into logical, hierarchical sections</li>
<li>Break up long paragraphs into bulleted lists</li>
<li>Use code blocks to give short examples</li>
<li>Use <code>backquote</code> to set off identifiers - e.g. message or state names</li>
</ul>
<h2 id="language"><a class="header" href="#language">Language</a></h2>
<p>Text should be written in American English, at the reading level of a
competent software developer - which is often very high, but bear in mind
that English may not be their first language.  Use technical language by all
means, but there is no need to be egregiously erudite in your elucidation.</p>
<p>It may not be necessary to talk about humans in much of this documentation,
but if you do, please use gender-neutral pronouns - ‘they’ and ‘their’:</p>
<blockquote>
<p>A user must keep the keys to their wallet safe.</p>
</blockquote>
<p>If you find this difficult, cast it into the plural:</p>
<blockquote>
<p>Users must keep the keys to their wallets safe.</p>
</blockquote>
<h3 id="normative-vs-declarative-style"><a class="header" href="#normative-vs-declarative-style">Normative vs declarative style</a></h3>
<p>Some standards documentation is very SHOUTY about MUST, SHALL and so on.
Even if it doesn’t SHOUT it can still be rather clumsy to read.  Instead,
we want to use a <em>declarative</em> style.  We can express what an implementation
has to do conform to the specification as a simple descriptive fact - e.g.</p>
<blockquote>
<p>The tester discards widgets with broken flibbits.</p>
</blockquote>
<p>rather than the ‘normative’</p>
<blockquote>
<p>The tester SHALL discard widgets with broken flibbits.</p>
</blockquote>
<p>So in this style there is an implicit ‘must’.  If something is optional, this
can be said explicitly:</p>
<blockquote>
<p>The package may use extra sproggles if required.</p>
</blockquote>
<p>It’s still OK to use ‘must’ to emphasise cases which are absolutely
critical, but still, please don’t SHOUT.</p>
<h2 id="diagrams--maths"><a class="header" href="#diagrams--maths">Diagrams &amp; Maths</a></h2>
<p>We can use <a href="https://mermaid.js.org">mermaid</a> diagrams (<a href="https://mermaid.live">live editor</a>):</p>
<pre class="mermaid">graph LR;
    A--&gt;B--&gt;D;
    A--&gt;C;
</pre>
<p>and maths using <a href="https://katex.org/docs/supported.html">katex</a>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.09931em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">Φ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="alerts"><a class="header" href="#alerts">Alerts</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>We can use the github flavored callouts, documented <a href="https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax#alerts">here</a></p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>A friendly note in github.
How about code blocks?</p>
<pre><code>cargo install mdbook-alerts
</code></pre>
</div>
<h2 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h2>
<p>Additional information that would complicate the read-flow can be put into footnotes <sup class="footnote-reference" id="fr-example-1"><a href="#footnote-example">1</a></sup>.</p>
<h2 id="other-stuff"><a class="header" href="#other-stuff">Other stuff</a></h2>
<p>The footnote should appear below. If not, we need to contribute this to <code>mdbook</code>.</p>
<hr>
<ol class="footnote-definition"><li id="footnote-example">
<p>Example footnote <a href="#fr-example-1">↩</a></p>
</li>
</ol><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="contributing-to-cardano-blueprint"><a class="header" href="#contributing-to-cardano-blueprint">Contributing to Cardano Blueprint</a></h1>
<p>Thank you for considering contributing and sharing your knowledge about the Cardano protocol in one capacity or another.</p>
<p>There are basically two ways to contribute:</p>
<ul>
<li>Validate and provide feedback about existing blueprints</li>
<li>Create or update blueprints</li>
</ul>
<h2 id="validate-blueprints"><a class="header" href="#validate-blueprints">Validate blueprints</a></h2>
<p>As you might have seen, the <a href="https://cardano-scaling.github.io/cardano-blueprint/#goal">goal</a> of <code>cardano-blueprint</code> is to create accessible assets that are <em>understandable</em> and <em>useful</em> to wide variety of builders from the Cardano community.</p>
<h3 id="ask-questions"><a class="header" href="#ask-questions">Ask questions</a></h3>
<p>A great way to make sure we cover relevant areas of the Cardano protocol first, is to understand what <em>you</em> are trying to build or understand <em>right now</em>.</p>
<p>We use <a href="https://github.com/cardano-scaling/cardano-blueprint/discussions/new?category=q-a">Q&amp;A discussions</a> to gather immediate questions and use them to identify gaps for where blueprints can help most.</p>
<p>While discussions and providing answers in the <a href="https://github.com/cardano-scaling/cardano-blueprint/discussions/categories/q-a">Q&amp;A forum</a> are obviously welcome, ideally we would be <a href="CONTRIBUTING.html#write-blueprints">writing blueprints</a> and be able to answer by pointing future readers there.</p>
<h3 id="share-feedback-and-ideas"><a class="header" href="#share-feedback-and-ideas">Share feedback and ideas</a></h3>
<p>If you happen to find the information provided through blueprints <em>useful</em> to your current project, or if you are confused about the <em>why</em> of blueprints, the <a href="https://github.com/cardano-scaling/cardano-blueprint/discussions/categories/general">general category</a> is the right place for that.</p>
<p>Or maybe you have an idea on how we could reach our <a href="https://cardano-scaling.github.io/cardano-blueprint/#goal">goals</a> by changing one or the other process? Ideas are collected in the <a href="https://github.com/cardano-scaling/cardano-blueprint/discussions/categories/ideas">ideas category</a>.</p>
<p>We would love to hear about any feedback! 💙</p>
<h3 id="report-issues"><a class="header" href="#report-issues">Report issues</a></h3>
<p><a href="https://github.com/cardano-scaling/cardano-blueprint/issues/new">Submit an issue</a> if you spot an errors, or should you encounter a problem with using or contributing to the blueprints themselves.</p>
<h2 id="write-blueprints"><a class="header" href="#write-blueprints">Write blueprints</a></h2>
<p>Creating or updating blueprints is the bread &amp; butter of this project and anyone is invited to do just that!</p>
<p>The bandwidth of possible contributions is very broad and can range from fixing typos via the <code>Suggest an edit</code> <i class="fa fa-edit"></i> button on the <a href="https://cardano-scaling.github.io/cardano-blueprint">rendered website</a>, over contributing a whole set of documents about how consensus works in Cardano, to including a conformance test suite.</p>
<p>In fact, it’s not even set in stone <a href="https://cardano-scaling.github.io/cardano-blueprint/#what-is-a-blueprint">what a blueprint is</a>, and we are gladly exploring any asset that you think covers our values and contributes to reaching the goal of the Cardano Blueprint initiative.</p>
<h3 id="creating-a-pull-request"><a class="header" href="#creating-a-pull-request">Creating a pull request</a></h3>
<p>Thank you for contributing your changes by opening a pull request!</p>
<p>We do appreciate it if your pull request meets the following criteria:</p>
<ul>
<li><strong>Description of the changes</strong>: providing a clear summary of the changes is beneficial</li>
<li><strong>Quality of changes</strong>: ensure that new or updated automated tests validate your changes</li>
<li><strong>Scope</strong>: we prefer multiple pull requests that are well-scoped rather than a single large one</li>
<li><strong>Correctness</strong>: the pull request should pass the continuous integration (CI) pipeline.</li>
</ul>
<p>The project is currently in an expand-and-gather phase with no requirement of approvals, but consider requesting for reviews on Github-suggested reviewers.</p>
<p>Anyone is free to fork the repository and we consider pull requests from forks.</p>
<p>The project is currently situated in the <code>cardano-scaling</code> organization, to which we happily invite you and give write permissions onto this repository - so you can pull request from branches directly.</p>
<h3 id="review-contributions"><a class="header" href="#review-contributions">Review contributions</a></h3>
<p>The Cardano Blueprint aims to be a community effort and we would love to have you become a regular visitor and maybe even reviewer of new contributions! 🤝</p>
<h2 id="publishing"><a class="header" href="#publishing">Publishing</a></h2>
<p>Any changes to the <code>main</code> branch are automatically published to the live version of the blueprints hosted <a href="https://cardano-scaling.github.io/cardano-blueprint/">via Github Pages</a>. If you have made changes and they are not propagated to the live version, please check the build status on <a href="https://github.com/cardano-scaling/cardano-blueprint/actions">GitHub Actions</a>, or make sure you fully reload the webpage (Ctrl+Shift+R on firefox).</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>The Cardano Blueprint is currently <em>not</em> versioned, tagged or released.</p>
<p>We are prepared to put such process in place as we see demand from implementations relying on a specific version of test data, interface descriptions or similar contained in <code>cardano-blueprint</code>.</p>
<h2 id="communication"><a class="header" href="#communication">Communication</a></h2>
<p>Besides the many ways to engage through issues and discussions, we also use text and video channels on the <a href="https://discord.gg/47YkBFaTtT">Cardano Scaling Discord server</a> for informal chats.</p>
<p>There is a weekly <a href="https://discord.gg/xvmdpdsM?event=1346780137806626816">office hours event</a> to which anyone is welcome and we are looking forward to see you there!</p>
<p>Last but not least and probably the best way to contribute: Share the love for blueprints! 📘📐💙</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<p>Logbook about <code>cardano-blueprint</code> that contains thinking, discussions, pains, joys, events, and experiences that happen on a daily basis. It is supposed to be a kind of <a href="https://en.wikipedia.org/wiki/Stream_of_consciousness">Stream of consciousness</a> that can later be searched, linked to or reviewed. It may also be used as a very informal decision log.</p>
<h2 id="2025-03-25"><a class="header" href="#2025-03-25">2025-03-25</a></h2>
<p>By @ch1bo</p>
<ul>
<li>Met with Pi, Matthias and Josh to discuss ledger test approaches and how they relate to cardano blueprint</li>
<li>Ethan, someone from SundaeLabs, would be free soon and could spend some time putting together a conformance test suite</li>
<li>Most relevant issue: https://github.com/IntersectMBO/cardano-ledger/issues/4892</li>
<li>On ledger state
<ul>
<li>While we wait for Ethan I briefly mentioned that the ledger state snapshots might get a CDDL definition soon, at least the consensus team is asking it from the ledger team here: https://github.com/IntersectMBO/cardano-ledger/issues/4948</li>
<li>We briefly discussed what format of ledger state would be suitable for the test suite (JSON or CBOR), but it should not matter too much.</li>
<li>Transactions / blocks should quite naturally be CBOR encoded.</li>
</ul>
</li>
<li>The Haskell implementation of ledger (<code>cardano-ledger</code>) is conformance tested against the Agda model
<ul>
<li>According to Andre not exactly THE agda model that is also checked for correctness (is it?), but an equivalence checked derivation of the agda model that aligns better with the implementation state-wise</li>
<li>These conformance tests can be found <a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/libs/cardano-ledger-conformance/test/Test/Cardano/Ledger/Conformance/Spec/Conway.hs#L35">here</a></li>
</ul>
</li>
<li>Matthias mentions that there were quite a few uncaught bugs for Conway (used to be better?)
<ul>
<li>While its nice to have generated test scenarios and that conformance test suite, we should not rely <em>only</em> on it</li>
</ul>
</li>
<li>There are also hand-crafted test cases in the <code>cardano-ledger</code> implementation
<ul>
<li>For example for <a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/eras/conway/impl/testlib/Test/Cardano/Ledger/Conway/Imp.hs#L93">these</a></li>
<li>Especially tests for the top-level <code>BBODY</code> or <code>LEDGERS</code> (also <code>UTXOS</code> or <code>UTXOW</code>) rules are interesting as they operate on a block or transaction level (the so-called “signal” to the rule is a block or transaction)</li>
</ul>
</li>
<li>Where to start?
<ul>
<li>Test vectors have proven to be useful in the past: for <a href="https://github.com/IntersectMBO/plutus/tree/master/plutus-conformance">plutus</a> and <a href="https://github.com/aiken-lang/aiken/tree/main/examples/acceptance_tests/script_context/v3">aiken</a></li>
<li>Needs to be usable by multiple implementations / languages - not require to integrate with Haskell to <em>use</em></li>
<li>Instead of creating a tool right away, try to assemble a few good test vectors that can directly be used by <code>amaru</code> and other implementations</li>
<li>We suspect the hand-written test scenarios (<a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/eras/alonzo/impl/testlib/Test/Cardano/Ledger/Alonzo/Imp/UtxowSpec/Valid.hs#L131">example</a>) provide a “better signal to noise ratio” than the <a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/libs/cardano-ledger-conformance/src/Test/Cardano/Ledger/Conformance/ExecSpecRule/Core.hs#L424-L443">conformance test suite generators</a></li>
<li>We should piggy-back on the <code>cardano-ledger</code> test scenarios and dump test vectors when running them (e.g. in a patched version on a fork)</li>
<li>Test vectors should consist of
<ul>
<li>starting ledger state</li>
<li>one or more transactions (or blocks?)</li>
<li>expected resulting ledger state <strong>or</strong> expected validation error</li>
</ul>
</li>
<li>Can we use one ledger state multiple times (to have less test data)?</li>
</ul>
</li>
<li>We also discussed whether we should depend on how validation failed
<ul>
<li>Exact match is likely out of scope, but maybe a common “slug” or “code” across implementations?</li>
<li>Some disagreement that there is a need to identify “failing for the right reason”</li>
</ul>
</li>
</ul>
<h2 id="2025-03-20"><a class="header" href="#2025-03-20">2025-03-20</a></h2>
<p>By @ch1bo</p>
<ul>
<li>Started to make the logbook public with a few notes I had lying around.</li>
</ul>
<h2 id="2025-03-19"><a class="header" href="#2025-03-19">2025-03-19</a></h2>
<p>By @ch1bo</p>
<ul>
<li>Javier shared with me some interesting data from this article on <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/client-diversity/">Node diversity on Ethereum</a></li>
<li>Also <a href="https://clientdiversity.org/">https://clientdiversity.org/</a> contains most recent data on distribution of implementations!</li>
</ul>
<h2 id="2025-03-10"><a class="header" href="#2025-03-10">2025-03-10</a></h2>
<p>By @ch1bo</p>
<ul>
<li>Looking into <a href="https://github.com/input-output-hk/cuddle">cuddle</a>: The huddle tutorial looks engaging, but required a few markdown fixes</li>
<li>The project contains an <code>.envrc</code> to get tools set up.. but seemingly uses (a new to me) <code>organist</code> tool using <code>nickel</code> language to manage dependencies.</li>
<li>Compilation currently fails with:
<pre><code>src/Codec/CBOR/Cuddle/CBOR/Gen.hs:116:10: error: [GHC-18872]
    • Couldn't match type: System.Random.Internal.MutableGen f0 (M g)
                     with: CapGenM g
</code></pre>
</li>
<li>Main <code>README</code> lists support for suckets/plugs - what are these?</li>
<li>Socket/plug seems to be CDDL extension point: https://datatracker.ietf.org/doc/html/rfc8610#section-3.9</li>
<li>There is also <code>generics</code> feature, which seems even more powerful way to parameterize cddl rules</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<p>Multiple variants of the Cardano Blueprint logo and wordmark exist to be suitable for usable in varying contexts and for use on light/dark backgrounds.</p>
<p>Each variant is available as a scalable vector graphic (SVG) and can be serve as a source for potentially needed raster graphics. For example using <a href="https://inkscape.org/">inkscape</a>:</p>
<pre><code class="language-shell">inkscape -w 100 -h 100 logo.svg -o logo.png
</code></pre>
<p>The standard logo should work reasonably well on light and dark backgrounds:</p>
<p><img src="logo/./logo.svg" alt="" /></p>
<br/>
<p><img src="logo/./logo-wordmark.svg" alt="" /></p>
<p>These are optimized for light backgrounds:</p>
<p><img src="logo/./logo-light.svg" alt="" /></p>
<br/>
<p><img src="logo/./logo-wordmark-light.svg" alt="" /></p>
<p>These are optimized for dark backgrounds and monochrome:</p>
<p><img src="logo/./logo-dark.svg" alt="" /></p>
<br/>
<p><img src="logo/./logo-wordmark-dark.svg" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<pre><code>                             Apache License
                       Version 2.0, January 2004
                    http://www.apache.org/licenses/
</code></pre>
<p>TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION</p>
<ol>
<li>
<p>Definitions.</p>
<p>“License” shall mean the terms and conditions for use, reproduction,
and distribution as defined by Sections 1 through 9 of this document.</p>
<p>“Licensor” shall mean the copyright owner or entity authorized by
the copyright owner that is granting the License.</p>
<p>“Legal Entity” shall mean the union of the acting entity and all
other entities that control, are controlled by, or are under common
control with that entity. For the purposes of this definition,
“control” means (i) the power, direct or indirect, to cause the
direction or management of such entity, whether by contract or
otherwise, or (ii) ownership of fifty percent (50%) or more of the
outstanding shares, or (iii) beneficial ownership of such entity.</p>
<p>“You” (or “Your”) shall mean an individual or Legal Entity
exercising permissions granted by this License.</p>
<p>“Source” form shall mean the preferred form for making modifications,
including but not limited to software source code, documentation
source, and configuration files.</p>
<p>“Object” form shall mean any form resulting from mechanical
transformation or translation of a Source form, including but
not limited to compiled object code, generated documentation,
and conversions to other media types.</p>
<p>“Work” shall mean the work of authorship, whether in Source or
Object form, made available under the License, as indicated by a
copyright notice that is included in or attached to the work
(an example is provided in the Appendix below).</p>
<p>“Derivative Works” shall mean any work, whether in Source or Object
form, that is based on (or derived from) the Work and for which the
editorial revisions, annotations, elaborations, or other modifications
represent, as a whole, an original work of authorship. For the purposes
of this License, Derivative Works shall not include works that remain
separable from, or merely link (or bind by name) to the interfaces of,
the Work and Derivative Works thereof.</p>
<p>“Contribution” shall mean any work of authorship, including
the original version of the Work and any modifications or additions
to that Work or Derivative Works thereof, that is intentionally
submitted to Licensor for inclusion in the Work by the copyright owner
or by an individual or Legal Entity authorized to submit on behalf of
the copyright owner. For the purposes of this definition, “submitted”
means any form of electronic, verbal, or written communication sent
to the Licensor or its representatives, including but not limited to
communication on electronic mailing lists, source code control systems,
and issue tracking systems that are managed by, or on behalf of, the
Licensor for the purpose of discussing and improving the Work, but
excluding communication that is conspicuously marked or otherwise
designated in writing by the copyright owner as “Not a Contribution.”</p>
<p>“Contributor” shall mean Licensor and any individual or Legal Entity
on behalf of whom a Contribution has been received by Licensor and
subsequently incorporated within the Work.</p>
</li>
<li>
<p>Grant of Copyright License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
copyright license to reproduce, prepare Derivative Works of,
publicly display, publicly perform, sublicense, and distribute the
Work and such Derivative Works in Source or Object form.</p>
</li>
<li>
<p>Grant of Patent License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
(except as stated in this section) patent license to make, have made,
use, offer to sell, sell, import, and otherwise transfer the Work,
where such license applies only to those patent claims licensable
by such Contributor that are necessarily infringed by their
Contribution(s) alone or by combination of their Contribution(s)
with the Work to which such Contribution(s) was submitted. If You
institute patent litigation against any entity (including a
cross-claim or counterclaim in a lawsuit) alleging that the Work
or a Contribution incorporated within the Work constitutes direct
or contributory patent infringement, then any patent licenses
granted to You under this License for that Work shall terminate
as of the date such litigation is filed.</p>
</li>
<li>
<p>Redistribution. You may reproduce and distribute copies of the
Work or Derivative Works thereof in any medium, with or without
modifications, and in Source or Object form, provided that You
meet the following conditions:</p>
<p>(a) You must give any other recipients of the Work or
Derivative Works a copy of this License; and</p>
<p>(b) You must cause any modified files to carry prominent notices
stating that You changed the files; and</p>
<p>(c) You must retain, in the Source form of any Derivative Works
that You distribute, all copyright, patent, trademark, and
attribution notices from the Source form of the Work,
excluding those notices that do not pertain to any part of
the Derivative Works; and</p>
<p>(d) If the Work includes a “NOTICE” text file as part of its
distribution, then any Derivative Works that You distribute must
include a readable copy of the attribution notices contained
within such NOTICE file, excluding those notices that do not
pertain to any part of the Derivative Works, in at least one
of the following places: within a NOTICE text file distributed
as part of the Derivative Works; within the Source form or
documentation, if provided along with the Derivative Works; or,
within a display generated by the Derivative Works, if and
wherever such third-party notices normally appear. The contents
of the NOTICE file are for informational purposes only and
do not modify the License. You may add Your own attribution
notices within Derivative Works that You distribute, alongside
or as an addendum to the NOTICE text from the Work, provided
that such additional attribution notices cannot be construed
as modifying the License.</p>
<p>You may add Your own copyright statement to Your modifications and
may provide additional or different license terms and conditions
for use, reproduction, or distribution of Your modifications, or
for any such Derivative Works as a whole, provided Your use,
reproduction, and distribution of the Work otherwise complies with
the conditions stated in this License.</p>
</li>
<li>
<p>Submission of Contributions. Unless You explicitly state otherwise,
any Contribution intentionally submitted for inclusion in the Work
by You to the Licensor shall be under the terms and conditions of
this License, without any additional terms or conditions.
Notwithstanding the above, nothing herein shall supersede or modify
the terms of any separate license agreement you may have executed
with Licensor regarding such Contributions.</p>
</li>
<li>
<p>Trademarks. This License does not grant permission to use the trade
names, trademarks, service marks, or product names of the Licensor,
except as required for reasonable and customary use in describing the
origin of the Work and reproducing the content of the NOTICE file.</p>
</li>
<li>
<p>Disclaimer of Warranty. Unless required by applicable law or
agreed to in writing, Licensor provides the Work (and each
Contributor provides its Contributions) on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied, including, without limitation, any warranties or conditions
of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
PARTICULAR PURPOSE. You are solely responsible for determining the
appropriateness of using or redistributing the Work and assume any
risks associated with Your exercise of permissions under this License.</p>
</li>
<li>
<p>Limitation of Liability. In no event and under no legal theory,
whether in tort (including negligence), contract, or otherwise,
unless required by applicable law (such as deliberate and grossly
negligent acts) or agreed to in writing, shall any Contributor be
liable to You for damages, including any direct, indirect, special,
incidental, or consequential damages of any character arising as a
result of this License or out of the use or inability to use the
Work (including but not limited to damages for loss of goodwill,
work stoppage, computer failure or malfunction, or any and all
other commercial damages or losses), even if such Contributor
has been advised of the possibility of such damages.</p>
</li>
<li>
<p>Accepting Warranty or Additional Liability. While redistributing
the Work or Derivative Works thereof, You may choose to offer,
and charge a fee for, acceptance of support, warranty, indemnity,
or other liability obligations and/or rights consistent with this
License. However, in accepting such obligations, You may act only
on Your own behalf and on Your sole responsibility, not on behalf
of any other Contributor, and only if You agree to indemnify,
defend, and hold each Contributor harmless for any liability
incurred by, or claims asserted against, such Contributor by reason
of your accepting any such warranty or additional liability.</p>
</li>
</ol>
<p>END OF TERMS AND CONDITIONS</p>
<p>APPENDIX: How to apply the Apache License to your work.</p>
<pre><code>  To apply the Apache License to your work, attach the following
  boilerplate notice, with the fields enclosed by brackets "[]"
  replaced with your own identifying information. (Don't include
  the brackets!)  The text should be enclosed in the appropriate
  comment syntax for the file format. We also recommend that a
  file or class name and description of purpose be included on the
  same "printed page" as the copyright notice for easier
  identification within third-party archives.
</code></pre>
<p>Copyright 2025 Cardano Blueprint contributors</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>   http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src=".mdbook/mermaid.min.js"></script>
        <script src=".mdbook/mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
